<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>åŒèº«ä»½ç‹¼äººæ€ - ç”µå­æ³•å®˜ (ä¿®å¤ç‰ˆ)</title>

<style>
:root{--bg:#1a1a2e;--card:#16213e;--border:#0f3460;--accent:#e94560;--text:#eaeaea;--success:#00d9ff;--danger:#ff006e;--warning:#ffb700;--gradient:linear-gradient(135deg,#667eea 0%,#764ba2 100%);--shadow:0 10px 30px rgba(0,0,0,.3);--font-main:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:var(--font-main);line-height:1.6;min-height:100vh}
body{display:flex;justify-content:center;align-items:flex-start;padding:20px;background-image:radial-gradient(circle at 20% 50%,rgba(233,69,96,.1)0%,transparent 50%),radial-gradient(circle at 80% 80%,rgba(0,217,255,.1)0%,transparent 50%)}
#app{width:100%;max-width:900px;background:var(--card);border-radius:20px;padding:30px;box-shadow:var(--shadow);border:1px solid var(--border);animation:fadeIn .5s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
h1,h2,h3{color:var(--text);margin-bottom:20px;text-align:center;letter-spacing:1px}
h1{background:var(--gradient);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-size:2em;margin-bottom:30px}
h2{color:var(--success);font-size:1.5em;border-bottom:2px solid var(--border);padding-bottom:10px}
h3{color:var(--warning);font-size:1.2em}
hr{border:none;border-top:2px solid var(--border);margin:30px 0}
.hidden{display:none!important}
button{background:var(--accent);color:#fff;border:none;padding:12px 24px;border-radius:12px;cursor:pointer;font-size:16px;font-weight:600;margin:5px;transition:.3s all;position:relative;overflow:hidden}
button::before{content:'';position:absolute;top:50%;left:50%;width:0;height:0;background:rgba(255,255,255,.2);border-radius:50%;transform:translate(-50%,-50%);transition:width .6s,height .6s}
button:hover::before{width:300px;height:300px}
button:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 5px 20px rgba(233,69,96,.4)}
button:disabled{background:#4a4a4a;cursor:not-allowed;opacity:.6}
button.selected{background:var(--success)!important;box-shadow:0 5px 20px rgba(0,217,255,.4)}
button.control-btn{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)}
button.action-btn{background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%)}
button.confirm-btn{background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%)}
input[type=number],input[type=text]{width:80px;padding:10px;border-radius:10px;border:2px solid var(--border);background:rgba(255,255,255,.05);color:var(--text);font-size:16px;text-align:center;transition:.3s all}
input:focus{outline:none;border-color:var(--accent);background:rgba(255,255,255,.1)}
.role-setup-item{display:flex;justify-content:space-between;align-items:center;padding:15px;margin:10px 0;background:rgba(255,255,255,.03);border-radius:12px;transition:.3s all;border:1px solid transparent}
.role-setup-item:hover{background:rgba(255,255,255,.05);border-color:var(--border)}
.player-list-item{display:flex;justify-content:space-between;align-items:center;padding:15px 20px;margin:12px 0;background:rgba(255,255,255,.05);border-radius:15px;transition:.3s all;border:2px solid transparent}
.player-list-item:hover{border-color:var(--accent);transform:translateX(5px)}
.player-list-item.dead{opacity:.7;background:rgba(255,0,110,.1)}
.player-list-item.dead-all{opacity:.4;background:rgba(100,100,100,.1);text-decoration:line-through}
.life-heart{color:var(--danger);font-size:24px;transition:.3s all;text-shadow:0 0 10px rgba(255,0,110,.5)}
.life-heart.lost{color:#555;text-shadow:none}
.thief-copy{color:#888;font-style:italic;font-size:.9em}
.dead-identity{text-decoration:line-through;opacity:.6}
.action-panel,.action-feedback{margin-top:25px;padding:20px;background:rgba(255,255,255,.03);border-radius:15px;text-align:center;border:1px solid var(--border)}
.wolf-chat-box{padding:20px;background:rgba(233,69,96,.1);border-radius:15px;margin-top:20px;border:1px solid rgba(233,69,96,.3)}
#wolf-chat{height:180px;overflow-y:auto;border:1px solid var(--border);padding:15px;border-radius:10px;margin-bottom:15px;background:rgba(0,0,0,.3)}
#wolf-chat::-webkit-scrollbar{width:8px}
#wolf-chat::-webkit-scrollbar-track{background:rgba(255,255,255,.1);border-radius:10px}
#wolf-chat::-webkit-scrollbar-thumb{background:var(--accent);border-radius:10px}
#wolf-input{width:calc(100% - 100px);margin-right:10px;padding:12px;border-radius:10px;border:2px solid var(--border);background:rgba(255,255,255,.05);color:var(--text)}
.vote-msg{color:var(--warning);font-weight:600}
.game-over-banner{padding:40px;text-align:center;background:var(--gradient);color:#fff;border-radius:20px;font-size:28px;font-weight:bold;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
.game-over-banner.bad{background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%)}
details summary{cursor:pointer;font-weight:bold;color:var(--warning);padding:10px;transition:.3s all}
details summary:hover{color:var(--success)}
.status-badge{display:inline-block;padding:4px 12px;border-radius:20px;font-size:.85em;font-weight:600;margin-left:10px}
.status-ready{background:rgba(0,217,255,.2);color:var(--success);border:1px solid var(--success)}
.status-not-ready{background:rgba(255,0,110,.2);color:var(--danger);border:1px solid var(--danger)}
.role-icon{display:inline-block;width:30px;height:30px;margin-right:10px;text-align:center;line-height:30px;border-radius:50%;background:rgba(255,255,255,.1)}
.loading-spinner{display:inline-block;width:20px;height:20px;border:3px solid rgba(255,255,255,.3);border-radius:50%;border-top-color:var(--accent);animation:spin 1s infinite ease-in-out}
@keyframes spin{to{transform:rotate(360deg)}}
.identity-card{background:rgba(255,255,255,.05);padding:20px;border-radius:15px;margin:10px 0;border:2px solid var(--border);transition:.3s all}
.identity-card:hover{transform:translateY(-2px);box-shadow:0 5px 20px rgba(0,0,0,.3)}
.action-status{padding:15px;background:rgba(255,255,255,.05);border-radius:12px;margin:15px 0}
.night-status-board{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px;margin-top:15px;padding:15px;background:rgba(0,0,0,.2);border-radius:10px}
.status-item{background:rgba(255,255,255,.05);padding:10px;border-radius:8px;display:flex;justify-content:space-between;align-items:center}
.status-item .role{font-weight:bold;}
.status-item .status{font-weight:bold;}
.status-item .status.pending{color:var(--warning)}
.status-item .status.complete{color:var(--success)}
.status-item .status.skipped{color:#888}
@media(max-width:600px){#app{padding:20px}h1{font-size:1.5em}button{padding:10px 16px;font-size:14px}}
</style>
</head>
<body>
<div id="app">
    <!-- Setup View -->
    <div id="setup-view">
        <h1>ğŸŒ™ åŒèº«ä»½ç‹¼äººæ€ - ç”µå­æ³•å®˜</h1>
        <h2>ğŸ“‹ èº«ä»½é…ç½®</h2>
        <div id="role-setup"></div>
        <p style="text-align:center;font-size:18px;">
            <span style="color:var(--warning)">æ€»èº«ä»½æ•°: <strong id="total-roles">0</strong></span> |
            <span style="color:var(--success)">é¢„è®¡ç©å®¶æ•°: <strong id="player-cnt">0</strong></span>
        </p>
        <div style="text-align:center;margin-top:20px;">
            <button id="btn-create" class="control-btn">
                <span id="create-text">åˆ›å»ºæ¸¸æˆ</span>
                <span id="create-spinner" class="loading-spinner hidden"></span>
            </button>
        </div>
    </div>

    <!-- Game View -->
    <div id="game-view" class="hidden">
        <h1 id="game-title">ğŸŒ™ åŒèº«ä»½ç‹¼äººæ€</h1>
        <div id="player-info">
            <h2 id="pid-show"></h2>
            <h3>ä½ çš„èº«ä»½æ˜¯:</h3>
            <div id="my-ids" class="identity-card"></div>
            <div id="swap-area" class="hidden">
                <p style="text-align:center;color:var(--warning)">æ¸¸æˆå¼€å§‹å‰ï¼Œä½ å¯ä»¥äº¤æ¢ä¸¤ä¸ªèº«ä»½çš„é¡ºåºã€‚å½“å‰ç”Ÿæ•ˆçš„èº«ä»½æ˜¯ç¬¬ä¸€ä¸ªã€‚</p>
                <div style="text-align:center;">
                    <button id="btn-swap" class="action-btn">ğŸ”„ äº¤æ¢é¡ºåº</button>
                    <button id="btn-confirm" class="confirm-btn">âœ… ç¡®å®šèº«ä»½é¡ºåº</button>
                </div>
            </div>
        </div>
        <hr>
        <div id="game-area">
            <div id="player-status" style="text-align:center;font-size:20px;font-weight:bold;padding:15px;background:rgba(255,255,255,.05);border-radius:15px;margin-bottom:20px;">ç­‰å¾…æ¸¸æˆå¼€å§‹...</div>
            
            <!-- Host Controls -->
            <div id="host-controls" class="hidden action-feedback"></div>

            <div id="persist" class="hidden"></div>
            <div id="action-panel"></div>
            <div id="wolf-chat-area" class="hidden"></div>
            
            <details open>
                <summary>æ˜¾ç¤º/éšè—ç©å®¶åˆ—è¡¨</summary>
                <div id="player-list"></div>
            </details>

             <details>
                <summary>æ˜¾ç¤º/éšè—å®Œæ•´èº«ä»½åº•ç‰Œ (ä»…ä¸»æŒäºº)</summary>
                <div id="host-player-list-reveal" class="hidden"></div>
            </details>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
/* ==========================================================
   åŒèº«ä»½ç‹¼äººæ€ - 2024-07-25 è‡ªåŠ¨åŒ–æµç¨‹ä¿®å¤ç‰ˆ
   ========================================================== */

const firebaseConfig = { apiKey: "AIzaSyCEAgB6DoY8YA6lZnYblhIDVTYH_q8UimI", authDomain: "werewolf-game-master-1f37f.firebaseapp.com", databaseURL: "https://werewolf-game-master-1f37f-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "werewolf-game-master-1f37f", storageBucket: "werewolf-game-master-1f37f.appspot.com", messagingSenderId: "626014452910", appId: "1:626014452910:web:35b6eba412f95f1878013f" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const ROLES = {
    'å¹³æ°‘': { name: 'å¹³æ°‘', faction: 'good', isGod: false, icon: 'ğŸ‘¤' },
    'å®ˆå«': { name: 'å®ˆå«', faction: 'good', isGod: true, icon: 'ğŸ›¡ï¸', actionPhase: 'GUARD' },
    'ç™½ç—´': { name: 'ç™½ç—´', faction: 'good', isGod: true, icon: 'ğŸ¤ª' },
    'é¢„è¨€å®¶': { name: 'é¢„è¨€å®¶', faction: 'good', isGod: true, icon: 'ğŸ”®', actionPhase: 'SEER' },
    'éª‘å£«': { name: 'éª‘å£«', faction: 'good', isGod: true, icon: 'âš”ï¸' },
    'éšç‹¼': { name: 'éšç‹¼', faction: 'bad', isGod: false, isInvisible: true, icon: 'ğŸŒ‘', actionPhase: 'WOLF' },
    'å¥³å·«': { name: 'å¥³å·«', faction: 'good', isGod: true, icon: 'ğŸ§ª', actionPhase: 'WITCH' },
    'çŒäºº': { name: 'çŒäºº', faction: 'good', isGod: true, icon: 'ğŸ”«' },
    'ç‹¼äºº': { name: 'ç‹¼äºº', faction: 'bad', isGod: false, icon: 'ğŸº', actionPhase: 'WOLF' },
    'ç›—è´¼': { name: 'ç›—è´¼', faction: 'neutral', isGod: false, isThief: true, icon: 'ğŸ­' }
};

const DEFAULT_SETUP = { 'å¹³æ°‘': 6, 'å®ˆå«': 1, 'ç™½ç—´': 1, 'é¢„è¨€å®¶': 1, 'éª‘å£«': 1, 'å¥³å·«': 1, 'çŒäºº': 1, 'ç‹¼äºº': 2, 'éšç‹¼': 1, 'ç›—è´¼': 1 };
const FORBIDDEN = [['é¢„è¨€å®¶', 'ç‹¼äºº'], ['é¢„è¨€å®¶', 'éšç‹¼'], ['ç›—è´¼', 'ç‹¼äºº'], ['ç›—è´¼', 'éšç‹¼'], ['éšç‹¼', 'ç‹¼äºº'], ['éšç‹¼', 'éšç‹¼']];
const NIGHT_SEQUENCE = ['GUARD', 'SEER', 'WOLF', 'WITCH'];

const App = {
    gameId: null, playerId: null, isHost: false,
    gameState: null, allPlayers: {}, playerData: null,
    wolfChatListener: null,

    $(id) { return document.getElementById(id); },
    copy(t) { navigator.clipboard.writeText(t).then(() => alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿')); },

    init() {
        const qs = new URLSearchParams(location.search);
        this.gameId = qs.get('game');
        this.playerId = qs.get('player');

        if (this.gameId && this.playerId) {
            this.showView('game');
            this.listenToGameChanges();
        } else {
            this.showView('setup');
            this.renderRoleSetup();
            this.$('btn-create').onclick = () => this.createGame();
        }
    },

    showView(view) {
        this.$('setup-view').classList.add('hidden');
        this.$('game-view').classList.add('hidden');
        this.$(view + '-view').classList.remove('hidden');
    },

    renderRoleSetup() {
        let h = '';
        for (const r in DEFAULT_SETUP) {
            h += `<div class="role-setup-item"><span><span class="role-icon">${ROLES[r].icon}</span>${r}</span><input type="number" id="role-${r}" min="0" value="${DEFAULT_SETUP[r]}"></div>`;
        }
        this.$('role-setup').innerHTML = h;
        const updateCounts = () => {
            let total = 0;
            this.$('role-setup').querySelectorAll('input').forEach(i => total += +i.value || 0);
            this.$('total-roles').textContent = total;
            this.$('player-cnt').textContent = total % 2 === 0 ? total / 2 : 'èº«ä»½æ€»æ•°å¿…é¡»ä¸ºå¶æ•°';
        };
        this.$('role-setup').oninput = updateCounts;
        updateCounts();
    },

    async createGame() {
        this.$('btn-create').disabled = true;
        this.$('create-text').classList.add('hidden');
        this.$('create-spinner').classList.remove('hidden');

        const pool = [];
        this.$('role-setup').querySelectorAll('input').forEach(i => {
            const r = i.id.replace('role-', '');
            for (let k = 0; k < +i.value; k++) pool.push(r);
        });

        if (pool.length === 0 || pool.length % 2 !== 0) {
            alert('èº«ä»½æ€»æ•°éœ€ä¸ºå¶æ•°ä¸” > 0');
            location.reload();
            return;
        }

        const pairs = this.deal(pool);
        if (!pairs) {
            alert('æ— æ³•ç”Ÿæˆåˆæ³•ç‰Œç»„ï¼Œè¯·æ£€æŸ¥é…ç½®åé‡è¯•ã€‚');
            location.reload();
            return;
        }

        const gameId = db.ref('games').push().key;
        const playerCount = pool.length / 2;
        const players = {};
        for (let i = 1; i <= playerCount; i++) {
            players[i] = {
                id: i,
                identities: pairs[i - 1],
                originalIdentities: JSON.parse(JSON.stringify(pairs[i - 1])),
                deaths: 0,
                isAlive: true,
                isReady: false,
                isExposedIdiot: false,
                skillStates: {}
            };
        }

        const initialGameState = {
            state: {
                phase: 'SETUP',
                round: 0,
                creatorId: '1',
                peaceNightStreak: 0,
                winner: null,
                nightActionPhase: null
            },
            players,
            config: { playerCount },
            wolfChat: {},
            nightActions: {},
        };

        await db.ref(`games/${gameId}`).set(initialGameState);
        location.search = `?game=${gameId}&player=1`;
    },

    deal(pool) {
        const maxTries = 5000;
        const shuffle = a => {
            for (let i = a.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        };

        for (let t = 0; t < maxTries; t++) {
            const shuffled = shuffle([...pool]);
            const pairs = [];
            let badCombo = false;
            for (let i = 0; i < shuffled.length; i += 2) {
                const r1 = shuffled[i], r2 = shuffled[i + 1];
                if (FORBIDDEN.some(([a, b]) => (a === r1 && b === r2) || (a === r2 && b === r1))) {
                    badCombo = true;
                    break;
                }
                pairs.push([r1, r2]);
            }
            if (badCombo) continue;

            let goldBabies = 0;
            const finalPairs = pairs.map(([r1, r2]) => {
                let p1 = { role: r1, isThiefCopy: false };
                let p2 = { role: r2, isThiefCopy: false };
                if (r1 === 'ç›—è´¼' && r2 === 'ç›—è´¼') {
                    p1 = { role: 'å¹³æ°‘', isThiefCopy: true };
                    p2 = { role: 'å¹³æ°‘', isThiefCopy: true };
                } else if (r1 === 'ç›—è´¼') {
                    p1 = { role: r2, isThiefCopy: true };
                } else if (r2 === 'ç›—è´¼') {
                    p2 = { role: r1, isThiefCopy: true };
                }
                if (p1.role === 'å¹³æ°‘' && p2.role === 'å¹³æ°‘') {
                    goldBabies++;
                }
                return [p1, p2];
            });

            if (goldBabies >= 1 && goldBabies <= 2) {
                return finalPairs;
            }
        }
        return null;
    },

    listenToGameChanges() {
        db.ref(`games/${this.gameId}`).on('value', snapshot => {
            if (!snapshot.exists()) {
                document.body.innerHTML = '<h1>æ¸¸æˆä¸å­˜åœ¨æˆ–å·²ç»“æŸ</h1>';
                return;
            }
            const gameData = snapshot.val();
            this.gameState = gameData.state;
            this.allPlayers = gameData.players;
            this.playerData = gameData.players[this.playerId];
            this.isHost = this.playerData.id == this.gameState.creatorId;

            if (this.gameState.phase !== 'NIGHT') {
                this.stopWolfChatListener();
            }

            this.renderAll();
        });
    },

    renderAll() {
        if (!this.playerData) return;
        this.renderPlayerInfo();
        this.renderPlayerStatus();
        this.renderPlayerList();
        this.renderPersistentInfo();
        this.renderActionPanel();
        if (this.isHost) {
            this.renderHostControls();
            this.renderHostPlayerReveal();
        }
    },

    renderPlayerInfo() {
        this.$('pid-show').textContent = `ğŸ® ä½ æ˜¯ ${this.playerId} å·${this.isHost ? ' (ä¸»æŒäºº)' : ''}`;
        const identities = this.playerData.identities;
        const deaths = this.playerData.deaths;
        const formatId = (id) => `${ROLES[id.role].icon} ${id.isThiefCopy ? `<span class="thief-copy">${id.role}</span>` : id.role}`;
        
        this.$('my-ids').innerHTML = `
            <div style="font-size:24px;">
                ${deaths >= 1 ? '<span class="dead-identity">' : ''}${formatId(identities[0])}${deaths >= 1 ? '</span>' : ''}
                <span style="margin:0 20px;">+</span>
                ${deaths >= 2 ? '<span class="dead-identity">' : ''}${formatId(identities[1])}${deaths >= 2 ? '</span>' : ''}
            </div>`;

        const showSwap = this.gameState.phase === 'SETUP' && !this.playerData.isReady;
        this.$('swap-area').classList.toggle('hidden', !showSwap);
        if (showSwap) {
            this.$('btn-swap').onclick = () => {
                const [a, b] = this.playerData.identities;
                db.ref(`games/${this.gameId}/players/${this.playerId}/identities`).set([b, a]);
            };
            this.$('btn-confirm').onclick = () => {
                if (!this.playerData.isReady) {
                    db.ref(`games/${this.gameId}/players/${this.playerId}/isReady`).set(true);
                }
            };
        }
    },

    renderPlayerStatus() {
        const phase = this.gameState.phase;
        const round = this.gameState.round;
        const winner = this.gameState.winner;
        let statusText = '';

        if (winner) {
            statusText = `ğŸ† ${winner}`;
            this.$('game-title').innerHTML = `<div class="game-over-banner ${winner.includes('ç‹¼äºº') ? 'bad' : ''}">${winner}</div>`;
        } else {
            const statusMap = {
                'SETUP': 'â³ ç­‰å¾…æ‰€æœ‰ç©å®¶å‡†å¤‡...',
                'DAY': `â˜€ï¸ ç¬¬ ${round} å¤© - å‘è¨€/æŠ•ç¥¨é˜¶æ®µ`,
                'NIGHT': `ğŸŒ™ ç¬¬ ${round} å¤œ - å¤œæ™šè¡ŒåŠ¨ä¸­...`
            };
            statusText = statusMap[phase] || 'æœªçŸ¥çŠ¶æ€';
        }
        this.$('player-status').innerHTML = statusText;
    },

    renderPlayerList() {
        let h = '';
        Object.values(this.allPlayers).forEach(p => {
            const lives = 2 - p.deaths;
            const heart1 = `<span class="life-heart ${lives < 1 ? 'lost' : ''}">â¤</span>`;
            const heart2 = `<span class="life-heart ${lives < 2 ? 'lost' : ''}">â¤</span>`;
            h += `<div class="player-list-item ${!p.isAlive ? 'dead-all' : p.deaths > 0 ? 'dead' : ''}">
                    <span><strong>${p.id}å·</strong> <small>${p.isExposedIdiot ? 'ğŸ¤ª ç™½ç—´' : ''}</small></span>
                    <span>${heart1}${heart2}</span>
                  </div>`;
        });
        this.$('player-list').innerHTML = h;
    },
    
    renderHostPlayerReveal() {
        this.$('host-player-list-reveal').classList.remove('hidden');
        let h = '';
        Object.values(this.allPlayers).forEach(p => {
            const id1 = p.originalIdentities[0];
            const id2 = p.originalIdentities[1];
            const format = (id) => `${ROLES[id.role].icon} ${id.role}${id.isThiefCopy ? '(ç›—)' : ''}`;
            h += `<div class="player-list-item">
                    <span><strong>${p.id}å·</strong></span>
                    <span>${format(id1)} + ${format(id2)}</span>
                  </div>`;
        });
        this.$('host-player-list-reveal').innerHTML = h;
    },

    renderPersistentInfo() {
        let h = '';
        if (this.getActiveRoleInfo(this.playerData)?.name === 'é¢„è¨€å®¶') {
            const seerResults = this.getSkillState('seerResults') || {};
            const log = Object.entries(seerResults).map(([id, res]) => `${id}å·(${res === 'bad' ? 'ğŸº' : 'ğŸ˜‡'})`).join('ã€');
            if (log) h += `<div><strong>ğŸ”® æŸ¥éªŒå†å²:</strong> ${log}</div>`;
        }
        this.$('persist').innerHTML = h;
        this.$('persist').classList.toggle('hidden', !h);
    },

    renderHostControls() {
        this.$('host-controls').classList.remove('hidden');
        const phase = this.gameState.phase;
        let h = '<h3>ğŸ‘‘ ä¸»æŒäººæ§åˆ¶å°</h3>';

        if (phase === 'SETUP') {
            const readyCount = Object.values(this.allPlayers).filter(p => p.isReady).length;
            const totalCount = Object.keys(this.allPlayers).length;
            h += `<p>å‡†å¤‡çŠ¶æ€: ${readyCount}/${totalCount}</p>`;
            h += `<button id="btn-start-game" class="control-btn" ${readyCount < totalCount ? 'disabled' : ''}>ğŸš€ é”å®šèº«ä»½ï¼Œå¼€å§‹æ¸¸æˆ</button>`;
        } else if (phase === 'DAY') {
            h += `<button id="btn-go-night" class="control-btn">ğŸŒ™ è¿›å…¥å¤œæ™š</button>`;
        } else if (phase === 'NIGHT') {
            const nightActions = this.gameState.nightActions || {};
            const actionPhase = this.gameState.nightActionPhase;
            const allDone = this.isNightPhaseComplete();
            h += `<p>å½“å‰å¤œæ™šé˜¶æ®µ: <strong>${actionPhase || 'æœªå¼€å§‹'}</strong></p>`;
            h += `<div class="night-status-board">`;
            NIGHT_SEQUENCE.forEach(p => {
                const status = nightActions[p] ? (nightActions[p].completed ? 'âœ… å®Œæˆ' : 'â³ è¿›è¡Œä¸­') : 'ğŸ”’ ç­‰å¾…';
                const statusClass = nightActions[p] ? (nightActions[p].completed ? 'complete' : 'pending') : 'skipped';
                h += `<div class="status-item"><span class="role">${p}</span> <span class="status ${statusClass}">${status}</span></div>`;
            });
            h += `</div>`;
            h += `<button id="btn-end-night" class="control-btn" ${!allDone ? 'disabled' : ''}>â˜€ï¸ å¤©äº®äº† (ç»“ç®—å¤œæ™š)</button>`;
        }

        this.$('host-controls').innerHTML = h;

        if (this.$('btn-start-game')) this.$('btn-start-game').onclick = () => this.updatePhase('DAY', 1);
        if (this.$('btn-go-night')) this.$('btn-go-night').onclick = () => this.updatePhase('NIGHT');
        if (this.$('btn-end-night')) this.$('btn-end-night').onclick = () => this.processNight();
    },

    async updatePhase(phase, round = null) {
        const updates = { 'state/phase': phase };
        let currentRound = this.gameState.round;
        if (round !== null) {
            updates['state/round'] = round;
            currentRound = round;
        } else if (phase === 'DAY') {
            currentRound = this.gameState.round;
        } else if (phase === 'NIGHT') {
            currentRound = this.gameState.round + 1;
            updates['state/round'] = currentRound;
        }

        if (phase === 'NIGHT') {
            updates['nightActions'] = {}; // Reset night actions
            updates['state/nightActionPhase'] = null;
        }
        await db.ref(`games/${this.gameId}`).update(updates);
        
        if (phase === 'NIGHT' && this.isHost) {
            // Automatically start the night sequence
            setTimeout(() => this.advanceNightPhase(), 1000);
        }
    },

    async advanceNightPhase() {
        const currentPhase = this.gameState.nightActionPhase;
        const currentIndex = currentPhase ? NIGHT_SEQUENCE.indexOf(currentPhase) : -1;
        let nextIndex = currentIndex + 1;

        while (nextIndex < NIGHT_SEQUENCE.length) {
            const nextPhase = NIGHT_SEQUENCE[nextIndex];
            const actors = Object.values(this.allPlayers).filter(p => this.doesRoleActInPhase(p, nextPhase));
            if (actors.length > 0) {
                const updates = {};
                updates[`state/nightActionPhase`] = nextPhase;
                updates[`nightActions/${nextPhase}`] = { completed: false, actions: {} };
                // Special case for witch, depends on wolf action
                if (nextPhase === 'WITCH') {
                    const wolfAction = this.gameState.nightActions?.WOLF;
                    if (!wolfAction || !wolfAction.completed) {
                        // Skip witch if wolves haven't acted
                        updates[`nightActions/WITCH`] = { completed: true, skipped: true }; 
                    } else {
                        // Witch is now pending
                    }
                } 
                await db.ref(`games/${this.gameId}`).update(updates);
                return; // Stop advancing
            }
            nextIndex++;
        }

        // If loop finishes, all phases are done or skipped
        if (this.isHost && !this.isNightPhaseComplete()) {
             // This is a fallback to ensure the night can end
            const finalUpdates = {};
            NIGHT_SEQUENCE.forEach(p => {
                if (!this.gameState.nightActions?.[p]) {
                    finalUpdates[`nightActions/${p}`] = { completed: true, skipped: true };
                }
            });
            await db.ref(`games/${this.gameId}`).update(finalUpdates);
        }
    },

    isNightPhaseComplete() {
        const actions = this.gameState.nightActions || {};
        return NIGHT_SEQUENCE.every(phase => actions[phase]?.completed);
    },

    doesRoleActInPhase(player, actionPhase) {
        if (!player.isAlive) return false;
        const role = this.getActiveRoleInfo(player);
        if (!role || role.actionPhase !== actionPhase) return false;

        // Special condition for Invisible Wolf
        if (role.name === 'éšç‹¼') {
            const hasLivingWolfTeammate = Object.values(this.allPlayers).some(p => 
                p.id !== player.id && p.isAlive && this.getActiveRoleInfo(p)?.name === 'ç‹¼äºº'
            );
            return !hasLivingWolfTeammate;
        }
        return true;
    },

    getActiveRoleInfo(player) {
        if (!player.isAlive) return null;
        const activeRoleName = player.identities[player.deaths].role;
        return ROLES[activeRoleName];
    },

    renderActionPanel() {
        this.$('action-panel').innerHTML = '';
        if (this.gameState.phase !== 'NIGHT' || !this.playerData.isAlive) return;

        const currentNightPhase = this.gameState.nightActionPhase;
        if (!currentNightPhase) return;

        const myRole = this.getActiveRoleInfo(this.playerData);
        if (!myRole || myRole.actionPhase !== currentNightPhase) {
            this.$('action-panel').innerHTML = `<div class="action-feedback"><p>å¤œæ™šè¿›è¡Œä¸­ï¼Œè¯·è€å¿ƒç­‰å¾…å…¶ä»–ç©å®¶è¡ŒåŠ¨...</p></div>`;
            return;
        }
        
        const nightActions = this.gameState.nightActions || {};
        if (nightActions[currentNightPhase]?.actions?.[this.playerId]) {
            this.$('action-panel').innerHTML = `<div class="action-feedback"><p>ä½ å·²å®Œæˆæ“ä½œï¼Œè¯·ç­‰å¾…å¤©äº®ã€‚</p></div>`;
            return;
        }

        switch (currentNightPhase) {
            case 'GUARD': this.panelGuard(); break;
            case 'SEER': this.panelSeer(); break;
            case 'WOLF': this.panelWolf(); break;
            case 'WITCH': this.panelWitch(); break;
        }
    },

    getSkillState(key) {
        return (this.playerData.skillStates || {})[`r${this.gameState.round}_d${this.playerData.deaths}_${key}`];
    },

    setSkillState(key, value) {
        return db.ref(`games/${this.gameId}/players/${this.playerId}/skillStates/r${this.gameState.round}_d${this.playerData.deaths}_${key}`).set(value);
    },

    async submitNightAction(action) {
        const phase = this.gameState.nightActionPhase;
        const actionPath = `nightActions/${phase}/actions/${this.playerId}`;
        await db.ref(`games/${this.gameId}/${actionPath}`).set(action);

        // Check if all actors in this phase are done
        if (this.isHost) {
            const actors = Object.values(this.allPlayers).filter(p => this.doesRoleActInPhase(p, phase));
            const completedActors = Object.keys(this.gameState.nightActions[phase].actions || {}).length;
            if (actors.length <= completedActors) {
                await db.ref(`games/${this.gameId}/nightActions/${phase}/completed`).set(true);
                this.advanceNightPhase();
            }
        }
    },

    panelGuard() {
        const lastGuard = this.getSkillState('lastGuardTarget');
        let h = '<h3>ğŸ›¡ï¸ å®ˆå«ï¼šè¯·é€‰æ‹©å®ˆæŠ¤ä¸€äºº</h3>';
        const buttons = Object.values(this.allPlayers).filter(p => p.isAlive).map(p => 
            `<button class="action-btn" data-id="${p.id}" ${p.id == lastGuard ? 'disabled' : ''}>${p.id}å·</button>`
        ).join('');
        h += `<div>${buttons}<button class="action-btn" data-id="-1">ç©ºå®ˆ</button></div>`;
        this.$('action-panel').innerHTML = h;
        this.$('action-panel').querySelectorAll('button').forEach(b => b.onclick = async () => {
            const targetId = b.dataset.id;
            await this.setSkillState('lastGuardTarget', targetId);
            this.submitNightAction({ target: targetId });
        });
    },

    panelSeer() {
        let h = '<h3>ğŸ”® é¢„è¨€å®¶ï¼šè¯·é€‰æ‹©æŸ¥éªŒä¸€äºº</h3>';
        const buttons = Object.values(this.allPlayers).map(p => 
            `<button class="action-btn" data-id="${p.id}" ${p.id == this.playerId ? 'disabled' : ''}>${p.id}å·</button>`
        ).join('');
        h += `<div>${buttons}</div>`;
        this.$('action-panel').innerHTML = h;
        this.$('action-panel').querySelectorAll('button').forEach(b => b.onclick = () => {
            this.submitNightAction({ target: b.dataset.id });
        });
    },

    panelWolf() {
        this.initWolfChat();
        let h = '<h3>ğŸº ç‹¼äººï¼šè¯·é€‰æ‹©å‡»æ€ç›®æ ‡</h3>';
        const buttons = Object.values(this.allPlayers).filter(p => p.isAlive).map(p => 
            `<button class="action-btn" data-id="${p.id}">${p.id}å·</button>`
        ).join('');
        h += `<div>${buttons}</div>`;
        this.$('action-panel').innerHTML = h;
        this.$('action-panel').querySelectorAll('button').forEach(b => b.onclick = () => {
            this.submitNightAction({ target: b.dataset.id });
        });
    },

    panelWitch() {
        const hasUsedAntidote = this.playerData.skillStates?.usedAntidote;
        const hasUsedPoison = this.playerData.skillStates?.usedPoison;
        const wolfKillTarget = this.gameState.nightActions?.WOLF?.actions ? Object.values(this.gameState.nightActions.WOLF.actions)[0].target : null;

        let h = '<h3>ğŸ§ª å¥³å·«ï¼šè¯·é€‰æ‹©ä½¿ç”¨è¯å‰‚</h3>';
        let buttons = '';
        if (!hasUsedAntidote && wolfKillTarget && this.allPlayers[wolfKillTarget]?.isAlive) {
            buttons += `<button class="action-btn" data-action="save" data-id="${wolfKillTarget}">è§£æ•‘ ${wolfKillTarget} å·</button>`;
        }
        if (!hasUsedPoison) {
            buttons += '<h4>é€‰æ‹©æ¯’ä¸€äºº:</h4>';
            Object.values(this.allPlayers).filter(p => p.isAlive).forEach(p => {
                buttons += `<button class="action-btn" data-action="poison" data-id="${p.id}">${p.id}å·</button>`;
            });
        }
        buttons += `<button class="action-btn" data-action="skip">æœ¬æ™šä¸è¡Œä½¿æƒåŠ›</button>`;
        h += `<div>${buttons}</div>`;
        this.$('action-panel').innerHTML = h;
        this.$('action-panel').querySelectorAll('button').forEach(b => b.onclick = () => {
            const { action, id } = b.dataset;
            if (action === 'save') {
                db.ref(`games/${this.gameId}/players/${this.playerId}/skillStates/usedAntidote`).set(true);
                this.submitNightAction({ action: 'save', target: id });
            } else if (action === 'poison') {
                db.ref(`games/${this.gameId}/players/${this.playerId}/skillStates/usedPoison`).set(true);
                this.submitNightAction({ action: 'poison', target: id });
            } else {
                this.submitNightAction({ action: 'skip' });
            }
        });
    },

    initWolfChat() {
        this.$('wolf-chat-area').classList.remove('hidden');
        this.$('wolf-chat-area').innerHTML = `
            <div class="wolf-chat-box">
                <h3>ğŸº ç‹¼äººé¢‘é“</h3>
                <div id="wolf-chat"></div>
                <input id="wolf-input" placeholder="ç‹¼äººè¯·åœ¨æ­¤äº¤æµ...">
                <button id="wolf-send" class="action-btn">å‘é€</button>
            </div>`;

        const send = () => {
            const input = this.$('wolf-input');
            if (input.value.trim()) {
                db.ref(`games/${this.gameId}/wolfChat`).push({ pid: this.playerId, msg: input.value.trim(), ts: firebase.database.ServerValue.TIMESTAMP });
                input.value = '';
            }
        };
        this.$('wolf-send').onclick = send;
        this.$('wolf-input').onkeydown = e => { if (e.key === 'Enter') send(); };

        if (this.wolfChatListener) this.stopWolfChatListener();
        this.wolfChatListener = db.ref(`games/${this.gameId}/wolfChat`).on('value', snap => {
            const chat = this.$('wolf-chat');
            if (!chat) return;
            chat.innerHTML = '';
            snap.forEach(s => {
                const data = s.val();
                chat.innerHTML += `<div><strong>${data.pid}å·:</strong> ${data.msg}</div>`;
            });
            chat.scrollTop = chat.scrollHeight;
        });
    },

    stopWolfChatListener() {
        if (this.wolfChatListener) {
            db.ref(`games/${this.gameId}/wolfChat`).off('value', this.wolfChatListener);
            this.wolfChatListener = null;
        }
    },

    async processNight() {
        const night = this.gameState.nightActions;
        const updates = {};
        let deaths = []; // {id, reason}

        // 1. Wolf kill
        const wolfAction = night.WOLF?.actions ? Object.values(night.WOLF.actions)[0] : null;
        let wolfKillTarget = wolfAction?.target;

        // 2. Guard save
        const guardAction = night.GUARD?.actions ? Object.values(night.GUARD.actions)[0] : null;
        const guardSaveTarget = guardAction?.target;

        // 3. Witch action
        const witchAction = night.WITCH?.actions ? Object.values(night.WITCH.actions)[0] : null;
        let witchSaveTarget = null;
        if (witchAction?.action === 'save') witchSaveTarget = witchAction.target;
        if (witchAction?.action === 'poison') {
            deaths.push({ id: witchAction.target, reason: 'poison' });
        }

        // 4. Calculate deaths
        if (wolfKillTarget) {
            const isSavedByGuard = wolfKillTarget === guardSaveTarget;
            const isSavedByWitch = wolfKillTarget === witchSaveTarget;
            if (isSavedByGuard && isSavedByWitch) {
                deaths.push({ id: wolfKillTarget, reason: 'double_save' }); // Double save kills
            } else if (!isSavedByGuard && !isSavedByWitch) {
                deaths.push({ id: wolfKillTarget, reason: 'wolf_kill' });
            }
        }

        // 5. Process Seer results
        const seerAction = night.SEER?.actions ? Object.values(night.SEER.actions)[0] : null;
        if (seerAction?.target) {
            const targetPlayer = this.allPlayers[seerAction.target];
            const targetRole = this.getActiveRoleInfo(targetPlayer);
            let result = targetRole.faction;
            if (targetRole.name === 'éšç‹¼' && Object.values(this.allPlayers).some(p => p.isAlive && this.getActiveRoleInfo(p)?.name === 'ç‹¼äºº')) {
                result = 'good'; // Invisible wolf appears good
            }
            const seerId = Object.keys(night.SEER.actions)[0];
            updates[`players/${seerId}/skillStates/seerResults/${seerAction.target}`] = result;
        }

        // 6. Apply deaths
        let peaceNight = deaths.length === 0;
        for (const death of deaths) {
            const player = this.allPlayers[death.id];
            if (!player.isAlive) continue;
            player.deaths++;
            updates[`players/${death.id}/deaths`] = player.deaths;
            if (player.deaths >= 2) {
                updates[`players/${death.id}/isAlive`] = false;
            }
        }
        
        updates['state/phase'] = 'DAY';
        updates['state/peaceNightStreak'] = peaceNight ? (this.gameState.peaceNightStreak || 0) + 1 : 0;

        await db.ref(`games/${this.gameId}`).update(updates);
        this.checkGameOver();
    },

    checkGameOver() {
        const players = Object.values(this.allPlayers);
        const living = players.filter(p => p.isAlive);
        
        const livingGods = living.filter(p => this.getActiveRoleInfo(p)?.isGod).length;
        const livingWolves = living.filter(p => this.getActiveRoleInfo(p)?.faction === 'bad').length;
        const livingGoldBabies = living.filter(p => p.originalIdentities.every(id => id.role === 'å¹³æ°‘')).length;

        let winner = null;
        if (livingWolves === 0) {
            winner = 'ğŸ˜‡ å¥½äººé˜µè¥èƒœåˆ© (ç‹¼äººå‡ºå±€)';
        } else if (this.gameState.peaceNightStreak >= 3) {
            winner = 'ğŸ˜‡ å¥½äººé˜µè¥èƒœåˆ© (ä¸‰è¿å¹³å®‰å¤œ)';
        } else if (livingGods === 0) {
            winner = 'ğŸº ç‹¼äººé˜µè¥èƒœåˆ© (ç¥èŒæ­»å®Œ)';
        } else if (livingGoldBabies === 0) {
            winner = 'ğŸº ç‹¼äººé˜µè¥èƒœåˆ© (é‡‘å®å®æ­»å®Œ)';
        }

        if (winner) {
            db.ref(`games/${this.gameId}/state/winner`).set(winner);
            db.ref(`games/${this.gameId}/state/phase`).set('GAME_OVER');
        }
    }
};

window.onload = () => App.init();

</script>
</body>
</html>
