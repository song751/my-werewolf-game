<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>双身份狼人杀 - 电子法官</title>

<style>
:root{
 --bg:#2c3e50; --p:#34495e; --s:#2c3e50; --a:#e74c3c; --t:#ecf0f1;
 --good:#2ecc71; --bad:#e74c3c; --neutral:#f1c40f;
 --font-main:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
}
html,body{margin:0;padding:0;background:var(--bg);color:var(--t);font-family:var(--font-main);line-height:1.6;}
body{display:flex;justify-content:center;align-items:flex-start;min-height:100vh;padding:20px;}
#app{width:100%;max-width:800px;background:var(--p);border-radius:12px;padding:25px;box-shadow:0 10px 40px rgba(0,0,0,.5);border:1px solid #4a627a;}
h1,h2,h3{color:var(--t);border-bottom:2px solid #4a627a;padding-bottom:10px;text-align:center;letter-spacing:1px;}
h1{color:#e74c3c;}
hr{border:none;border-top:1px solid #4a627a;margin:25px 0;}
.hidden{display:none!important}
button{background:var(--a);color:#fff;border:none;padding:12px 20px;border-radius:8px;cursor:pointer;font-size:16px;font-weight:700;margin:5px;transition:all .3s ease;outline:none;}
button:hover:not(:disabled){filter:brightness(1.1);transform:translateY(-2px);box-shadow:0 4px 15px rgba(0,0,0,.3);}
button:disabled{background:#7f8c8d;cursor:not-allowed;transform:none;box-shadow:none;opacity: 0.6;}
button.selected{background:var(--good)!important;transform:translateY(-2px);box-shadow:0 4px 15px rgba(0,0,0,.3);}
button.control-btn{background:#3498db;}
button.action-btn{background:#8e44ad;}
input[type=number],input[type=text]{width:60px;padding:10px;border-radius:5px;border:1px solid #4a627a;background:var(--s);color:var(--t);font-size:16px;text-align:center;transition:all .3s ease;}
input:focus{background:#4a627a;border-color:var(--a);}
.role-setup-item{display:flex;justify-content:space-between;align-items:center;padding:8px;margin:4px 0;background:rgba(0,0,0,0.1);border-radius:5px;}
.player-list-item{display:flex;justify-content:space-between;align-items:center;padding:12px;margin:8px 0;background:#2c3e50;border-radius:8px;transition:all .3s ease;}
.player-list-item.dead{opacity:.6;text-decoration:line-through;}
.player-list-item.dead-all{opacity:.4;background:#3d3d3d;text-decoration:line-through;filter:grayscale(1);}
.life-heart{color:var(--a);font-size:20px;transition:all .3s ease;}.life-heart.lost{color:#7f8c8d;opacity:.5;}
.thief-copy{color:#bdc3c7;font-style:italic;}
.dead-identity{text-decoration:line-through;opacity:.6;}
.action-panel,.action-feedback{margin-top:20px;padding:15px;background:rgba(0,0,0,0.15);border-radius:8px;text-align:center;}
.wolf-chat-box{padding:15px;background:rgba(0,0,0,0.2);border-radius:8px;margin-top:15px;}
#wolf-chat{height:150px;overflow-y:auto;border:1px solid #4a627a;padding:10px;border-radius:5px;margin-bottom:10px;background:var(--s);}
.vote-msg{color:var(--neutral);}
.game-over-banner{padding:30px;text-align:center;background:var(--good);color:#fff;border-radius:10px;font-size:24px;font-weight:bold;}
.game-over-banner.bad{background:var(--bad);}
details summary {cursor:pointer;font-weight:bold;color:var(--neutral);}
</style>
</head>
<body>
<div id="app">
  <div id="host-view">
    <h1>双身份狼人杀 - 主持端</h1>
    <div id="setup">
      <h2>1. 身份配置</h2>
      <div id="role-setup"></div>
      <p>总身份数: <span id="total-roles">0</span> | 预计玩家数: <span id="player-cnt">0</span></p>
      <button id="btn-create" class="control-btn">创建游戏</button>
    </div>

    <div id="links" class="hidden">
      <h2>2. 分享链接</h2><div id="links-box"></div>
    </div>

    <div id="host-ctrl" class="hidden">
      <h2>3. 游戏控制</h2>
      <div id="host-status"></div><div id="ready-box"></div>
      <button id="btn-start" class="control-btn">锁定身份，开始游戏</button>
      <button id="btn-night" class="control-btn">天黑请闭眼</button>
      <button id="btn-day" class="control-btn">天亮了 (结算夜晚)</button><hr>
      <h3>夜晚行动 (手动推进)</h3>
      <button class="host-action" data-action="WOLF_ACTION">狼人行动</button>
      <button class="host-action" data-action="WITCH_ACTION">女巫行动</button>
      <button class="host-action" data-action="SEER_ACTION">预言家行动</button>
      <button class="host-action" data-action="GUARD_ACTION">守卫行动</button>
      <div id="action-feedback-box"></div>
      <div id="night-result" class="hidden"></div><hr>
      <h3>游戏管理</h3>
      <button id="btn-reveal">复盘：显示所有身份</button>
      <div id="host-player-list"></div>
    </div>
  </div>

  <div id="player-view" class="hidden">
    <h1 id="game-title">双身份狼人杀</h1>
    <div id="player-info">
      <h2 id="pid-show"></h2>
      <h3>你的身份是:</h3>
      <div id="my-ids" class="player-list-item"></div>
      <div id="swap-area" class="hidden">
        <p>游戏开始前，你可以交换两个身份的顺序。当前生效的身份是第一个。</p>
        <button id="btn-swap">交换顺序</button>
        <button id="btn-confirm" class="control-btn">确定身份顺序</button>
      </div>
    </div><hr>
    <div id="game-area">
      <div id="player-status" style="text-align:center; font-size: 20px; font-weight: bold; padding: 10px;">等待游戏开始...</div>
      <div id="persist" class="hidden"></div>
      <div id="action-panel"></div>
      <div id="wolf-chat-area" class="hidden"></div>
      <h3>玩家列表</h3><div id="player-list"></div>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
/* ==========================================================
   该文件为双身份狼人杀前端主逻辑 (2025-06-27 修订版)
   ———— 目录导览 ————
   1. Firebase 初始化
   2. 全局常量与配置
   3. App 主对象
      3.1 初始化与公共工具
      3.2 主持端逻辑
      3.3 玩家端逻辑
          3.3.1 渲染与更新
          3.3.2 身份与行动权判断
          3.3.3 各角色行动面板
      3.4 核心游戏流程 (击杀、结算)
      3.5 胜负判定
   ========================================================== */

/* ========== 1. Firebase 初始化 ========== */
const firebaseConfig={
 apiKey:"AIzaSyCEAgB6DoY8YA6lZnYblhIDVTYH_q8UimI",
 authDomain:"werewolf-game-master-1f37f.firebaseapp.com",
 databaseURL:"https://werewolf-game-master-1f37f-default-rtdb.asia-southeast1.firebasedatabase.app",
 projectId:"werewolf-game-master-1f37f",
 storageBucket:"werewolf-game-master-1f37f.appspot.com",
 messagingSenderId:"626014452910",
 appId:"1:626014452910:web:35b6eba412f95f1878013f"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

/* ========== 2. 全局常量与配置 ========== */
const ROLES={
 '平民':{name:'平民',faction:'good',isGod:false},
 '守卫':{name:'守卫',faction:'good',isGod:true},
 '白痴':{name:'白痴',faction:'good',isGod:true},
 '预言家':{name:'预言家',faction:'good',isGod:true},
 '骑士':{name:'骑士',faction:'good',isGod:true},
 '女巫':{name:'女巫',faction:'good',isGod:true},
 '猎人':{name:'猎人',faction:'good',isGod:true},
 '狼人':{name:'狼人',faction:'bad',isGod:false},
 '隐狼':{name:'隐狼',faction:'bad',isGod:false,isInvisible:true},
 '盗贼':{name:'盗贼',faction:'neutral',isGod:false,isThief:true}
};
const DEFAULT_SETUP={'平民':6,'守卫':1,'白痴':1,'预言家':1,'骑士':1,'女巫':1,'猎人':1,'狼人':2,'隐狼':1,'盗贼':1};
const FORBIDDEN=[['预言家','狼人'],['预言家','隐狼'],['盗贼','狼人'],['盗贼','隐狼'],['隐狼','狼人'],['隐狼','隐狼']];

/* ===================== 3. App 主对象 ===================== */
const App={
/* ---------- 3.0 基础属性 ---------- */
gameId:null,playerId:null,isHost:false,
gameState:null,allPlayers:{},playerData:null,
wolfChatListener:null,wolfVotesListener:null,

/* ---------- 3.1 初始化与公共工具 ---------- */
init(){
 this.cacheDom();
 const qp=new URLSearchParams(location.search);
 this.gameId=qp.get('game');this.playerId=qp.get('player');
 if(this.gameId&&this.playerId){this.isHost=false;this.showView('player');this.initPlayer();}
 else{this.isHost=true;this.showView('host');this.initHost();}
},

$(id){return document.getElementById(id);},
copy(text){navigator.clipboard.writeText(text).then(()=>alert('已复制到剪贴板'),()=>alert('复制失败'));},

cacheDom(){
 this.dom={
  hostView:this.$('host-view'),playerView:this.$('player-view'),
  roleSetup:this.$('role-setup'),totalRoles:this.$('total-roles'),playerCnt:this.$('player-cnt'),
  btnCreate:this.$('btn-create'),links:this.$('links'),linksBox:this.$('links-box'),
  hostCtrl:this.$('host-ctrl'),btnStart:this.$('btn-start'),btnNight:this.$('btn-night'),btnDay:this.$('btn-day'),
  hostActions:document.querySelectorAll('.host-action'),hostPlayerList:this.$('host-player-list'),
  btnReveal:this.$('btn-reveal'),readyBox:this.$('ready-box'),actionFeedback:this.$('action-feedback-box'),
  nightResult:this.$('night-result'),pidShow:this.$('pid-show'),myIds:this.$('my-ids'),
  swapArea:this.$('swap-area'),btnSwap:this.$('btn-swap'),btnConfirm:this.$('btn-confirm'),
  playerStatus:this.$('player-status'),persist:this.$('persist'),actionPanel:this.$('action-panel'),
  playerList:this.$('player-list'),wolfChatArea:this.$('wolf-chat-area'),gameTitle:this.$('game-title')
 };
},
showView(viewName){
 this.dom.hostView.classList.add('hidden');
 this.dom.playerView.classList.add('hidden');
 if(viewName==='host') this.dom.hostView.classList.remove('hidden');
 else this.dom.playerView.classList.remove('hidden');
},

/* =========================================================
   3.2  主持端逻辑
   ========================================================= */
initHost(){
 this.renderRoleSetup();
 this.dom.btnCreate.onclick=()=>this.createGame();
 this.dom.btnStart.onclick=()=>this.startGame();
 this.dom.btnNight.onclick=()=>this.updatePhase('NIGHT_START');
 this.dom.btnDay.onclick=()=>this.processNightResults();
 this.dom.hostActions.forEach(b=>b.onclick=()=>this.triggerAction(b.dataset.action));
 this.dom.btnReveal.onclick=()=>this.renderHostPlayers(true);
},

renderRoleSetup(){
 let html='';
 for(const r in DEFAULT_SETUP){
  html+=`<div class="role-setup-item"><span>${r}</span>
         <input type="number" id="role-${r}" min="0" value="${DEFAULT_SETUP[r]}"></div>`;
 }
 this.dom.roleSetup.innerHTML=html;
 this.dom.roleSetup.oninput=()=>this.updateRoleCount();this.updateRoleCount();
},

updateRoleCount(){
 let total=0;
 this.dom.roleSetup.querySelectorAll('input').forEach(i=>total+=+i.value||0);
 this.dom.totalRoles.textContent=total;
 this.dom.playerCnt.textContent=total%2===0?total/2:'身份总数必须为偶数';
},

async createGame(){
 this.dom.btnCreate.disabled=true;this.dom.btnCreate.textContent='正在生成牌组...';
 const rolePool=[];
 this.dom.roleSetup.querySelectorAll('input').forEach(i=>{
  const role=i.id.replace('role-','');for(let k=0;k<(+i.value||0);k++)rolePool.push(role);
 });
 if(rolePool.length===0||rolePool.length%2){alert('身份总数必须为偶数且大于0');location.reload();return;}

 let identityPairs,tryCount=0;
 do{identityPairs=this.dealIdentities(rolePool);tryCount++;}
 while(!identityPairs&&tryCount<5000);
 if(!identityPairs){alert('尝试5000次后仍未生成合法牌组，请检查或调整身份配置。');location.reload();return;}

 this.gameId=db.ref('games').push().key;
 const playerCount=rolePool.length/2,players={};
 for(let i=1;i<=playerCount;i++){
  players[i]={
   id:i,identities:identityPairs[i-1],originalIdentities:[...identityPairs[i-1]],
   deaths:0,isAlive:true,isReady:false,isExposedIdiot:false,
   seerResults:{},lastGuardTarget:null,hasUsedPoison:false,hasUsedCure:false,
  };
 }
 const initialGameData={
  state:{phase:'SETUP',round:0,peaceNightStreak:0,winner:null},
  players,config:{playerCount},
  wolfChat:{},wolfVotes:{},nightActions:{},actionCompleted:{}
 };
 await db.ref(`games/${this.gameId}`).set(initialGameData);
 this.listenToGameChanges();
 this.buildPlayerLinks(playerCount);
 this.dom.btnCreate.classList.add('hidden');
 this.dom.links.classList.remove('hidden');
 this.dom.hostCtrl.classList.remove('hidden');
},

dealIdentities(pool){
 const shuffled=[...pool].sort(()=>Math.random()-.5);
 let pairs=[];
 for(let i=0;i<shuffled.length;i+=2)pairs.push([shuffled[i],shuffled[i+1]]);
 
 pairs=pairs.map(p=>{
  if(p[0]==='盗贼')return[{role:p[1],isThiefCopy:true},{role:p[1],isThiefCopy:false}];
  if(p[1]==='盗贼')return[{role:p[0],isThiefCopy:false},{role:p[0],isThiefCopy:true}];
  return[{role:p[0],isThiefCopy:false},{role:p[1],isThiefCopy:false}];
 });

 for(const p of pairs){
  const r1=p[0].role,r2=p[1].role;
  if(FORBIDDEN.some(f=>(r1===f[0]&&r2===f[1])||(r1===f[1]&&r2===f[0])))return null;
 }
 let goldenBabyCount=0;
 pairs.forEach(p=>{if(p[0].role==='平民'&&p[1].role==='平民')goldenBabyCount++;});
 return(goldenBabyCount>=1&&goldenBabyCount<=2)?pairs:null;
},

buildPlayerLinks(count){
 const base=location.href.split('?')[0],tpl=`${base}?game=${this.gameId}&player=[N]`;
 let linksHtml='';
 for(let i=1;i<=count;i++){
    const l=`${base}?game=${this.gameId}&player=${i}`;
    linksHtml+=`<div style="margin:6px 0;"><span style="display:inline-block;width:50px;">${i}号:</span><input value="${l}" readonly><button onclick="App.copy('${l}')">复制</button></div>`;
 }
 this.dom.linksBox.innerHTML=`<p><strong>通用模板:</strong></p><input value="${tpl}" readonly><button onclick="App.copy('${tpl}')">复制</button>
                              <details><summary>展开/折叠各玩家专属链接</summary>${linksHtml}</details>`;
},

listenToGameChanges(){
 db.ref(`games/${this.gameId}`).on('value',snap=>{
  if(!snap.exists())return;
  const gameData=snap.val();
  this.gameState=gameData.state;
  this.allPlayers=gameData.players||{};
  this.renderHostPlayers(false);
  this.updateReadyStatus();
  this.updateHostControlsState();
 });
},

updateReadyStatus(){
 const players=Object.values(this.allPlayers),total=players.length;
 if(total===0)return;
 const ready=players.filter(p=>p.isReady).length;
 let html=`<h3>准备状态 (${ready}/${total})</h3>`;
 players.forEach(p=>{html+=`${p.id}号: ${p.isReady?'<span style="color:var(--good)">已准备</span>':'<span style="color:var(--bad)">未准备</span>'}<br>`;});
 this.dom.readyBox.innerHTML=html;
 this.dom.btnStart.disabled=ready<total;
},

updateHostControlsState() {
    const phase = this.gameState.phase;
    const isNight = phase.includes('ACTION') || phase === 'NIGHT_START';

    this.dom.btnStart.disabled = phase !== 'SETUP' || !this.dom.btnStart.disabled; // Keep ready check
    this.dom.btnNight.disabled = isNight;
    this.dom.btnDay.disabled = !isNight;
    
    // Disable all action buttons during the day
    this.dom.hostActions.forEach(btn => btn.disabled = (phase === 'DAY'));
},

async startGame(){
 if(this.dom.btnStart.disabled)return;
 await this.updatePhase('NIGHT_START',1);
},

async updatePhase(phase,round=null){
 const updates={phase};
 if(round!==null)updates.round=round;
 await db.ref(`games/${this.gameId}/state`).update(updates);
 if(phase==='NIGHT_START') await db.ref(`games/${this.gameId}`).update({nightActions:{},wolfVotes:{},actionCompleted:{}});
},

triggerAction(action){
 this.updatePhase(action);
 this.dom.actionFeedback.innerHTML=`<div class="action-waiting"><p>等待玩家 [${action.replace('_ACTION','').toLowerCase()}] 行动...</p></div>`;
},

renderHostPlayers(reveal){
 let html='';
 const isDay = this.gameState.phase === 'DAY';
 for(const id in this.allPlayers){
  const p=this.allPlayers[id];
  const lives=2-p.deaths;
  const hearts=`<span class="life-heart ${lives<1?'lost':''}">❤</span><span class="life-heart ${lives<2?'lost':''}">❤</span>`;
  let identitiesStr='';
  if(reveal){
   const fmt=i=>i.isThiefCopy?`<span class="thief-copy">${i.role}</span>`:i.role;
   identitiesStr=` [${fmt(p.originalIdentities[0])} + ${fmt(p.originalIdentities[1])}]`;
  }
  let statusClass=p.isAlive?'':'dead-all';
  let voteBtnHtml=`<button onclick="App.kill(${id},'VOTE')" ${!p.isAlive || !isDay || p.isExposedIdiot ? 'disabled' : ''}>票出</button>`;
  if(p.isExposedIdiot) {
      identitiesStr += ' <span style="color:var(--neutral)">(白痴已翻牌)</span>';
  }
  html+=`<div class="player-list-item ${statusClass}">
           <span><strong>${id}号</strong>${identitiesStr}</span>
           <div><span class="player-lives" style="margin-right: 15px;">${hearts}</span>
           ${voteBtnHtml}
           </div></div>`;
 }
 this.dom.hostPlayerList.innerHTML=html;
},

async processNightResults(){
 const snap=await db.ref(`games/${this.gameId}`).once('value');const g=snap.val();
 const na=g.nightActions||{};
 let deathsThisNight=[],messages=[];
 
 if(na.wolfKill){
  const targetId=na.wolfKill;
  const isGuarded=na.guard==targetId;
  const isCured=na.witchCure==true;
  if((isGuarded&&isCured)||(!isGuarded&&!isCured)){
   deathsThisNight.push({id:targetId,cause:'NIGHT'});
   messages.push(`${targetId}号玩家被狼人杀害。`);
  } else {
   messages.push(`${targetId}号玩家被狼人攻击，但存活了下来。`);
  }
 } else {
  messages.push('狼人昨晚没有选择目标。');
 }
 
 if(na.witchPoison){
  deathsThisNight.push({id:na.witchPoison,cause:'POISON'});
  messages.push(`${na.witchPoison}号玩家被女巫毒杀。`);
 }
 
 if(deathsThisNight.length===0){
  messages=['昨晚是平安夜。'];
  await db.ref(`games/${this.gameId}/state/peaceNightStreak`).transaction(s=>s+1);
 } else {
  await db.ref(`games/${this.gameId}/state/peaceNightStreak`).set(0);
 }
 
 this.dom.nightResult.innerHTML=`<h3>夜晚结果</h3><p>${messages.join('<br>')}</p>`;
 this.dom.nightResult.classList.remove('hidden');

 for(const death of deathsThisNight){
   await this.kill(death.id,death.cause,g.players);
 }

 const gameStillOn = await this.checkVictory();
 if(gameStillOn){
    const currentRound = g.state.round;
    this.updatePhase('DAY',currentRound+1);
 }
},

/* =========================================================
   3.3  玩家端逻辑
   ========================================================= */
initPlayer(){
 this.dom.pidShow.textContent=`你是 ${this.playerId} 号`;
 db.ref(`games/${this.gameId}`).on('value',snap=>{
  if(!snap.exists()){this.dom.playerStatus.textContent='游戏已结束或不存在。';return;}
  const g=snap.val();
  this.gameState=g.state;this.allPlayers=g.players;this.playerData=g.players[this.playerId];
  if(this.gameState.phase!=='WOLF_ACTION')this.stopWolfListeners();
  this.renderPlayerView();
 });
 this.dom.btnSwap.onclick=()=>this.swapIdentities();
 this.dom.btnConfirm.onclick=()=>this.confirmIdentities();
},

/* ---------- 3.3.1 渲染与更新 ---------- */
renderPlayerView(){
 this.renderMyIdentities();
 this.renderPlayerStatus();
 this.renderPlayerList();
 this.renderPersistentInfo();
 this.renderActionPanel();
 
 const showSwap=this.gameState.phase==='SETUP'&&!this.playerData.isReady;
 this.dom.swapArea.classList[showSwap?'remove':'add']('hidden');

 if(this.gameState.phase==='GAME_OVER'){
    this.dom.gameTitle.innerHTML = `<div class="game-over-banner ${this.gameState.winner.includes('狼人') ? 'bad' : ''}">${this.gameState.winner}</div>`;
 }
},
renderMyIdentities(){
 const ids=this.playerData.identities;
 const fmt=i=>i.role?(i.isThiefCopy?`<span class="thief-copy">${i.role}</span>`:i.role):i;
 const d=this.playerData.deaths;
 const html=`${d>=1?'<span class="dead-identity">':''}${fmt(ids[0])}${d>=1?'</span>':''}
             + ${d>=2?'<span class="dead-identity">':''}${fmt(ids[1])}${d>=2?'</span>':''}`;
 this.dom.myIds.innerHTML=`<div>${html}</div>`;
},
renderPlayerStatus(){
 const phaseMap={
  SETUP:'等待所有玩家准备',NIGHT_START:'天黑请闭眼...',
  WOLF_ACTION:'狼人行动',WITCH_ACTION:'女巫行动',SEER_ACTION:'预言家行动',GUARD_ACTION:'守卫行动',
  KNIGHT_ACTION: '骑士行动', HUNTER_ACTION: '猎人行动',
  DAY:`第 ${this.gameState.round} 天 - 发言/投票阶段`,
  GAME_OVER:`游戏结束 - ${this.gameState.winner||''}`
 };
 this.dom.playerStatus.textContent=phaseMap[this.gameState.phase]||'游戏中...';
},
renderPlayerList(){
 let html='';
 Object.values(this.allPlayers).forEach(p=>{
  const lives=2-p.deaths;
  const hearts=`<span class="life-heart ${lives<1?'lost':''}">❤</span><span class="life-heart ${lives<2?'lost':''}">❤</span>`;
  let statusClass = !p.isAlive ? 'dead-all' : (p.deaths > 0 ? 'dead' : '');
  let statusText = p.isExposedIdiot ? '(已翻牌)' : (p.isAlive ? '存活' : '出局');
  html+=`<div class="player-list-item ${statusClass}">
          <span class="player-name"><strong>${p.id}号玩家</strong> <small>${statusText}</small></span>
          <span>${hearts}</span>
          </div>`;
 });
 this.dom.playerList.innerHTML=html;
},
renderPersistentInfo(){
 let html='';
 if(this.canSeeWolfChat()){
  const mates=Object.values(this.allPlayers).filter(p=>{
   if(p.id==this.playerId||!p.isAlive)return false;
   const pRole=this.getActiveRole(p);
   return ['狼人','隐狼'].includes(pRole);
  }).map(p=>`${p.id}号`).join('、');
  html+=`<div><strong>狼队友:</strong> ${mates||'无'}</div>`;
 }
 if(this.getActiveRole(this.playerData)==='预言家'){
  const res=this.playerData.seerResults||{};
  const list=Object.entries(res).map(([id,r])=>`${id}号(${r})`).join('； ');
  if(list)html+=`<div><strong>查验历史:</strong> ${list}</div>`;
 }
 if(html){this.dom.persist.innerHTML=html;this.dom.persist.classList.remove('hidden')}
 else this.dom.persist.classList.add('hidden');
},

/* ---------- 3.3.2 身份与行动权判断 ---------- */
getActiveRole(player){
 if(!player.isAlive)return null;
 return player.identities[player.deaths].role;
},
canSeeWolfChat(){
 const r=this.getActiveRole(this.playerData);
 return r==='狼人'||r==='隐狼';
},
canPerformAction(phase){
 if(!this.playerData.isAlive)return false;
 const r=this.getActiveRole(this.playerData);
 const phaseMap={
  WOLF_ACTION:['狼人','隐狼'],SEER_ACTION:['预言家'],GUARD_ACTION:['守卫'],WITCH_ACTION:['女巫'],
  KNIGHT_ACTION:['骑士'],HUNTER_ACTION:['猎人']
 };
 if(!phaseMap[phase]?.includes(r))return false;
 if(phase==='WOLF_ACTION'&&r==='隐狼'){
  const otherWolfExists=Object.values(this.allPlayers).some(p=>p.isAlive&&p.id!=this.playerId&&this.getActiveRole(p)==='狼人');
  return !otherWolfExists;
 }
 return true;
},
hasRoleInPair(roleName){
 return this.playerData.originalIdentities.some(id=>id.role===roleName);
},

/* ---------- 3.3.3 各角色行动面板 ---------- */
renderActionPanel(){
 const phase=this.gameState.phase;
 this.dom.actionPanel.innerHTML='';
 if(!this.playerData.isAlive && phase !== 'HUNTER_ACTION') return;

 switch(phase){
  case 'DAY': return this.getActiveRole(this.playerData)==='骑士'?this.renderKnightPanel():'';
  case 'WOLF_ACTION': return this.canPerformAction('WOLF_ACTION')?this.renderWolfPanel():this.renderWaitingPanel(phase);
  case 'SEER_ACTION': return this.canPerformAction('SEER_ACTION')?this.renderSeerPanel():this.renderWaitingPanel(phase);
  case 'GUARD_ACTION': return this.canPerformAction('GUARD_ACTION')?this.renderGuardPanel():this.renderWaitingPanel(phase);
  case 'WITCH_ACTION': return this.canPerformAction('WITCH_ACTION')?this.renderWitchPanel():this.renderWaitingPanel(phase);
  case 'HUNTER_ACTION': return this.hasRoleInPair('猎人') ? this.renderHunterPanel() : ''; 
 }
},
renderWaitingPanel(phase){
 let msg = '等待其他玩家行动...';
 if(this.hasRoleInPair(phase.replace('_ACTION',''))) msg = '此阶段你无法行动或已行动。';
 this.dom.actionPanel.innerHTML = `<div class="action-feedback"><p>${msg}</p></div>`;
},
swapIdentities(){
 const [id1,id2]=this.playerData.identities;
 db.ref(`games/${this.gameId}/players/${this.playerId}/identities`).set([id2,id1]);
},
confirmIdentities(){
 if(this.playerData.isReady)return;
 if(!confirm('确定锁定身份顺序？锁定后将无法更改。'))return;
 db.ref(`games/${this.gameId}/players/${this.playerId}/isReady`).set(true);
},

renderWolfPanel(){
 this.initWolfChat();
 const myVote=(this.allPlayers[this.playerId] || {}).wolfVote;
 const btns=Object.values(this.allPlayers).filter(p=>p.isAlive).map(p=>
  `<button class="action-btn ${myVote==p.id?'selected':''}" data-id="${p.id}">${p.id}号</button>`).join('');
 this.dom.actionPanel.innerHTML=`<h3>选择击杀目标</h3><div>${btns}</div>`;
 document.querySelectorAll('.action-btn').forEach(b=>b.onclick=()=>this.submitWolfVote(b.dataset.id));
},
submitWolfVote(targetId){
 db.ref(`games/${this.gameId}/players/${this.playerId}/wolfVote`).set(targetId);
 db.ref(`games/${this.gameId}/wolfVotes/${this.playerId}`).set(targetId);
},
initWolfChat(){
 if(this.wolfChatListener)return;
 this.dom.wolfChatArea.classList.remove('hidden');
 this.dom.wolfChatArea.innerHTML=`<div class="wolf-chat-box"><h3>狼人频道</h3>
   <div id="wolf-chat"></div>
   <div><input id="wolf-input" placeholder="输入消息..."><button id="wolf-send">发送</button></div>
   <div id="wolf-votes-summary"></div></div>`;
 
 this.wolfChatListener=db.ref(`games/${this.gameId}/wolfChat`).on('value',s=>this.updateWolfChat(s.val()));
 this.wolfVotesListener=db.ref(`games/${this.gameId}/wolfVotes`).on('value',s=>this.updateWolfVotes(s.val()));
 
 this.$('wolf-send').onclick=()=>{
  const input=this.$('wolf-input'); if(!input.value.trim())return;
  db.ref(`games/${this.gameId}/wolfChat`).push({senderId:this.playerId,text:input.value.trim(),timestamp:firebase.database.ServerValue.TIMESTAMP});
  input.value='';
 };
},
updateWolfChat(chatData){
 const node=this.$('wolf-chat');if(!node)return;
 const msgs=Object.values(chatData||{}).sort((a,b)=>a.timestamp-b.timestamp);
 node.innerHTML=msgs.map(m=>`<div><strong>${m.senderId}号:</strong> ${m.text}</div>`).join('');
 node.scrollTop=node.scrollHeight;
},
updateWolfVotes(votesData){
 this.renderWolfPanel();
 const summary=this.$('wolf-votes-summary');if(!summary)return;
 const votes=votesData||{};
 const counts={};
 Object.values(votes).forEach(v=>{counts[v]=(counts[v]||0)+1;});
 const consensusReached = this.checkWolfConsensus(votes);
 let summaryHtml = '<h4>投票情况:</h4>' + Object.entries(counts).map(([t,c])=>`<p>${t}号: ${c}票</p>`).join('');
 if(consensusReached) summaryHtml += '<p style="color:var(--good)">已达成共识!</p>';
 summary.innerHTML = summaryHtml;
},
checkWolfConsensus(votes){
 const actingWolves=Object.values(this.allPlayers).filter(p=>this.canPerformAction('WOLF_ACTION')&&p.isAlive);
 if(actingWolves.length===0) return false;
 const votedWolves=actingWolves.filter(p=>votes[p.id]);
 if(votedWolves.length<actingWolves.length) return false;
 
 const firstVote=votes[actingWolves[0].id];
 if(actingWolves.every(p=>votes[p.id]===firstVote)){
  db.ref(`games/${this.gameId}/nightActions/wolfKill`).set(firstVote);
  return true; // Consensus reached
 }
 return false;
},
stopWolfListeners(){
 if(this.wolfChatListener)db.ref(`games/${this.gameId}/wolfChat`).off('value',this.wolfChatListener);
 if(this.wolfVotesListener)db.ref(`games/${this.gameId}/wolfVotes`).off('value',this.wolfVotesListener);
 this.wolfChatListener=null;this.wolfVotesListener=null;
 this.dom.wolfChatArea.classList.add('hidden');
},

renderSeerPanel(){
 const btns=Object.values(this.allPlayers).filter(p=>p.id!=this.playerId)
  .map(p=>`<button class="action-btn" data-id="${p.id}">${p.id}号</button>`).join('');
 this.dom.actionPanel.innerHTML=`<h3>请选择查验目标</h3><div>${btns}</div>`;
 document.querySelectorAll('.action-btn').forEach(b=>b.onclick=()=>this.seerCheck(b.dataset.id));
},
async seerCheck(targetId){
 const targetPlayer=this.allPlayers[targetId];
 const roles=targetPlayer.originalIdentities.map(i=>ROLES[i.role]);
 let result='好人';
 if(roles.some(r=>r.faction==='bad'&&!r.isInvisible)){ result='狼人';
 } else if(roles.some(r=>r.faction==='bad'&&r.isInvisible)){
  const otherWolvesExist=Object.values(this.allPlayers).some(p=>p.id!=targetId&&p.isAlive&&p.originalIdentities.some(i=>ROLES[i.role].faction==='bad'));
  result=otherWolvesExist?'好人':'狼人';
 }
 await db.ref(`games/${this.gameId}/players/${this.playerId}/seerResults/${targetId}`).set(result);
 this.dom.actionPanel.innerHTML=`<div class="action-feedback"><p>查验结果: ${targetId}号是 <strong>${result}</strong></p></div>`;
},

renderGuardPanel(){
 const lastTarget=this.playerData.lastGuardTarget;
 const btns=Object.values(this.allPlayers).filter(p=>p.isAlive)
  .map(p=>`<button class="action-btn" data-id="${p.id}" ${p.id==lastTarget?'disabled':''}>${p.id}号 ${p.id==lastTarget?'(上轮已守)':''}</button>`).join('');
 this.dom.actionPanel.innerHTML=`<h3>请选择守护目标</h3><div>${btns}</div>`;
 document.querySelectorAll('.action-btn').forEach(b=>b.onclick=()=>this.guardProtect(b.dataset.id));
},
async guardProtect(targetId){
 await db.ref(`games/${this.gameId}/nightActions/guard`).set(targetId);
 await db.ref(`games/${this.gameId}/players/${this.playerId}/lastGuardTarget`).set(targetId);
 this.dom.actionPanel.innerHTML=`<div class="action-feedback"><p>已守护 ${targetId}号。</p></div>`;
},

async renderWitchPanel(){
 let html='<h3>女巫行动</h3>';
 const canUseCure=!this.playerData.hasUsedCure;
 const canUsePoison=!this.playerData.hasUsedPoison;
 html+=`<p>解药: ${canUseCure?'✓':'×'} | 毒药: ${canUsePoison?'✓':'×'}</p>`;
 
 const snap = await db.ref(`games/${this.gameId}/nightActions/wolfKill`).once('value');
 const wolfTarget = snap.val();
 
 if(canUseCure&&wolfTarget){
    let cureDisabled = (this.gameState.round === 1 && wolfTarget == this.playerId);
    html += `<button id="btn-cure" class="action-btn" ${cureDisabled ? 'disabled' : ''}>使用解药 (救${wolfTarget}号)</button> ${cureDisabled ? '(首夜不可自救)' : ''}`;
 }
 if(canUsePoison){
  const list=Object.values(this.allPlayers).filter(p=>p.isAlive).map(p=>`<button class="action-btn" data-id="${p.id}">${p.id}号</button>`).join('');
  html+='<h4>使用毒药</h4>'+list;
 }
 html+='<button id="btn-pass" class="control-btn">跳过</button>';
 this.dom.actionPanel.innerHTML=html;

 if(this.$('btn-cure')) this.$('btn-cure').onclick=()=>this.useWitchDrug('cure');
 document.querySelectorAll('.action-btn[data-id]').forEach(b=>b.onclick=()=>this.useWitchDrug('poison',b.dataset.id));
 this.$('btn-pass').onclick=()=>this.useWitchDrug('skip');
},
async useWitchDrug(type,targetId=null){
 let updates={}, msg='';
 if(type==='cure'){
    updates[`players/${this.playerId}/hasUsedCure`]=true;
    updates['nightActions/witchCure']=true;
    msg='你使用了珍贵的解药。';
 } else if(type==='poison'){
    updates[`players/${this.playerId}/hasUsedPoison`]=true;
    updates['nightActions/witchPoison']=targetId;
    msg=`你对 ${targetId}号 使用了毒药。`;
 } else {
    msg='你选择本回合不使用药剂。';
 }
 await db.ref(`games/${this.gameId}`).update(updates);
 this.dom.actionPanel.innerHTML=`<div class="action-feedback"><p>${msg}</p></div>`;
},

renderKnightPanel(){
 const btns=Object.values(this.allPlayers).filter(p=>p.isAlive&&p.id!=this.playerId)
  .map(p=>`<button class="action-btn" data-id="${p.id}">${p.id}号</button>`).join('');
 this.dom.actionPanel.innerHTML=`<h3>骑士技能：决斗</h3><p>选择一名玩家进行决斗。如果他是狼人阵营，他死亡，游戏进入黑夜；否则，你死亡。</p><div>${btns}</div>`;
 document.querySelectorAll('.action-btn').forEach(b=>b.onclick=()=>this.knightDuel(b.dataset.id));
},
async knightDuel(targetId){
 if(!confirm(`确定要与 ${targetId}号 决斗吗？`)) return;
 const targetPlayer=this.allPlayers[targetId];
 const isBadFaction=targetPlayer.originalIdentities.some(i=>ROLES[i.role].faction==='bad');
 
 if(isBadFaction){
    await this.kill(targetId,'DUEL');
    await this.updatePhase('NIGHT_START');
 } else {
    await this.kill(this.playerId,'DUEL');
 }
 this.dom.actionPanel.innerHTML=`<div class="action-feedback"><p>决斗已完成。</p></div>`;
},

renderHunterPanel(){
 if(!this.playerData.isAlive) { 
    const btns=Object.values(this.allPlayers).filter(p=>p.id!=this.playerId)
      .map(p=>`<button class="action-btn" data-id="${p.id}" ${!p.isAlive?'disabled':''}>${p.id}号</button>`).join('');
    this.dom.actionPanel.innerHTML=`<h3>猎人技能：开枪</h3><p>你已出局，请选择一名玩家带走。</p><div>${btns}</div>
        <button id="hunter-skip" class="control-btn">放弃开枪</button>`;
    document.querySelectorAll('.action-btn[data-id]').forEach(b=>b.onclick=()=>this.hunterShoot(b.dataset.id));
    this.$('hunter-skip').onclick=()=>this.hunterShoot(null);
 }
},
async hunterShoot(targetId){
 if(targetId && !confirm(`确定要带走 ${targetId}号 吗？`)) return;
 if(targetId) await this.kill(targetId,'SHOT');
 await this.updatePhase('DAY');
 this.dom.actionPanel.innerHTML=`<div class="action-feedback"><p>猎人行动结束。</p></div>`;
},

/* =========================================================
   3.4  核心游戏流程 (击杀、结算)
   ========================================================= */
async kill(playerId, cause, playersSnapshot = null){
 const players = playersSnapshot || (await db.ref(`games/${this.gameId}/players`).once('value')).val();
 const player = players[playerId];
 if(!player||!player.isAlive)return;

 if(this.getActiveRole(player)==='白痴' && cause==='VOTE'){
  await db.ref(`games/${this.gameId}/players/${playerId}`).update({isExposedIdiot:true});
  await this.checkVictory();
  return;
 }
 
 const updates={};
 const newDeaths=player.deaths+1;
 const isNowDead = newDeaths >= 2;
 updates[`players/${playerId}/deaths`]=newDeaths;
 updates[`players/${playerId}/isAlive`]=!isNowDead;
 await db.ref(`games/${this.gameId}`).update(updates);

 if(isNowDead && this.hasRoleInPair.call({playerData:player}, '猎人') && cause !== 'POISON'){
    await this.updatePhase('HUNTER_ACTION');
 } else {
    await this.checkVictory();
 }
},


/* =========================================================
   3.5  胜负判定
   ========================================================= */
async checkVictory(){
 const snap=await db.ref(`games/${this.gameId}`).once('value');
 const g=snap.val();
 if(g.state.phase==='GAME_OVER')return false;

 let wolvesAlive=0,godsAlive=0,goldenBabiesAlive=0;
 Object.values(g.players).forEach(p=>{
  if(!p.isAlive)return;
  const roles=p.originalIdentities.map(i=>ROLES[i.role]);
  const isGoldenBaby=roles[0].name==='平民'&&roles[1].name==='平民';
  const isGoodFaction=roles.every(r=>r.faction==='good');
  
  if(isGoldenBaby) goldenBabiesAlive++;
  if(isGoodFaction&&!isGoldenBaby) godsAlive++;
  if(roles.some(r=>r.faction==='bad')) wolvesAlive++;
 });

 let winner=null;
 if(wolvesAlive===0) winner='好人胜利 (狼人全灭)';
 else if(g.state.peaceNightStreak>=3) winner='好人胜利 (连续三晚平安夜)';
 else if(godsAlive===0) winner='狼人胜利 (神职全灭)';
 else if(goldenBabiesAlive===0) winner='狼人胜利 (金宝宝全灭)';
 
 if(winner){
  await db.ref(`games/${this.gameId}/state`).update({phase:'GAME_OVER',winner});
  return false;
 }
 return true;
}
};

/* ===================== 启动入口 ===================== */
document.addEventListener('DOMContentLoaded',()=>App.init());
</script>
</body>
</html>
