<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>åŒèº«ä»½ç‹¼äººæ€ - ç”µå­æ³•å®˜</title>

<style>
:root{--bg:#1a1a2e;--card:#16213e;--border:#0f3460;--accent:#e94560;
--text:#eaeaea;--success:#00d9ff;--danger:#ff006e;--warning:#ffb700;
--gradient:linear-gradient(135deg,#667eea 0%,#764ba2 100%);--shadow:0 10px 30px rgba(0,0,0,.3);
--font-main:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:var(--font-main);line-height:1.6;min-height:100vh}
body{display:flex;justify-content:center;align-items:flex-start;padding:20px;background-image:
 radial-gradient(circle at 20% 50%,rgba(233,69,96,.1)0%,transparent 50%),
 radial-gradient(circle at 80% 80%,rgba(0,217,255,.1)0%,transparent 50%)}
#app{width:100%;max-width:900px;background:var(--card);border-radius:20px;padding:30px;box-shadow:var(--shadow);border:1px solid var(--border);animation:fadeIn .5s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
h1,h2,h3{color:var(--text);margin-bottom:20px;text-align:center;letter-spacing:1px}
h1{background:var(--gradient);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-size:2em;margin-bottom:30px}
h2{color:var(--success);font-size:1.5em;border-bottom:2px solid var(--border);padding-bottom:10px}
h3{color:var(--warning);font-size:1.2em}
hr{border:none;border-top:2px solid var(--border);margin:30px 0}
.hidden{display:none!important}
button{background:var(--accent);color:#fff;border:none;padding:12px 24px;border-radius:12px;cursor:pointer;font-size:16px;font-weight:600;margin:5px;transition:.3s all;position:relative;overflow:hidden}
button::before{content:'';position:absolute;top:50%;left:50%;width:0;height:0;background:rgba(255,255,255,.2);border-radius:50%;transform:translate(-50%,-50%);transition:width .6s,height .6s}
button:hover::before{width:300px;height:300px}
button:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 5px 20px rgba(233,69,96,.4)}
button:disabled{background:#4a4a4a;cursor:not-allowed;opacity:.6}
button.selected{background:var(--success)!important;box-shadow:0 5px 20px rgba(0,217,255,.4)}
button.control-btn{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)}
button.action-btn{background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%)}
button.confirm-btn{background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%)}
input[type=number],input[type=text]{width:80px;padding:10px;border-radius:10px;border:2px solid var(--border);background:rgba(255,255,255,.05);color:var(--text);font-size:16px;text-align:center;transition:.3s all}
input:focus{outline:none;border-color:var(--accent);background:rgba(255,255,255,.1)}
.role-setup-item{display:flex;justify-content:space-between;align-items:center;padding:15px;margin:10px 0;background:rgba(255,255,255,.03);border-radius:12px;transition:.3s all;border:1px solid transparent}
.role-setup-item:hover{background:rgba(255,255,255,.05);border-color:var(--border)}
.player-list-item{display:flex;justify-content:space-between;align-items:center;padding:15px 20px;margin:12px 0;background:rgba(255,255,255,.05);border-radius:15px;transition:.3s all;border:2px solid transparent}
.player-list-item:hover{border-color:var(--accent);transform:translateX(5px)}
.player-list-item.dead{opacity:.7;background:rgba(255,0,110,.1)}
.player-list-item.dead-all{opacity:.4;background:rgba(100,100,100,.1);text-decoration:line-through}
.life-heart{color:var(--danger);font-size:24px;transition:.3s all;text-shadow:0 0 10px rgba(255,0,110,.5)}
.life-heart.lost{color:#555;text-shadow:none}
.thief-copy{color:#888;font-style:italic;font-size:.9em}
.dead-identity{text-decoration:line-through;opacity:.6}
.action-panel,.action-feedback{margin-top:25px;padding:20px;background:rgba(255,255,255,.03);border-radius:15px;text-align:center;border:1px solid var(--border)}
.wolf-chat-box{padding:20px;background:rgba(233,69,96,.1);border-radius:15px;margin-top:20px;border:1px solid rgba(233,69,96,.3)}
#wolf-chat{height:180px;overflow-y:auto;border:1px solid var(--border);padding:15px;border-radius:10px;margin-bottom:15px;background:rgba(0,0,0,.3)}
#wolf-chat::-webkit-scrollbar{width:8px}
#wolf-chat::-webkit-scrollbar-track{background:rgba(255,255,255,.1);border-radius:10px}
#wolf-chat::-webkit-scrollbar-thumb{background:var(--accent);border-radius:10px}
#wolf-input{width:calc(100% - 100px);margin-right:10px;padding:12px;border-radius:10px;border:2px solid var(--border);background:rgba(255,255,255,.05);color:var(--text)}
.vote-msg{color:var(--warning);font-weight:600}
.game-over-banner{padding:40px;text-align:center;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border-radius:20px;font-size:28px;font-weight:bold;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
.game-over-banner.bad{background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%)}
details summary{cursor:pointer;font-weight:bold;color:var(--warning);padding:10px;transition:.3s all}
details summary:hover{color:var(--success)}
.role-icon{display:inline-block;width:30px;height:30px;margin-right:10px;text-align:center;line-height:30px;border-radius:50%;background:rgba(255,255,255,.1)}
.loading-spinner{display:inline-block;width:20px;height:20px;border:3px solid rgba(255,255,255,.3);border-radius:50%;border-top-color:var(--accent);animation:spin 1s infinite ease-in-out}
@keyframes spin{to{transform:rotate(360deg)}}
.identity-card{background:rgba(255,255,255,.05);padding:20px;border-radius:15px;margin:10px 0;border:2px solid var(--border);transition:.3s all}
.identity-card:hover{transform:translateY(-2px);box-shadow:0 5px 20px rgba(0,0,0,.3)}
.action-status{padding:15px;background:rgba(255,255,255,.05);border-radius:12px;margin:15px 0}
#host-controls {text-align: center; margin: 20px 0; background: rgba(0,217,255,0.1); padding: 15px; border-radius: 15px; border: 1px solid var(--success);}
#night-status-board {display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 15px;}
.status-item {background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px;}
@media(max-width:600px){#app{padding:20px}h1{font-size:1.5em}button{padding:10px 16px;font-size:14px}}
</style>
</head>
<body>
<div id="app">
  <div id="view-container">
    <h1 id="game-title">ğŸŒ™ åŒèº«ä»½ç‹¼äººæ€</h1>

    <div id="setup-view">
        <h2>ğŸ“‹ èº«ä»½é…ç½®</h2>
        <div id="role-setup"></div>
        <p style="text-align:center;font-size:18px;">
            <span style="color:var(--warning)">æ€»èº«ä»½æ•°: <strong id="total-roles">0</strong></span> |
            <span style="color:var(--success)">é¢„è®¡ç©å®¶æ•°: <strong id="player-cnt">0</strong></span>
        </p>
        <div style="text-align:center;margin-top:20px;">
            <button id="btn-create" class="control-btn">
            <span id="create-text">åˆ›å»ºæ¸¸æˆ</span>
            <span id="create-spinner" class="loading-spinner hidden"></span>
            </button>
        </div>
    </div>

    <div id="game-view" class="hidden">
        <div id="player-info">
            <h2 id="pid-show"></h2>
            <h3>ä½ çš„èº«ä»½æ˜¯:</h3>
            <div id="my-ids" class="identity-card"></div>
            <div id="swap-area" class="hidden">
                <p style="text-align:center;color:var(--warning)">æ¸¸æˆå¼€å§‹å‰ï¼Œä½ å¯ä»¥äº¤æ¢ä¸¤ä¸ªèº«ä»½çš„é¡ºåºã€‚</p>
                <div style="text-align:center;">
                    <button id="btn-swap" class="action-btn">ğŸ”„ äº¤æ¢é¡ºåº</button>
                    <button id="btn-confirm" class="confirm-btn">âœ… ç¡®å®šèº«ä»½é¡ºåº</button>
                </div>
            </div>
        </div>
        <hr>
        <div id="game-area">
            <div id="player-status" style="text-align:center;font-size:20px;font-weight:bold;padding:15px;background:rgba(255,255,255,.05);border-radius:15px;margin-bottom:20px;">ç­‰å¾…æ¸¸æˆå¼€å§‹...</div>
            <div id="host-controls" class="hidden"></div>
            <div id="persist" class="hidden"></div>
            <div id="action-panel"></div>
            <div id="wolf-chat-area" class="hidden"></div>
            <h3>ğŸ‘¥ ç©å®¶åˆ—è¡¨</h3>
            <div id="player-list"></div>
        </div>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
/* ==========================================================
   åŒèº«ä»½ç‹¼äººæ€ - 2025-07-02 è‡ªåŠ¨åŒ–æµç¨‹æœ€ç»ˆä¿®å¤ç‰ˆ
   ========================================================== */

const firebaseConfig={apiKey:"AIzaSyCEAgB6DoY8YA6lZnYblhIDVTYH_q8UimI",authDomain:"werewolf-game-master-1f37f.firebaseapp.com",databaseURL:"https://werewolf-game-master-1f37f-default-rtdb.asia-southeast1.firebasedatabase.app",projectId:"werewolf-game-master-1f37f",storageBucket:"werewolf-game-master-1f37f.appspot.com",messagingSenderId:"626014452910",appId:"1:626014452910:web:35b6eba412f95f1878013f"};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

const ROLES={'å¹³æ°‘':{name:'å¹³æ°‘',faction:'good',isGod:false,icon:'ğŸ‘¤'},'å®ˆå«':{name:'å®ˆå«',faction:'good',isGod:true,icon:'ğŸ›¡ï¸'},'ç™½ç—´':{name:'ç™½ç—´',faction:'good',isGod:true,icon:'ğŸ¤ª'},'é¢„è¨€å®¶':{name:'é¢„è¨€å®¶',faction:'good',isGod:true,icon:'ğŸ”®'},'éª‘å£«':{name:'éª‘å£«',faction:'good',isGod:true,icon:'âš”ï¸'},'éšç‹¼':{name:'éšç‹¼',faction:'bad',isGod:false,isInvisible:true,icon:'ğŸŒ‘'},'å¥³å·«':{name:'å¥³å·«',faction:'good',isGod:true,icon:'ğŸ§ª'},'çŒäºº':{name:'çŒäºº',faction:'good',isGod:true,icon:'ğŸ”«'},'ç‹¼äºº':{name:'ç‹¼äºº',faction:'bad',isGod:false,icon:'ğŸº'},'ç›—è´¼':{name:'ç›—è´¼',faction:'neutral',isGod:false,isThief:true,icon:'ğŸ­'}};
const DEFAULT_SETUP={'å¹³æ°‘':6,'å®ˆå«':1,'ç™½ç—´':1,'é¢„è¨€å®¶':1,'éª‘å£«':1,'å¥³å·«':1,'çŒäºº':1,'ç‹¼äºº':2,'éšç‹¼':1,'ç›—è´¼':1};
const FORBIDDEN_RAW=[['é¢„è¨€å®¶','ç‹¼äºº'],['é¢„è¨€å®¶','éšç‹¼'],['ç›—è´¼','ç‹¼äºº'],['ç›—è´¼','éšç‹¼'],['éšç‹¼','ç‹¼äºº'],['éšç‹¼','éšç‹¼']];

const App={
gameId:null,playerId:null,isHost:false,gameState:null,allPlayers:{},playerData:null,wolfChatListener:null,wolfVotesListener:null,
$(id){return document.getElementById(id)},
init(){const q=new URLSearchParams(location.search);this.gameId=q.get('game');this.playerId=q.get('player');if(this.gameId&&this.playerId){this.showView('game');this.listenToGameChanges()}else{this.showView('setup');this.renderRoleSetup();this.$('btn-create').onclick=()=>this.createGame()}},
showView(v){this.$('setup-view').classList.add('hidden');this.$('game-view').classList.add('hidden');this.$(v+'-view').classList.remove('hidden')},
renderRoleSetup(){let h='';for(const r in DEFAULT_SETUP){h+=`<div class="role-setup-item"><span><span class="role-icon">${ROLES[r].icon}</span>${r}</span><input type="number" id="role-${r}" min="0" value="${DEFAULT_SETUP[r]}"></div>`}this.$('role-setup').innerHTML=h;const u=()=>{let t=0;this.$('role-setup').querySelectorAll('input').forEach(i=>t+=+i.value||0);this.$('total-roles').textContent=t;this.$('player-cnt').textContent=t%2===0?t/2:'å¶æ•°'};this.$('role-setup').oninput=u;u()},
async createGame(){this.$('btn-create').disabled=true;this.$('create-text').classList.add('hidden');this.$('create-spinner').classList.remove('hidden');const p=[];this.$('role-setup').querySelectorAll('input').forEach(i=>{const r=i.id.replace('role-','');for(let k=0;k<+i.value;k++)p.push(r)});if(p.length===0||p.length%2){alert('èº«ä»½æ•°éœ€ä¸ºå¶æ•°ä¸”>0');location.reload();return}const pairs=this.deal(p);if(!pairs){alert('æ— æ³•ç”Ÿæˆåˆæ³•ç‰Œç»„');location.reload();return}const gId=db.ref('games').push().key,pc=p.length/2,players={};for(let i=1;i<=pc;i++)players[i]={id:i,identities:pairs[i-1],originalIdentities:[...pairs[i-1]],deaths:0,isAlive:true,isReady:false,isExposedIdiot:false,skillStates:{}};await db.ref(`games/${gId}`).set({state:{phase:'SETUP',round:0,peaceNightStreak:0,winner:null,creatorId:1},players,config:{pc},wolfChat:{},wolfVotes:{},nightActions:{},nightStatus:{}});location.search=`?game=${gId}&player=1`},
deal(pool){for(let t=0;t<5000;t++){const s=[...pool].sort(()=>.5-Math.random()),rawPairs=[],finalPairs=[];let isValid=true,gold=0;for(let i=0;i<s.length;i+=2)rawPairs.push([s[i],s[i+1]]);for(const p of rawPairs){if(FORBIDDEN_RAW.some(([r1,r2])=>(r1===p[0]&&r2===p[1])||(r1===p[1]&&r2===p[0]))){isValid=false;break}}if(!isValid)continue;for(const p of rawPairs){let p1,p2;if(p[0]==='ç›—è´¼'&&p[1]==='ç›—è´¼'){p1={r:'å¹³æ°‘',t:true};p2={r:'å¹³æ°‘',t:true}}else if(p[0]==='ç›—è´¼'){p1={r:p[1],t:true};p2={r:p[1],t:false}}else if(p[1]==='ç›—è´¼'){p1={r:p[0],t:false};p2={r:p[0],t:true}}else{p1={r:p[0],t:false};p2={r:p[1],t:false}}finalPairs.push([{role:p1.r,isThiefCopy:p1.t},{role:p2.r,isThiefCopy:p2.t}]);if(p1.r==='å¹³æ°‘'&&p2.r==='å¹³æ°‘')gold++}if(gold>=1&&gold<=2)return finalPairs}return null},
listenToGameChanges(){db.ref(`games/${this.gameId}`).on('value',s=>{if(!s.exists()){document.body.innerHTML='<h1>æ¸¸æˆä¸å­˜åœ¨</h1>';return}const g=s.val();this.gameState=g.state;this.allPlayers=g.players;this.playerData=g.players[this.playerId];this.isHost=this.playerData.id==this.gameState.creatorId;if(this.gameState.phase!=='NIGHT')this.stopWolfListeners();this.renderAll()})},
renderAll(){if(!this.playerData)return;this.renderPlayerInfo();this.renderPlayerStatus();this.renderPlayerList();this.renderPersistentInfo();this.renderActionPanel();if(this.isHost)this.renderHostControls()},
renderPlayerInfo(){this.$('pid-show').textContent=`ğŸ® ä½ æ˜¯ ${this.playerId} å·`+(this.isHost?' (ä¸»æŒäºº)':'');const i=this.playerData.identities,d=this.playerData.deaths,f=i=>`${ROLES[i.role].icon} ${i.isThiefCopy?'<span class="thief-copy">'+i.role+'</span>':i.role}`;this.$('my-ids').innerHTML=`<div style="font-size:24px;">${d>=1?'<span class="dead-identity">':''}${f(i[0])}${d>=1?'</span>':''}<span style="margin:0 20px;">+</span>${d>=2?'<span class="dead-identity">':''}${f(i[1])}${d>=2?'</span>':''}</div>`;const show=this.gameState.phase==='SETUP'&&!this.playerData.isReady;this.$('swap-area').classList[show?'remove':'add']('hidden');if(show){this.$('btn-swap').onclick=()=>{const[a,b]=this.playerData.identities;db.ref(`games/${this.gameId}/players/${this.playerId}/identities`).set([b,a])};this.$('btn-confirm').onclick=()=>{if(!this.playerData.isReady)db.ref(`games/${this.gameId}/players/${this.playerId}/isReady`).set(true)}}},
renderPlayerStatus(){const m={SETUP:'â³ ç­‰å¾…å‡†å¤‡',NIGHT:'ğŸŒ™ å¤œæ™šè¡ŒåŠ¨ä¸­...',DAY:`â˜€ï¸ ç¬¬ ${this.gameState.round} å¤©`,GAME_OVER:`ğŸ† ${this.gameState.winner}`};this.$('player-status').innerHTML=m[this.gameState.phase]||'è¿›è¡Œä¸­';if(this.gameState.phase==='GAME_OVER')this.$('game-title').innerHTML=`<div class="game-over-banner ${this.gameState.winner.includes('ç‹¼äºº')?'bad':''}">${this.gameState.winner}</div>`},
renderPlayerList(){let h='';Object.values(this.allPlayers).forEach(p=>{const l=2-p.deaths,heart=`<span class="life-heart ${l<1?'lost':''}">â¤</span><span class="life-heart ${l<2?'lost':''}">â¤</span>`;h+=`<div class="player-list-item ${!p.isAlive?'dead-all':p.deaths?'dead':''}"><span><strong>${p.id}å·</strong> <small>${p.isExposedIdiot?'ğŸ¤ª ç™½ç—´':''}</small></span><span>${heart}</span></div>`});this.$('player-list').innerHTML=h},
renderPersistentInfo(){let h='';if(this.getActiveRole(this.playerData)==='é¢„è¨€å®¶'){const r=this.getSkillState('seerResults')||{},l=Object.entries(r).map(([id,res])=>`${id}å·(${res==='ç‹¼äºº'?'ğŸº':'ğŸ˜‡'})`).join('ã€');if(l)h+=`<div><strong>ğŸ”® æŸ¥éªŒå†å²:</strong> ${l}</div>`}this.$('persist').innerHTML=h;this.$('persist').classList[h?'remove':'add']('hidden')},
renderHostControls(){this.$('host-controls').classList.remove('hidden');const ph=this.gameState.phase,rdy=Object.values(this.allPlayers).filter(p=>p.isReady).length,tot=Object.keys(this.allPlayers).length;let h=`<h3>æ¸¸æˆæ§åˆ¶å™¨</h3>`;if(ph==='SETUP'){h+=`<p>å‡†å¤‡çŠ¶æ€: ${rdy}/${tot}</p><button id="btn-start" class="control-btn" ${rdy<tot?'disabled':''}>ğŸš€ å¼€å§‹æ¸¸æˆ</button>`}else if(ph==='DAY'){h+=`<button id="btn-night" class="control-btn">ğŸŒ™ è¿›å…¥å¤œæ™š</button>`}else if(ph==='NIGHT'){const ns=this.gameState.nightStatus||{},done=Object.values(ns).every(s=>s==='complete');h+=`<button id="btn-day" class="control-btn" ${!done?'disabled':''}>â˜€ï¸ è¿›å…¥ç™½å¤©</button><div id="night-status-board"><div class="status-item">å®ˆå«: ${this.getSymbol(ns.guard)}</div><div class="status-item">é¢„è¨€å®¶: ${this.getSymbol(ns.seer)}</div><div class="status-item">ç‹¼äºº: ${this.getSymbol(ns.wolf)}</div><div class="status-item">å¥³å·«: ${this.getSymbol(ns.witch)}</div></div>`}this.$('host-controls').innerHTML=h;if(this.$('btn-start'))this.$('btn-start').onclick=()=>this.updatePhase('NIGHT',1);if(this.$('btn-night'))this.$('btn-night').onclick=()=>this.updatePhase('NIGHT');if(this.$('btn-day'))this.$('btn-day').onclick=()=>this.processNight()},
getSymbol(s){if(s==='complete')return'âœ…';if(s==='pending')return'â³';return'ğŸ”’'},
async updatePhase(phase,round=null){const up={'state/phase':phase};let cr=this.gameState.round;if(round!==null){up['state/round']=round;cr=round}else if(phase==='NIGHT'){cr=this.gameState.round+1;up['state/round']=cr}if(phase==='NIGHT'){up['nightActions']={};up['wolfVotes']={};up['nightStatus']={guard:'pending',seer:'pending',wolf:'pending',witch:'locked'}}await db.ref(`games/${this.gameId}`).update(up);if(this.isHost&&phase==='NIGHT')this.checkAndAutocompleteRoles()},
checkAndAutocompleteRoles(){const checks={guard:'å®ˆå«',seer:'é¢„è¨€å®¶',wolf:['ç‹¼äºº','éšç‹¼'],witch:'å¥³å·«'};for(const k in checks){let exists=Object.values(this.allPlayers).some(p=>{if(!p.isAlive)return false;const ar=this.getActiveRole(p);return Array.isArray(checks[k])?checks[k].includes(ar):checks[k]===ar});if(k==='wolf'&&exists){exists=Object.values(this.allPlayers).some(p=>this.canWolfAct(p))}if(!exists){const d=10000+Math.random()*10000;setTimeout(()=>{db.ref(`games/${this.gameId}/nightStatus/${k}`).set('complete')},d)}}},
getActiveRole(p){return p.isAlive?p.identities[p.deaths].role:null},
renderActionPanel(){this.$('action-panel').innerHTML='';if(this.gameState.phase!=='NIGHT'||!this.playerData.isAlive)return;const role=this.getActiveRole(this.playerData),nightStatus=this.gameState.nightStatus||{};let acted=false;switch(role){case'å®ˆå«':if(nightStatus.guard==='pending'){this.panelGuard();acted=true}break;case'é¢„è¨€å®¶':if(nightStatus.seer==='pending'){this.panelSeer();acted=true}break;case'ç‹¼äºº':case'éšç‹¼':if(nightStatus.wolf==='pending'&&this.canWolfAct(this.playerData)){this.panelWolf();acted=true}break;case'å¥³å·«':if(nightStatus.witch==='pending'){this.panelWitch();acted=true}break}if(!acted)this.$('action-panel').innerHTML=`<div class="action-feedback"><p>å¤œæ™šè¿›è¡Œä¸­ï¼Œè¯·è€å¿ƒç­‰å¾…...</p></div>`},
canWolfAct(p){const r=this.getActiveRole(p);if(!['ç‹¼äºº','éšç‹¼'].includes(r))return false;if(r==='éšç‹¼'){return!Object.values(this.allPlayers).some(p2=>p2.isAlive&&p2.id!==p.id&&this.getActiveRole(p2)==='ç‹¼äºº')}return true},
getSkillState(key){return(this.playerData.skillStates||{})[`${this.playerData.deaths}_${key}`]},
setSkillState(key,val){return db.ref(`games/${this.gameId}/players/${this.playerId}/skillStates/${this.playerData.deaths}_${key}`).set(val)},
panelWolf(){if(!this.wolfChatListener)this.initWolfChat();const vote=this.playerData.wolfVote,leader=this.playerId==Object.values(this.allPlayers).filter(p=>this.canWolfAct(p)).map(p=>p.id).sort((a,b)=>a-b)[0];const btns=Object.values(this.allPlayers).filter(p=>p.isAlive).map(p=>`<button class="action-btn ${vote==p.id?'selected':''}" data-id="${p.id}">${p.id}å·</button>`).join('');let h=`<h3>ğŸº è¯·é€‰æ‹©å‡»æ€ç›®æ ‡</h3><div>${btns}</div>`;h+=leader?'<div style="margin-top:20px;"><button id="wolf-confirm" class="confirm-btn">âœ… ç¡®å®šå‡»æ€</button></div>':'<p style="margin-top:10px;font-size:14px;">ç­‰å¾…é¢†å¤´ç‹¼ç¡®è®¤</p>';this.$('action-panel').innerHTML=h;document.querySelectorAll('.action-btn').forEach(b=>b.onclick=()=>{db.ref(`games/${this.gameId}/players/${this.playerId}/wolfVote`).set(b.dataset.id)});if(leader&&this.$('wolf-confirm'))this.$('wolf-confirm').onclick=async()=>{const tar=this.playerData.wolfVote;if(!tar)return alert('å…ˆé€‰ç›®æ ‡');await db.ref(`games/${this.gameId}/nightActions/wolfKill`).set(tar);await db.ref(`games/${this.gameId}/nightStatus`).update({wolf:'complete',witch:'pending'})}},
initWolfChat(){this.$('wolf-chat-area').classList.remove('hidden');if(!this.$('wolf-chat'))this.$('wolf-chat-area').innerHTML=`<div class="wolf-chat-box"><h3>ğŸº ç‹¼äººé¢‘é“</h3><div id="wolf-chat"></div><div style="display:flex;gap:10px;"><input id="wolf-input" placeholder="è¾“å…¥æ¶ˆæ¯..." style="flex:1;"><button id="wolf-send" class="action-btn">ğŸ“¤</button></div></div>`;this.wolfChatListener=db.ref(`games/${this.gameId}/wolfChat`).orderByChild('timestamp').on('child_added',s=>{const c=this.$('wolf-chat');c.insertAdjacentHTML('beforeend',`<div><strong>${s.val().senderId}å·:</strong> ${s.val().text}</div>`);c.scrollTop=c.scrollHeight});const btn=this.$('wolf-send'),inp=this.$('wolf-input');const send=()=>{if(!inp.value.trim())return;db.ref(`games/${this.gameId}/wolfChat`).push().set({senderId:this.playerId,text:inp.value.trim(),timestamp:Date.now()});inp.value=''};btn.onclick=send;inp.onkeypress=e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send()}}},
stopWolfListeners(){if(this.wolfChatListener){db.ref(`games/${this.gameId}/wolfChat`).off('child_added',this.wolfChatListener);this.wolfChatListener=null}this.$('wolf-chat-area').classList.add('hidden')},
async panelSeer(){const b=Object.values(this.allPlayers).filter(p=>p.id!=this.playerId).map(p=>`<button class="action-btn" data-id="${p.id}">${p.id}å·</button>`).join('');this.$('action-panel').innerHTML=`<h3>ğŸ”® æŸ¥éªŒ</h3><div>${b}</div><div style="margin-top:15px;"><button id="seer-skip" class="control-btn">â­ï¸ è·³è¿‡</button></div>`;document.querySelectorAll('.action-btn').forEach(btn=>btn.onclick=async()=>{const id=btn.dataset.id,tp=this.allPlayers[id],rolesAliveOfPlayer=p=>p.isAlive?[p.identities[p.deaths].role]:[],targetCardsAlive=rolesAliveOfPlayer(tp),hasInvisWolf=targetCardsAlive.includes('éšç‹¼'),otherAliveBad=Object.values(this.allPlayers).some(p=>p.isAlive&&p.id!=id&&rolesAliveOfPlayer(p).some(r=>ROLES[r].faction==='bad'));let res='å¥½äºº';if(targetCardsAlive.some(r=>ROLES[r].faction==='bad'&&!ROLES[r].isInvisible)|| (hasInvisWolf&&!otherAliveBad))res='ç‹¼äºº';const rs=this.getSkillState('seerResults')||{};rs[id]=res;await this.setSkillState('seerResults',rs);await db.ref(`games/${this.gameId}/nightStatus/seer`).set('complete');this.$('action-panel').innerHTML=`<div class="action-feedback"><p>${id}å·æ˜¯<strong>${res==='ç‹¼äºº'?'ğŸºç‹¼äºº':'ğŸ˜‡å¥½äºº'}</strong></p></div>`});this.$('seer-skip').onclick=()=>db.ref(`games/${this.gameId}/nightStatus/seer`).set('complete')},
async panelGuard(){const last=this.getSkillState('lastGuardTarget'),btns=Object.values(this.allPlayers).filter(p=>p.isAlive).map(p=>`<button class="action-btn" data-id="${p.id}" ${p.id==last?'disabled':''}>${p.id}å· ${p.id==last?'(è¿å®ˆ)':''}</button>`).join('');this.$('action-panel').innerHTML=`<h3>ğŸ›¡ï¸ å®ˆå«</h3><div>${btns}</div><div style="margin-top:15px;"><button id="guard-skip" class="control-btn">â­ï¸ è·³è¿‡</button></div>`;document.querySelectorAll('.action-btn').forEach(b=>b.onclick=async()=>{if(b.dataset.id==last)return;await db.ref(`games/${this.gameId}/nightActions/guard`).set(b.dataset.id);await this.setSkillState('lastGuardTarget',b.dataset.id);await db.ref(`games/${this.gameId}/nightStatus/guard`).set('complete')});this.$('guard-skip').onclick=()=>db.ref(`games/${this.gameId}/nightStatus/guard`).set('complete')},
async panelWitch(){const cure=!this.getSkillState('hasUsedCure'),poison=!this.getSkillState('hasUsedPoison');const wolf=(await db.ref(`games/${this.gameId}/nightActions/wolfKill`).once('value')).val();let h='<h3>ğŸ§ª å¥³å·«</h3><div>è§£è¯:'+(cure?'âœ“':'âœ—')+'|æ¯’è¯:'+(poison?'âœ“':'âœ—')+'</div>';if(cure&&wolf){const ban=this.gameState.round===1&&wolf==this.playerId;h+=`<div><button id="btn-cure" class="action-btn" ${ban?'disabled':''}>ğŸ’‰ æ•‘${wolf}å·</button>${ban?'<small>(é¦–å¤œç¦è‡ªæ•‘)</small>':''}</div>`}if(poison){h+='<h4>æ¯’è¯</h4><div>'+Object.values(this.allPlayers).filter(p=>p.isAlive).map(p=>`<button class="action-btn" data-id="${p.id}">â˜ ï¸ ${p.id}å·</button>`).join('')+'</div>'}h+='<div style="margin-top:10px;"><button id="witch-skip" class="control-btn">â­ï¸ è·³è¿‡</button></div>';this.$('action-panel').innerHTML=h;if(this.$('btn-cure'))this.$('btn-cure').onclick=async()=>{await this.setSkillState('hasUsedCure',true);await db.ref(`games/${this.gameId}/nightActions/witchCure`).set(true);await db.ref(`games/${this.gameId}/nightStatus/witch`).set('complete')};document.querySelectorAll('.action-btn[data-id]').forEach(b=>b.onclick=async()=>{await this.setSkillState('hasUsedPoison',true);await db.ref(`games/${this.gameId}/nightActions/witchPoison`).set(b.dataset.id);await db.ref(`games/${this.gameId}/nightStatus/witch`).set('complete')});this.$('witch-skip').onclick=()=>db.ref(`games/${this.gameId}/nightStatus/witch`).set('complete')},
async processNight(){const g=(await db.ref(`games/${this.gameId}`).once('value')).val(),na=g.nightActions||{},dead=[],msg=[];const wk=na.wolfKill,wp=na.witchPoison;if(wk&&wk==wp){dead.push({id:wk,lost:2,cause:'POISON'});msg.push(`â˜ ï¸â˜ ï¸ ${wk}å·åŒåˆ€åŒæ¯’`)}else{if(wk){const gd=na.guard==wk,cr=na.witchCure;if(gd&&cr){dead.push({id:wk,lost:1,cause:'NIGHT'});msg.push(`â˜ ï¸ ${wk}å·è¢«å®ˆæŠ¤ä¸”è¢«è§£æ•‘`)}else if(!gd&&!cr){dead.push({id:wk,lost:1,cause:'NIGHT'});msg.push(`â˜ ï¸ ${wk}å·è¢«ç‹¼æ€`)}else msg.push(`ğŸ’« ${wk}å·è¢«æ”»å‡»ä½†å­˜æ´»`)}else msg.push('ğŸŒ™ ç‹¼äººæœªè¡ŒåŠ¨');if(wp&&wp!=wk){dead.push({id:wp,lost:1,cause:'POISON'});msg.push(`â˜ ï¸ ${wp}å·è¢«æ¯’æ€`)}}if(!dead.length){msg=['ğŸŒŸ å¹³å®‰å¤œ'];await db.ref(`games/${this.gameId}/state/peaceNightStreak`).transaction(s=>(s||0)+1)}else await db.ref(`games/${this.gameId}/state/peaceNightStreak`).set(0);if(this.isHost)alert('å¤œæ™šç»“ç®—:\n'+msg.join('\n'));for(const d of dead)await this.kill(d.id,d.cause,g.players,d.lost);const live=await this.checkWin();if(live){this.updatePhase('DAY')}},
async kill(pid,cause,ps=null,lost=1){const players=ps||(await db.ref(`games/${this.gameId}/players`).once('value')).val(),p=players[pid];if(!p||!p.isAlive)return;if(this.getActiveRole(p)==='ç™½ç—´'&&cause==='VOTE'){await db.ref(`games/${this.gameId}/players/${pid}/isExposedIdiot`).set(true);await this.checkWin();return}const nd=Math.min(p.deaths+lost,2),dead=nd>=2,up={};up['players/'+pid+'/deaths']=nd;up['players/'+pid+'/isAlive']=!dead;await db.ref(`games/${this.gameId}`).update(up);if(dead&&Object.values(p.originalIdentities).some(i=>i.role==='çŒäºº')&&cause!=='POISON')this.updatePhase('HUNTER_ACTION');else this.checkWin()},
async checkWin(){const g=(await db.ref(`games/${this.gameId}`).once('value')).val();if(g.state.phase==='GAME_OVER')return false;let wolf=0,god=0,gold=0;Object.values(g.players).forEach(p=>{if(!p.isAlive)return;const rs=p.originalIdentities.map(i=>ROLES[i.role]),goodOnly=rs.every(r=>r.faction==='good');if(rs[0].name==='å¹³æ°‘'&&rs[1].name==='å¹³æ°‘')gold++;if(goodOnly&&!rs.every(r=>r.name==='å¹³æ°‘')&&rs.some(r=>r.isGod))god++;if(rs.some(r=>r.faction==='bad'))wolf++});let win=null;if(!wolf)win='ğŸ˜‡ å¥½äººèƒœåˆ©(ç‹¼äººå…¨ç­)';else if(g.state.peaceNightStreak>=3)win='ğŸ˜‡ å¥½äººèƒœåˆ©(ä¸‰å¤œå¹³å®‰)';else if(!god)win='ğŸº ç‹¼äººèƒœåˆ©(ç¥èŒå…¨ç­)';else if(!gold)win='ğŸº ç‹¼äººèƒœåˆ©(é‡‘å®å®å…¨ç­)';if(win){await db.ref(`games/${this.gameId}/state`).update({phase:'GAME_OVER',winner:win});return false}return true;}
};

document.addEventListener('DOMContentLoaded',()=>App.init());
</script>
</body>
</html>
