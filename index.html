<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>åŒèº«ä»½ç‹¼äººæ€ - ç”µå­æ³•å®˜</title>

<style>
:root{
 --bg:#1a1a2e; --card:#16213e; --border:#0f3460; --accent:#e94560;
 --text:#eaeaea; --success:#00d9ff; --danger:#ff006e; --warning:#ffb700;
 --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
 --shadow: 0 10px 30px rgba(0,0,0,0.3);
 --font-main: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
}

* { box-sizing: border-box; }

html, body {
  margin: 0;
  padding: 0;
  background: var(--bg);
  color: var(--text);
  font-family: var(--font-main);
  line-height: 1.6;
  min-height: 100vh;
}

body {
  display: flex;
  justify-content: center;
  align-items: flex-start;
  padding: 20px;
  background-image: 
    radial-gradient(circle at 20% 50%, rgba(233, 69, 96, 0.1) 0%, transparent 50%),
    radial-gradient(circle at 80% 80%, rgba(0, 217, 255, 0.1) 0%, transparent 50%);
}

#app {
  width: 100%;
  max-width: 900px;
  background: var(--card);
  border-radius: 20px;
  padding: 30px;
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
  animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

h1, h2, h3 {
  color: var(--text);
  margin-bottom: 20px;
  text-align: center;
  letter-spacing: 1px;
}

h1 {
  background: var(--gradient);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  font-size: 2em;
  margin-bottom: 30px;
}

h2 {
  color: var(--success);
  font-size: 1.5em;
  border-bottom: 2px solid var(--border);
  padding-bottom: 10px;
}

h3 {
  color: var(--warning);
  font-size: 1.2em;
}

hr {
  border: none;
  border-top: 2px solid var(--border);
  margin: 30px 0;
}

.hidden { display: none !important; }

button {
  background: var(--accent);
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 12px;
  cursor: pointer;
  font-size: 16px;
  font-weight: 600;
  margin: 5px;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

button::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 50%;
  transform: translate(-50%, -50%);
  transition: width 0.6s, height 0.6s;
}

button:hover::before {
  width: 300px;
  height: 300px;
}

button:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 5px 20px rgba(233, 69, 96, 0.4);
}

button:disabled {
  background: #4a4a4a;
  cursor: not-allowed;
  opacity: 0.6;
}

button.selected {
  background: var(--success) !important;
  box-shadow: 0 5px 20px rgba(0, 217, 255, 0.4);
}

button.control-btn {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

button.action-btn {
  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

button.confirm-btn {
  background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

input[type=number], input[type=text] {
  width: 80px;
  padding: 10px;
  border-radius: 10px;
  border: 2px solid var(--border);
  background: rgba(255, 255, 255, 0.05);
  color: var(--text);
  font-size: 16px;
  text-align: center;
  transition: all 0.3s ease;
}

input:focus {
  outline: none;
  border-color: var(--accent);
  background: rgba(255, 255, 255, 0.1);
}

.role-setup-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px;
  margin: 10px 0;
  background: rgba(255, 255, 255, 0.03);
  border-radius: 12px;
  transition: all 0.3s ease;
  border: 1px solid transparent;
}

.role-setup-item:hover {
  background: rgba(255, 255, 255, 0.05);
  border-color: var(--border);
}

.player-list-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 20px;
  margin: 12px 0;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 15px;
  transition: all 0.3s ease;
  border: 2px solid transparent;
}

.player-list-item:hover {
  border-color: var(--accent);
  transform: translateX(5px);
}

.player-list-item.dead {
  opacity: 0.7;
  background: rgba(255, 0, 110, 0.1);
}

.player-list-item.dead-all {
  opacity: 0.4;
  background: rgba(100, 100, 100, 0.1);
  text-decoration: line-through;
}

.life-heart {
  color: var(--danger);
  font-size: 24px;
  transition: all 0.3s ease;
  text-shadow: 0 0 10px rgba(255, 0, 110, 0.5);
}

.life-heart.lost {
  color: #555;
  text-shadow: none;
}

.thief-copy {
  color: #888;
  font-style: italic;
  font-size: 0.9em;
}

.dead-identity {
  text-decoration: line-through;
  opacity: 0.6;
}

.action-panel, .action-feedback {
  margin-top: 25px;
  padding: 20px;
  background: rgba(255, 255, 255, 0.03);
  border-radius: 15px;
  text-align: center;
  border: 1px solid var(--border);
}

.wolf-chat-box {
  padding: 20px;
  background: rgba(233, 69, 96, 0.1);
  border-radius: 15px;
  margin-top: 20px;
  border: 1px solid rgba(233, 69, 96, 0.3);
}

#wolf-chat {
  height: 180px;
  overflow-y: auto;
  border: 1px solid var(--border);
  padding: 15px;
  border-radius: 10px;
  margin-bottom: 15px;
  background: rgba(0, 0, 0, 0.3);
}

#wolf-chat::-webkit-scrollbar {
  width: 8px;
}

#wolf-chat::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.1);
  border-radius: 10px;
}

#wolf-chat::-webkit-scrollbar-thumb {
  background: var(--accent);
  border-radius: 10px;
}

#wolf-input {
  width: calc(100% - 100px);
  margin-right: 10px;
  padding: 12px;
  border-radius: 10px;
  border: 2px solid var(--border);
  background: rgba(255, 255, 255, 0.05);
  color: var(--text);
}

.vote-msg {
  color: var(--warning);
  font-weight: 600;
}

.game-over-banner {
  padding: 40px;
  text-align: center;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-radius: 20px;
  font-size: 28px;
  font-weight: bold;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

.game-over-banner.bad {
  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

details summary {
  cursor: pointer;
  font-weight: bold;
  color: var(--warning);
  padding: 10px;
  transition: all 0.3s ease;
}

details summary:hover {
  color: var(--success);
}

.status-badge {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 0.85em;
  font-weight: 600;
  margin-left: 10px;
}

.status-ready {
  background: rgba(0, 217, 255, 0.2);
  color: var(--success);
  border: 1px solid var(--success);
}

.status-not-ready {
  background: rgba(255, 0, 110, 0.2);
  color: var(--danger);
  border: 1px solid var(--danger);
}

.role-icon {
  display: inline-block;
  width: 30px;
  height: 30px;
  margin-right: 10px;
  text-align: center;
  line-height: 30px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.1);
}

.loading-spinner {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  border-top-color: var(--accent);
  animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.identity-card {
  background: rgba(255, 255, 255, 0.05);
  padding: 20px;
  border-radius: 15px;
  margin: 10px 0;
  border: 2px solid var(--border);
  transition: all 0.3s ease;
}

.identity-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
}

.action-status {
  padding: 15px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 12px;
  margin: 15px 0;
}

.action-status-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 0;
}

@media (max-width: 600px) {
  #app {
    padding: 20px;
  }
  
  h1 {
    font-size: 1.5em;
  }
  
  button {
    padding: 10px 16px;
    font-size: 14px;
  }
}
</style>
</head>
<body>
<div id="app">
  <div id="host-view">
    <h1>ğŸŒ™ åŒèº«ä»½ç‹¼äººæ€ - ä¸»æŒç«¯</h1>
    <div id="setup">
      <h2>ğŸ“‹ èº«ä»½é…ç½®</h2>
      <div id="role-setup"></div>
      <p style="text-align: center; font-size: 18px;">
        <span style="color: var(--warning);">æ€»èº«ä»½æ•°: <strong id="total-roles">0</strong></span> | 
        <span style="color: var(--success);">é¢„è®¡ç©å®¶æ•°: <strong id="player-cnt">0</strong></span>
      </p>
      <div style="text-align: center; margin-top: 20px;">
        <button id="btn-create" class="control-btn">
          <span id="create-text">åˆ›å»ºæ¸¸æˆ</span>
          <span id="create-spinner" class="loading-spinner hidden"></span>
        </button>
      </div>
    </div>

    <div id="links" class="hidden">
      <h2>ğŸ”— åˆ†äº«é“¾æ¥</h2>
      <div id="links-box"></div>
    </div>

    <div id="host-ctrl" class="hidden">
      <h2>ğŸ® æ¸¸æˆæ§åˆ¶</h2>
      <div id="host-status"></div>
      <div id="ready-box"></div>
      <div style="text-align: center; margin: 20px 0;">
        <button id="btn-start" class="control-btn">ğŸš€ é”å®šèº«ä»½ï¼Œå¼€å§‹æ¸¸æˆ</button>
        <button id="btn-night" class="control-btn">ğŸŒ™ å¤©é»‘è¯·é—­çœ¼</button>
        <button id="btn-day" class="control-btn">â˜€ï¸ å¤©äº®äº† (ç»“ç®—å¤œæ™š)</button>
      </div>
      <hr>
      <h3>ğŸŒƒ å¤œæ™šè¡ŒåŠ¨ (æ‰‹åŠ¨æ¨è¿›)</h3>
      <div style="text-align: center;">
        <button class="host-action action-btn" data-action="WOLF_ACTION">ğŸº ç‹¼äººè¡ŒåŠ¨</button>
        <button class="host-action action-btn" data-action="WITCH_ACTION">ğŸ§ª å¥³å·«è¡ŒåŠ¨</button>
        <button class="host-action action-btn" data-action="SEER_ACTION">ğŸ”® é¢„è¨€å®¶è¡ŒåŠ¨</button>
        <button class="host-action action-btn" data-action="GUARD_ACTION">ğŸ›¡ï¸ å®ˆå«è¡ŒåŠ¨</button>
      </div>
      <div id="action-feedback-box"></div>
      <div id="night-action-status" class="action-status hidden"></div>
      <div id="night-result" class="hidden"></div>
      <hr>
      <h3>ğŸ“Š æ¸¸æˆç®¡ç†</h3>
      <div style="text-align: center;">
        <button id="btn-reveal" class="control-btn">ğŸ‘ï¸ å¤ç›˜ï¼šæ˜¾ç¤ºæ‰€æœ‰èº«ä»½</button>
      </div>
      <div id="host-player-list"></div>
    </div>
  </div>

  <div id="player-view" class="hidden">
    <h1 id="game-title">ğŸŒ™ åŒèº«ä»½ç‹¼äººæ€</h1>
    <div id="player-info">
      <h2 id="pid-show"></h2>
      <h3>ä½ çš„èº«ä»½æ˜¯:</h3>
      <div id="my-ids" class="identity-card"></div>
      <div id="swap-area" class="hidden">
        <p style="text-align: center; color: var(--warning);">æ¸¸æˆå¼€å§‹å‰ï¼Œä½ å¯ä»¥äº¤æ¢ä¸¤ä¸ªèº«ä»½çš„é¡ºåºã€‚å½“å‰ç”Ÿæ•ˆçš„èº«ä»½æ˜¯ç¬¬ä¸€ä¸ªã€‚</p>
        <div style="text-align: center;">
          <button id="btn-swap" class="action-btn">ğŸ”„ äº¤æ¢é¡ºåº</button>
          <button id="btn-confirm" class="confirm-btn">âœ… ç¡®å®šèº«ä»½é¡ºåº</button>
        </div>
      </div>
    </div>
    <hr>
    <div id="game-area">
      <div id="player-status" style="text-align:center; font-size: 20px; font-weight: bold; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 15px; margin-bottom: 20px;">
        ç­‰å¾…æ¸¸æˆå¼€å§‹...
      </div>
      <div id="persist" class="hidden"></div>
      <div id="action-panel"></div>
      <div id="wolf-chat-area" class="hidden"></div>
      <h3>ğŸ‘¥ ç©å®¶åˆ—è¡¨</h3>
      <div id="player-list"></div>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
/* ==========================================================
   åŒèº«ä»½ç‹¼äººæ€å‰ç«¯ä¸»é€»è¾‘ (2025-06-27 ä¿®è®¢ç‰ˆ)
   ========================================================== */

/* ========== 1. Firebase åˆå§‹åŒ– ========== */
const firebaseConfig={
 apiKey:"AIzaSyCEAgB6DoY8YA6lZnYblhIDVTYH_q8UimI",
 authDomain:"werewolf-game-master-1f37f.firebaseapp.com",
 databaseURL:"https://werewolf-game-master-1f37f-default-rtdb.asia-southeast1.firebasedatabase.app",
 projectId:"werewolf-game-master-1f37f",
 storageBucket:"werewolf-game-master-1f37f.appspot.com",
 messagingSenderId:"626014452910",
 appId:"1:626014452910:web:35b6eba412f95f1878013f"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

/* ========== 2. å…¨å±€å¸¸é‡ä¸é…ç½® ========== */
const ROLES={
 'å¹³æ°‘':{name:'å¹³æ°‘',faction:'good',isGod:false,icon:'ğŸ‘¤'},
 'å®ˆå«':{name:'å®ˆå«',faction:'good',isGod:true,icon:'ğŸ›¡ï¸'},
 'ç™½ç—´':{name:'ç™½ç—´',faction:'good',isGod:true,icon:'ğŸ¤ª'},
 'é¢„è¨€å®¶':{name:'é¢„è¨€å®¶',faction:'good',isGod:true,icon:'ğŸ”®'},
 'éª‘å£«':{name:'éª‘å£«',faction:'good',isGod:true,icon:'âš”ï¸'},
 'éšç‹¼':{name:'éšç‹¼',faction:'bad',isGod:false,isInvisible:true,icon:'ğŸŒ‘'},
 'å¥³å·«':{name:'å¥³å·«',faction:'good',isGod:true,icon:'ğŸ§ª'},
 'çŒäºº':{name:'çŒäºº',faction:'good',isGod:true,icon:'ğŸ”«'},
 'ç‹¼äºº':{name:'ç‹¼äºº',faction:'bad',isGod:false,icon:'ğŸº'},
 'ç›—è´¼':{name:'ç›—è´¼',faction:'neutral',isGod:false,isThief:true,icon:'ğŸ­'}
};
const DEFAULT_SETUP={'å¹³æ°‘':6,'å®ˆå«':1,'ç™½ç—´':1,'é¢„è¨€å®¶':1,'éª‘å£«':1,'å¥³å·«':1,'çŒäºº':1,'ç‹¼äºº':2,'éšç‹¼':1,'ç›—è´¼':1};
const FORBIDDEN=[['é¢„è¨€å®¶','ç‹¼äºº'],['é¢„è¨€å®¶','éšç‹¼'],['ç›—è´¼','ç‹¼äºº'],['ç›—è´¼','éšç‹¼'],['éšç‹¼','ç‹¼äºº'],['éšç‹¼','éšç‹¼']];

/* ========== ç»Ÿä¸€çš„å·¥å…·å‡½æ•° ========== */
function shouldAct(player, phase, allPlayers){
  if(!player.isAlive) return false;
  const activeRole = App.getActiveRole(player);
  const map = {
    WOLF_ACTION : ['ç‹¼äºº','éšç‹¼'],
    SEER_ACTION : ['é¢„è¨€å®¶'],
    GUARD_ACTION: ['å®ˆå«'],
    WITCH_ACTION: ['å¥³å·«'],
    KNIGHT_ACTION:['éª‘å£«'],
    HUNTER_ACTION:['çŒäºº']
  };
  if(!map[phase]?.includes(activeRole)) return false;

  // éšç‹¼åªæœ‰åœ¨åœºä¸Šæ²¡æœ‰å­˜æ´»"æ˜ç‹¼"æ—¶æ‰è¡ŒåŠ¨
  if(phase==='WOLF_ACTION' && activeRole==='éšç‹¼'){
    return !Object.values(allPlayers).some(pp =>
       pp.isAlive && pp.id!==player.id && App.getActiveRole(pp)==='ç‹¼äºº');
  }
  return true;
}

/* ===================== 3. App ä¸»å¯¹è±¡ ===================== */
const App={
/* ---------- åŸºç¡€å±æ€§ ---------- */
gameId:null,playerId:null,isHost:false,
gameState:null,allPlayers:{},playerData:null,
wolfChatListener:null,wolfVotesListener:null,
nightActionListener:null,

/* ---------- åˆå§‹åŒ–ä¸å…¬å…±å·¥å…· ---------- */
init(){
 this.cacheDom();
 const qp=new URLSearchParams(location.search);
 this.gameId=qp.get('game');this.playerId=qp.get('player');
 if(this.gameId&&this.playerId){this.isHost=false;this.showView('player');this.initPlayer();}
 else{this.isHost=true;this.showView('host');this.initHost();}
},

$(id){return document.getElementById(id);},
copy(text){navigator.clipboard.writeText(text).then(()=>alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿'),()=>alert('å¤åˆ¶å¤±è´¥'));},

cacheDom(){
 this.dom={
  hostView:this.$('host-view'),playerView:this.$('player-view'),
  roleSetup:this.$('role-setup'),totalRoles:this.$('total-roles'),playerCnt:this.$('player-cnt'),
  btnCreate:this.$('btn-create'),links:this.$('links'),linksBox:this.$('links-box'),
  hostCtrl:this.$('host-ctrl'),btnStart:this.$('btn-start'),btnNight:this.$('btn-night'),btnDay:this.$('btn-day'),
  hostActions:document.querySelectorAll('.host-action'),hostPlayerList:this.$('host-player-list'),
  btnReveal:this.$('btn-reveal'),readyBox:this.$('ready-box'),actionFeedback:this.$('action-feedback-box'),
  nightResult:this.$('night-result'),pidShow:this.$('pid-show'),myIds:this.$('my-ids'),
  swapArea:this.$('swap-area'),btnSwap:this.$('btn-swap'),btnConfirm:this.$('btn-confirm'),
  playerStatus:this.$('player-status'),persist:this.$('persist'),actionPanel:this.$('action-panel'),
  playerList:this.$('player-list'),wolfChatArea:this.$('wolf-chat-area'),gameTitle:this.$('game-title'),
  nightActionStatus:this.$('night-action-status')
 };
},
showView(viewName){
 this.dom.hostView.classList.add('hidden');
 this.dom.playerView.classList.add('hidden');
 if(viewName==='host') {
    this.dom.hostView.classList.remove('hidden');
    this.stopWolfListeners(); // é¿å…ä¸»æŒç«¯è¯¯å¬ç‹¼äººé¢‘é“
 }
 else this.dom.playerView.classList.remove('hidden');
},

/* =========================================================
   3.2  ä¸»æŒç«¯é€»è¾‘
   ========================================================= */
initHost(){
 this.renderRoleSetup();
 this.dom.btnCreate.onclick=()=>this.createGame();
 this.dom.btnStart.onclick=()=>this.startGame();
 this.dom.btnNight.onclick=()=>this.updatePhase('NIGHT_START');
 this.dom.btnDay.onclick=()=>this.processNightResults();
 this.dom.hostActions.forEach(b=>b.onclick=()=>this.triggerAction(b.dataset.action));
 this.dom.btnReveal.onclick=()=>this.renderHostPlayers(true);
},

renderRoleSetup(){
 let html='';
 for(const r in DEFAULT_SETUP){
  const role = ROLES[r];
  html+=`<div class="role-setup-item">
    <span><span class="role-icon">${role.icon}</span>${r}</span>
    <input type="number" id="role-${r}" min="0" value="${DEFAULT_SETUP[r]}">
  </div>`;
 }
 this.dom.roleSetup.innerHTML=html;
 this.dom.roleSetup.oninput=()=>this.updateRoleCount();this.updateRoleCount();
},

updateRoleCount(){
 let total=0;
 this.dom.roleSetup.querySelectorAll('input').forEach(i=>total+=+i.value||0);
 this.dom.totalRoles.textContent=total;
 this.dom.playerCnt.textContent=total%2===0?total/2:'èº«ä»½æ€»æ•°å¿…é¡»ä¸ºå¶æ•°';
},

async createGame(){
 this.dom.btnCreate.disabled=true;
 this.$('create-text').classList.add('hidden');
 this.$('create-spinner').classList.remove('hidden');
 
 const rolePool=[];
 this.dom.roleSetup.querySelectorAll('input').forEach(i=>{
  const role=i.id.replace('role-','');for(let k=0;k<(+i.value||0);k++)rolePool.push(role);
 });
 if(rolePool.length===0||rolePool.length%2){alert('èº«ä»½æ€»æ•°å¿…é¡»ä¸ºå¶æ•°ä¸”å¤§äº0');location.reload();return;}

 // ä¼˜åŒ–çš„å‘ç‰Œç®—æ³•
 const identityPairs = this.optimizedDealIdentities(rolePool);
 if(!identityPairs){alert('æ— æ³•ç”Ÿæˆåˆæ³•ç‰Œç»„ï¼Œè¯·è°ƒæ•´èº«ä»½é…ç½®ã€‚');location.reload();return;}

 this.gameId=db.ref('games').push().key;
 const playerCount=rolePool.length/2,players={};
 for(let i=1;i<=playerCount;i++){
  players[i]={
   id:i,identities:identityPairs[i-1],originalIdentities:[...identityPairs[i-1]],
   deaths:0,isAlive:true,isReady:false,isExposedIdiot:false,
   seerResults:{},lastGuardTarget:null,hasUsedPoison:false,hasUsedCure:false,
  };
 }
 const initialGameData={
  state:{phase:'SETUP',round:0,peaceNightStreak:0,winner:null},
  players,config:{playerCount},
  wolfChat:{},wolfVotes:{},nightActions:{},actionCompleted:{}
 };
 await db.ref(`games/${this.gameId}`).set(initialGameData);
 this.listenToGameChanges();
 this.buildPlayerLinks(playerCount);
 this.dom.btnCreate.classList.add('hidden');
 this.dom.links.classList.remove('hidden');
 this.dom.hostCtrl.classList.remove('hidden');
},

// ä¼˜åŒ–çš„å‘ç‰Œç®—æ³•
optimizedDealIdentities(pool) {
  const n = pool.length;
  const maxAttempts = 5000;
  // ç®€å•æ´—ç‰Œ
  function shuffle(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  for (let attempt = 0; attempt < maxAttempts; attempt++) {
    const shuffled = shuffle(pool.slice());
    const pairs = [];
    let valid = true;
    let goldenCount = 0;

    // ä¸¤ä¸¤é…
    for (let i = 0; i < n; i += 2) {
      const r1 = shuffled[i], r2 = shuffled[i + 1];
      // æ£€æŸ¥ç¦é…
      for (const [f1, f2] of FORBIDDEN) {
        if ((r1 === f1 && r2 === f2) || (r1 === f2 && r2 === f1)) {
          valid = false;
          break;
        }
      }
      if (!valid) break;
      // ç»Ÿè®¡"é‡‘å®å®"ï¼šå¹³æ°‘+å¹³æ°‘ æˆ– ç›—è´¼+å¹³æ°‘ï¼ˆåŒå‘ï¼‰
      if ((r1 === 'å¹³æ°‘' && r2 === 'å¹³æ°‘')
       || (r1 === 'ç›—è´¼' && r2 === 'å¹³æ°‘')
       || (r1 === 'å¹³æ°‘' && r2 === 'ç›—è´¼')) {
        goldenCount++;
      }
      pairs.push([r1, r2]);
    }

    if (!valid) continue;
    if (goldenCount < 1 || goldenCount > 2) continue;

    // æ„é€ è¿”å›æ ¼å¼
    return pairs.map(pair => pair.map(role => ({
      role,
      isThiefCopy: false
    })));
  }

  // è¶…æ—¶æœªæ‰¾åˆ°åˆæ³•æ–¹æ¡ˆ
  return null;
},

buildPlayerLinks(count){
 const base=location.href.split('?')[0],tpl=`${base}?game=${this.gameId}&player=[N]`;
 let linksHtml='';
 for(let i=1;i<=count;i++){
    const l=`${base}?game=${this.gameId}&player=${i}`;
    linksHtml+=`<div style="margin:10px 0;">
      <span style="display:inline-block;width:80px;font-weight:600;">ğŸ® ${i}å·:</span>
      <input value="${l}" readonly style="width:calc(100% - 200px);">
      <button onclick="App.copy('${l}')" class="action-btn">ğŸ“‹ å¤åˆ¶</button>
    </div>`;
 }
 this.dom.linksBox.innerHTML=`
    <div style="background:rgba(255,255,255,0.05);padding:20px;border-radius:15px;margin-bottom:20px;">
      <p><strong>ğŸ”— é€šç”¨æ¨¡æ¿:</strong></p>
      <input value="${tpl}" readonly style="width:calc(100% - 120px);">
      <button onclick="App.copy('${tpl}')" class="action-btn">ğŸ“‹ å¤åˆ¶</button>
    </div>
    <details>
      <summary>å±•å¼€/æŠ˜å å„ç©å®¶ä¸“å±é“¾æ¥</summary>
      <div style="padding:10px;">${linksHtml}</div>
    </details>`;
},

listenToGameChanges(){
 db.ref(`games/${this.gameId}`).on('value',snap=>{
  if(!snap.exists())return;
  const gameData=snap.val();
  this.gameState=gameData.state;
  this.allPlayers=gameData.players||{};
  this.renderHostPlayers(false);
  this.updateReadyStatus();
  this.updateHostControlsState();
 });
 
 // ç›‘å¬å¤œæ™šè¡ŒåŠ¨å®Œæˆæƒ…å†µ
 if(this.nightActionListener) db.ref(`games/${this.gameId}/actionCompleted`).off('value', this.nightActionListener);
 this.nightActionListener = db.ref(`games/${this.gameId}/actionCompleted`).on('value', snap => {
   this.updateNightActionStatus(snap.val() || {});
 });
},

updateNightActionStatus(actionCompleted) {
  const phase = this.gameState.phase;
  if (!phase.includes('ACTION')) {
    this.dom.nightActionStatus.classList.add('hidden');
    return;
  }
  
  const roleActionMap = {
    'WOLF_ACTION': {role: 'ç‹¼äºº', icon: 'ğŸº'},
    'WITCH_ACTION': {role: 'å¥³å·«', icon: 'ğŸ§ª'},
    'SEER_ACTION': {role: 'é¢„è¨€å®¶', icon: 'ğŸ”®'},
    'GUARD_ACTION': {role: 'å®ˆå«', icon: 'ğŸ›¡ï¸'}
  };
  
  const currentAction = roleActionMap[phase];
  if (!currentAction) return;
  
  // æ‰¾å‡ºåº”è¯¥è¡ŒåŠ¨çš„ç©å®¶
  const shouldActPlayers = Object.values(this.allPlayers).filter(p => shouldAct(p, phase, this.allPlayers));
  
  const completedPlayers = shouldActPlayers.filter(p => actionCompleted[`${p.id}_${phase}`]);
  
  let html = `<h4>${currentAction.icon} ${currentAction.role}è¡ŒåŠ¨çŠ¶æ€</h4>`;
  html += `<div>å·²å®Œæˆ: ${completedPlayers.length} / ${shouldActPlayers.length}</div>`;
  html += '<div style="margin-top:10px;">';
  
  shouldActPlayers.forEach(p => {
    const completed = actionCompleted[`${p.id}_${phase}`];
    html += `<div class="action-status-item">
      <span>${p.id}å·</span>
      <span style="color: ${completed ? 'var(--success)' : 'var(--warning)'}">
        ${completed ? 'âœ… å·²è¡ŒåŠ¨' : 'â³ ç­‰å¾…ä¸­'}
      </span>
    </div>`;
  });
  
  html += '</div>';
  
  this.dom.nightActionStatus.innerHTML = html;
  this.dom.nightActionStatus.classList.remove('hidden');
},

updateReadyStatus(){
 const players=Object.values(this.allPlayers),total=players.length;
 if(total===0)return;
 const ready=players.filter(p=>p.isReady).length;
 let html=`<h3>ğŸ“Š å‡†å¤‡çŠ¶æ€ (${ready}/${total})</h3><div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px;">`;
 players.forEach(p=>{
    html+=`<div style="padding:10px;background:rgba(255,255,255,0.05);border-radius:10px;text-align:center;">
      ${p.id}å· 
      <span class="status-badge ${p.isReady?'status-ready':'status-not-ready'}">
        ${p.isReady?'âœ… å·²å‡†å¤‡':'â³ æœªå‡†å¤‡'}
      </span>
    </div>`;
 });
 html+='</div>';
 this.dom.readyBox.innerHTML=html;
 this.dom.btnStart.disabled=ready<total;
},

updateHostControlsState() {
    const phase = this.gameState.phase;
    const isNight = phase.includes('ACTION') || phase === 'NIGHT_START';

    this.dom.btnStart.disabled = phase !== 'SETUP' || !this.dom.btnStart.disabled;
    this.dom.btnNight.disabled = isNight || phase === 'GAME_OVER';
    this.dom.btnDay.disabled = !isNight || phase === 'GAME_OVER';
    
    this.dom.hostActions.forEach(btn => btn.disabled = (phase === 'DAY' || phase === 'GAME_OVER'));
},

async startGame(){
 if(this.dom.btnStart.disabled)return;
 await this.updatePhase('NIGHT_START',1);
},

async updatePhase(phase,round=null){
 const updates={phase};
 if(round!==null)updates.round=round;
 await db.ref(`games/${this.gameId}/state`).update(updates);
 if(phase==='NIGHT_START') await db.ref(`games/${this.gameId}`).update({nightActions:{},wolfVotes:{},actionCompleted:{}});
},

triggerAction(action){
 this.updatePhase(action);
 const roleEmoji = {
    'WOLF_ACTION': 'ğŸº',
    'WITCH_ACTION': 'ğŸ§ª', 
    'SEER_ACTION': 'ğŸ”®',
    'GUARD_ACTION': 'ğŸ›¡ï¸'
 };
 this.dom.actionFeedback.innerHTML=`<div class="action-waiting">
    <p style="font-size:20px;">${roleEmoji[action]} ç­‰å¾…ç©å®¶è¡ŒåŠ¨ä¸­...</p>
    <div class="loading-spinner" style="margin:20px auto;"></div>
 </div>`;
},

renderHostPlayers(reveal){
 let html='';
 const isDay = this.gameState.phase === 'DAY';
 for(const id in this.allPlayers){
  const p=this.allPlayers[id];
  const lives=2-p.deaths;
  const hearts=`<span class="life-heart ${lives<1?'lost':''}">â¤</span><span class="life-heart ${lives<2?'lost':''}">â¤</span>`;
  let identitiesStr='';
  if(reveal){
   const fmt=i=>`${ROLES[i.role].icon} ${i.isThiefCopy?'<span class="thief-copy">'+i.role+'</span>':i.role}`;
   identitiesStr=` [${fmt(p.originalIdentities[0])} + ${fmt(p.originalIdentities[1])}]`;
  }
  let statusClass=p.isAlive?'':'dead-all';
  let voteBtnHtml=`<button onclick="App.kill(${id},'VOTE')" class="action-btn" ${!p.isAlive || !isDay || p.isExposedIdiot ? 'disabled' : ''}>ğŸ—³ï¸ ç¥¨å‡º</button>`;
  if(p.isExposedIdiot) {
      identitiesStr += ' <span style="color:var(--warning)">(ç™½ç—´å·²ç¿»ç‰Œ)</span>';
  }
  html+=`<div class="player-list-item ${statusClass}">
           <span><strong>${id}å·</strong>${identitiesStr}</span>
           <div style="display:flex;align-items:center;">
             <span class="player-lives" style="margin-right: 20px;">${hearts}</span>
             ${voteBtnHtml}
           </div>
         </div>`;
 }
 this.dom.hostPlayerList.innerHTML=html;
},

async processNightResults(){
 const snap=await db.ref(`games/${this.gameId}`).once('value');const g=snap.val();
 const na=g.nightActions||{};
 let deathsThisNight=[],messages=[];
 
 // æ£€æŸ¥æ˜¯å¦æœ‰ç›®æ ‡åŒæ—¶è¢«ç‹¼åˆ€å’Œå¥³å·«æ¯’
 const doubleKillTarget = na.wolfKill && na.witchPoison && na.wolfKill == na.witchPoison ? na.wolfKill : null;
 
 if(doubleKillTarget) {
   // åŒé‡å‡»æ€ï¼šæŸå¤±ä¸¤æ¡å‘½
   deathsThisNight.push({id: doubleKillTarget, cause: 'DOUBLE_KILL', livesCost: 2});
   messages.push(`â˜ ï¸â˜ ï¸ ${doubleKillTarget}å·ç©å®¶åŒæ—¶è¢«ç‹¼äººæ€å®³å’Œå¥³å·«æ¯’æ€ï¼ŒæŸå¤±ä¸¤æ¡å‘½ï¼`);
 } else {
   // å¤„ç†ç‹¼äººå‡»æ€
   if(na.wolfKill){
    const targetId=na.wolfKill;
    const isGuarded=na.guard==targetId;
    const isCured=na.witchCure==true;
    if((isGuarded&&isCured)||(!isGuarded&&!isCured)){
     deathsThisNight.push({id:targetId,cause:'NIGHT', livesCost: 1});
     messages.push(`â˜ ï¸ ${targetId}å·ç©å®¶è¢«ç‹¼äººæ€å®³ã€‚`);
    } else {
     messages.push(`ğŸ’« ${targetId}å·ç©å®¶è¢«ç‹¼äººæ”»å‡»ï¼Œä½†å­˜æ´»äº†ä¸‹æ¥ã€‚`);
    }
   } else {
    messages.push('ğŸŒ™ ç‹¼äººæ˜¨æ™šæ²¡æœ‰é€‰æ‹©ç›®æ ‡ã€‚');
   }
   
   // å¤„ç†å¥³å·«æ¯’æ€
   if(na.witchPoison){
    deathsThisNight.push({id:na.witchPoison,cause:'POISON', livesCost: 1});
    messages.push(`â˜ ï¸ ${na.witchPoison}å·ç©å®¶è¢«å¥³å·«æ¯’æ€ã€‚`);
   }
 }
 
 if(deathsThisNight.length===0){
  messages=['ğŸŒŸ æ˜¨æ™šæ˜¯å¹³å®‰å¤œã€‚'];
  await db.ref(`games/${this.gameId}/state/peaceNightStreak`).transaction(s=>s+1);
 } else {
  await db.ref(`games/${this.gameId}/state/peaceNightStreak`).set(0);
 }
 
 this.dom.nightResult.innerHTML=`
    <div style="background:rgba(255,255,255,0.05);padding:20px;border-radius:15px;margin:20px 0;">
      <h3>ğŸŒ… å¤œæ™šç»“æœ</h3>
      <div style="font-size:18px;line-height:2;">${messages.join('<br>')}</div>
    </div>`;
 this.dom.nightResult.classList.remove('hidden');

 // å¤„ç†æ­»äº¡
 for(const death of deathsThisNight){
   await this.kill(death.id, death.cause, g.players, death.livesCost);
 }

 const gameStillOn = await this.checkVictory();
 if(gameStillOn){
    const currentRound = g.state.round;
    this.updatePhase('DAY',currentRound+1);
 }
},

/* =========================================================
   3.3  ç©å®¶ç«¯é€»è¾‘
   ========================================================= */
initPlayer(){
 this.dom.pidShow.textContent=`ğŸ® ä½ æ˜¯ ${this.playerId} å·`;
 db.ref(`games/${this.gameId}`).on('value',snap=>{
  if(!snap.exists()){this.dom.playerStatus.textContent='æ¸¸æˆå·²ç»“æŸæˆ–ä¸å­˜åœ¨ã€‚';return;}
  const g=snap.val();
  this.gameState=g.state;this.allPlayers=g.players;this.playerData=g.players[this.playerId];
  if(this.gameState.phase!=='WOLF_ACTION')this.stopWolfListeners();
  this.renderPlayerView();
 });
 this.dom.btnSwap.onclick=()=>this.swapIdentities();
 this.dom.btnConfirm.onclick=()=>this.confirmIdentities();
},

/* ---------- æ¸²æŸ“ä¸æ›´æ–° ---------- */
renderPlayerView(){
 this.renderMyIdentities();
 this.renderPlayerStatus();
 this.renderPlayerList();
 this.renderPersistentInfo();
 this.renderActionPanel();
 
 const showSwap=this.gameState.phase==='SETUP'&&!this.playerData.isReady;
 this.dom.swapArea.classList[showSwap?'remove':'add']('hidden');

 if(this.gameState.phase==='GAME_OVER'){
    this.dom.gameTitle.innerHTML = `<div class="game-over-banner ${this.gameState.winner.includes('ç‹¼äºº') ? 'bad' : ''}">${this.gameState.winner}</div>`;
 }
},
renderMyIdentities(){
 const ids=this.playerData.identities;
 const fmt=i=>{
    const roleInfo = ROLES[i.role];
    return `${roleInfo.icon} ${i.isThiefCopy?'<span class="thief-copy">'+i.role+'</span>':i.role}`;
 };
 const d=this.playerData.deaths;
 const html=`
    <div style="display:flex;justify-content:center;align-items:center;font-size:24px;">
      ${d>=1?'<span class="dead-identity">':''}${fmt(ids[0])}${d>=1?'</span>':''}
      <span style="margin:0 20px;">+</span>
      ${d>=2?'<span class="dead-identity">':''}${fmt(ids[1])}${d>=2?'</span>':''}
    </div>`;
 this.dom.myIds.innerHTML=html;
},
renderPlayerStatus(){
 const phaseMap={
  SETUP:'â³ ç­‰å¾…æ‰€æœ‰ç©å®¶å‡†å¤‡',NIGHT_START:'ğŸŒ™ å¤©é»‘è¯·é—­çœ¼...',
  WOLF_ACTION:'ğŸº ç‹¼äººè¡ŒåŠ¨',WITCH_ACTION:'ğŸ§ª å¥³å·«è¡ŒåŠ¨',SEER_ACTION:'ğŸ”® é¢„è¨€å®¶è¡ŒåŠ¨',GUARD_ACTION:'ğŸ›¡ï¸ å®ˆå«è¡ŒåŠ¨',
  KNIGHT_ACTION: 'âš”ï¸ éª‘å£«è¡ŒåŠ¨', HUNTER_ACTION: 'ğŸ”« çŒäººè¡ŒåŠ¨',
  DAY:`â˜€ï¸ ç¬¬ ${this.gameState.round} å¤© - å‘è¨€/æŠ•ç¥¨é˜¶æ®µ`,
  GAME_OVER:`ğŸ® æ¸¸æˆç»“æŸ - ${this.gameState.winner||''}`
 };
 this.dom.playerStatus.innerHTML=phaseMap[this.gameState.phase]||'æ¸¸æˆä¸­...';
},
renderPlayerList(){
 let html='';
 Object.values(this.allPlayers).forEach(p=>{
  const lives=2-p.deaths;
  const hearts=`<span class="life-heart ${lives<1?'lost':''}">â¤</span><span class="life-heart ${lives<2?'lost':''}">â¤</span>`;
  let statusClass = !p.isAlive ? 'dead-all' : (p.deaths > 0 ? 'dead' : '');
  let statusText = p.isExposedIdiot ? 'ğŸ¤ª å·²ç¿»ç‰Œ' : (p.isAlive ? 'âœ… å­˜æ´»' : 'âŒ å‡ºå±€');
  html+=`<div class="player-list-item ${statusClass}">
          <span class="player-name"><strong>${p.id}å·ç©å®¶</strong> <small>${statusText}</small></span>
          <span>${hearts}</span>
          </div>`;
 });
 this.dom.playerList.innerHTML=html;
},
renderPersistentInfo(){
 let html='';
 if(this.canSeeWolfChat()){
  const mates=Object.values(this.allPlayers).filter(p=>{
   if(p.id==this.playerId||!p.isAlive)return false;
   const pRole=this.getActiveRole(p);
   return ['ç‹¼äºº','éšç‹¼'].includes(pRole);
  }).map(p=>`${p.id}å·`).join('ã€');
  html+=`<div style="padding:15px;background:rgba(233,69,96,0.1);border-radius:12px;margin:10px 0;">
    <strong>ğŸº ç‹¼é˜Ÿå‹:</strong> ${mates||'æ— '}
  </div>`;
 }
 if(this.getActiveRole(this.playerData)==='é¢„è¨€å®¶'){
  const res=this.playerData.seerResults||{};
  const list=Object.entries(res).map(([id,r])=>`${id}å·(${r==='ç‹¼äºº'?'ğŸº':'ğŸ˜‡'})`).join('ã€ ');
  if(list)html+=`<div style="padding:15px;background:rgba(102,126,234,0.1);border-radius:12px;margin:10px 0;">
    <strong>ğŸ”® æŸ¥éªŒå†å²:</strong> ${list}
  </div>`;
 }
 if(html){this.dom.persist.innerHTML=html;this.dom.persist.classList.remove('hidden')}
 else this.dom.persist.classList.add('hidden');
},

/* ---------- èº«ä»½ä¸è¡ŒåŠ¨æƒåˆ¤æ–­ ---------- */
getActiveRole(player){
 if(!player.isAlive)return null;
 return player.identities[player.deaths].role;
},
canSeeWolfChat(){
 const r=this.getActiveRole(this.playerData);
 return r==='ç‹¼äºº'||r==='éšç‹¼';
},
canPerformAction(phase){
 return shouldAct(this.playerData, phase, this.allPlayers);
},
hasRoleInPair(roleName){
 return this.playerData.originalIdentities.some(id=>id.role===roleName);
},

// è·å–åºå·æœ€å°çš„æ´»ç€çš„ç‹¼äºº
getMinWolfId(){
 const wolves = Object.values(this.allPlayers).filter(p => {
    if(!p.isAlive) return false;
    const role = this.getActiveRole(p);
    return role === 'ç‹¼äºº' || (role === 'éšç‹¼' && !this.hasOtherLivingWolf(p.id));
 });
 if(wolves.length === 0) return null;
 return Math.min(...wolves.map(w => w.id));
},

hasOtherLivingWolf(excludeId) {
 return Object.values(this.allPlayers).some(p => 
    p.isAlive && p.id != excludeId && this.getActiveRole(p) === 'ç‹¼äºº'
 );
},

/* ---------- å„è§’è‰²è¡ŒåŠ¨é¢æ¿ ---------- */
renderActionPanel(){
 const phase=this.gameState.phase;
 this.dom.actionPanel.innerHTML='';
 if(!this.playerData.isAlive && phase !== 'HUNTER_ACTION') return;

 switch(phase){
  case 'DAY': 
    // ç™½ç—´è¢«æ”¾é€åä¸èƒ½å†å†³æ–—
    if(this.getActiveRole(this.playerData)==='éª‘å£«' && !this.playerData.isExposedIdiot) {
      return this.renderKnightPanel();
    }
    return '';
  case 'WOLF_ACTION': return this.canPerformAction('WOLF_ACTION')?this.renderWolfPanel():this.renderWaitingPanel(phase);
  case 'SEER_ACTION': return this.canPerformAction('SEER_ACTION')?this.renderSeerPanel():this.renderWaitingPanel(phase);
  case 'GUARD_ACTION': return this.canPerformAction('GUARD_ACTION')?this.renderGuardPanel():this.renderWaitingPanel(phase);
  case 'WITCH_ACTION': return this.canPerformAction('WITCH_ACTION')?this.renderWitchPanel():this.renderWaitingPanel(phase);
  case 'HUNTER_ACTION': return this.hasRoleInPair('çŒäºº') ? this.renderHunterPanel() : ''; 
 }
},
renderWaitingPanel(phase){
 let msg = 'â³ ç­‰å¾…å…¶ä»–ç©å®¶è¡ŒåŠ¨...';
 if(this.hasRoleInPair(phase.replace('_ACTION',''))) msg = 'æ­¤é˜¶æ®µä½ æ— æ³•è¡ŒåŠ¨æˆ–å·²è¡ŒåŠ¨ã€‚';
 this.dom.actionPanel.innerHTML = `<div class="action-feedback"><p style="font-size:18px;">${msg}</p></div>`;
},
swapIdentities(){
 const [id1,id2]=this.playerData.identities;
 db.ref(`games/${this.gameId}/players/${this.playerId}/identities`).set([id2,id1]);
},
confirmIdentities(){
 if(this.playerData.isReady)return;
 if(!confirm('ç¡®å®šé”å®šèº«ä»½é¡ºåºï¼Ÿé”å®šåå°†æ— æ³•æ›´æ”¹ã€‚'))return;
 db.ref(`games/${this.gameId}/players/${this.playerId}/isReady`).set(true);
},

renderWolfPanel(){
 this.initWolfChat();
 const myVote=(this.allPlayers[this.playerId] || {}).wolfVote;
 const minWolfId = this.getMinWolfId();
 const isLeader = this.playerId == minWolfId;
 
 const btns=Object.values(this.allPlayers).filter(p=>p.isAlive).map(p=>
  `<button class="action-btn ${myVote==p.id?'selected':''}" data-id="${p.id}">${p.id}å·</button>`).join('');
 
 let html = `<h3>ğŸº é€‰æ‹©å‡»æ€ç›®æ ‡</h3><div>${btns}</div>`;
 
 if(isLeader) {
    html += `<div style="margin-top:20px;">
      <button id="wolf-confirm" class="confirm-btn">âœ… ç¡®å®šå‡»æ€</button>
      <p style="color:var(--warning);font-size:14px;margin-top:10px;">ä½ æ˜¯åºå·æœ€å°çš„ç‹¼äººï¼Œç”±ä½ ç¡®å®šæœ€ç»ˆç›®æ ‡</p>
    </div>`;
 } else {
    html += `<p style="color:var(--text);font-size:14px;margin-top:10px;">ç­‰å¾… ${minWolfId}å· ç‹¼äººç¡®å®šæœ€ç»ˆç›®æ ‡</p>`;
 }
 
 this.dom.actionPanel.innerHTML = html;
 document.querySelectorAll('.action-btn').forEach(b=>b.onclick=()=>this.submitWolfVote(b.dataset.id));
 
 if(isLeader && this.$('wolf-confirm')) {
    this.$('wolf-confirm').onclick = () => this.confirmWolfKill();
 }
},

submitWolfVote(targetId){
 db.ref(`games/${this.gameId}/players/${this.playerId}/wolfVote`).set(targetId);
 db.ref(`games/${this.gameId}/wolfVotes/${this.playerId}`).set(targetId);
},

async confirmWolfKill() {
 const minWolfId = this.getMinWolfId();
 if(this.playerId != minWolfId) return;
 
 const myVote = this.allPlayers[this.playerId].wolfVote;
 if(!myVote) {
    alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç›®æ ‡ï¼');
    return;
 }
 
 await db.ref(`games/${this.gameId}/nightActions/wolfKill`).set(myVote);
 await db.ref(`games/${this.gameId}/actionCompleted/${this.playerId}_WOLF_ACTION`).set(true);
 this.dom.actionPanel.innerHTML = `<div class="action-feedback">
    <p style="font-size:20px;">âœ… å·²ç¡®å®šå‡»æ€ ${myVote}å·</p>
 </div>`;
},

initWolfChat(){
 if(this.wolfChatListener || !this.canSeeWolfChat())return;
 this.dom.wolfChatArea.classList.remove('hidden');
 this.dom.wolfChatArea.innerHTML=`<div class="wolf-chat-box">
   <h3>ğŸº ç‹¼äººé¢‘é“</h3>
   <div id="wolf-chat"></div>
   <div style="display:flex;gap:10px;">
     <input id="wolf-input" placeholder="è¾“å…¥æ¶ˆæ¯..." style="flex:1;">
     <button id="wolf-send" class="action-btn">ğŸ“¤ å‘é€</button>
   </div>
   <div id="wolf-votes-summary"></div>
 </div>`;
 
 // è®¾ç½®èŠå¤©ç›‘å¬å™¨ - ä¿®å¤ï¼šä½¿ç”¨ child_added
 this.wolfChatListener = db.ref(`games/${this.gameId}/wolfChat`)
    .orderByChild('timestamp')
    .on('child_added', snap => this.appendWolfMsg(snap.val()));
 this.wolfVotesListener=db.ref(`games/${this.gameId}/wolfVotes`).on('value',s=>this.updateWolfVotes(s.val()));
 
 // ç»‘å®šå‘é€æŒ‰é’®
 setTimeout(() => {
   const sendBtn = this.$('wolf-send');
   const input = this.$('wolf-input');
   if(sendBtn && input) {
     sendBtn.onclick = () => {
       if(!input.value.trim()) return;
       // ä¿®å¤ï¼šç›´æ¥å†™å…¥æœ¬åœ°æ—¶é—´æˆ³
       db.ref(`games/${this.gameId}/wolfChat`).push().set({
         senderId: this.playerId,
         text: input.value.trim(),
         timestamp: Date.now()
       }).then(() => {
         input.value = '';
       }).catch(err => {
         console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', err);
         alert('å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•');
       });
     };
     
     // æ”¯æŒå›è½¦å‘é€
     input.onkeypress = (e) => {
       if(e.key === 'Enter' && !e.shiftKey) {
         e.preventDefault();
         sendBtn.click();
       }
     };
   }
 }, 100);
},

// æ–°å¢ï¼šè¿½åŠ å•æ¡æ¶ˆæ¯
appendWolfMsg(msg){
  const node = this.$('wolf-chat'); 
  if(!node) return;
  node.insertAdjacentHTML('beforeend',
    `<div style="margin:5px 0;"><strong>${msg.senderId}å·:</strong> ${msg.text}</div>`);
  node.scrollTop = node.scrollHeight;
},

updateWolfVotes(votesData){
 const summary=this.$('wolf-votes-summary');if(!summary)return;
 const votes=votesData||{};
 const counts={};
 Object.values(votes).forEach(v=>{counts[v]=(counts[v]||0)+1;});
 let summaryHtml = '<h4>ğŸ“Š æŠ•ç¥¨æƒ…å†µ:</h4><div style="display:grid;gap:5px;">';
 Object.entries(counts).forEach(([t,c])=>{
    summaryHtml += `<div style="padding:8px;background:rgba(255,255,255,0.05);border-radius:8px;">
      ${t}å·: <strong>${c}</strong>ç¥¨
    </div>`;
 });
 summaryHtml += '</div>';
 summary.innerHTML = summaryHtml;
},

stopWolfListeners(){
 if(this.wolfChatListener){
   db.ref(`games/${this.gameId}/wolfChat`).off('child_added',this.wolfChatListener);
   this.wolfChatListener=null;
 }
 if(this.wolfVotesListener){
   db.ref(`games/${this.gameId}/wolfVotes`).off('value',this.wolfVotesListener);
   this.wolfVotesListener=null;
 }
 this.dom.wolfChatArea.classList.add('hidden');
 this.dom.wolfChatArea.innerHTML = ''; // æ¸…ç©ºå†…å®¹
},

renderSeerPanel(){
 const btns=Object.values(this.allPlayers).filter(p=>p.id!=this.playerId)
  .map(p=>`<button class="action-btn" data-id="${p.id}">${p.id}å·</button>`).join('');
 this.dom.actionPanel.innerHTML=`<h3>ğŸ”® è¯·é€‰æ‹©æŸ¥éªŒç›®æ ‡</h3><div>${btns}</div>`;
 document.querySelectorAll('.action-btn').forEach(b=>b.onclick=()=>this.seerCheck(b.dataset.id));
},
async seerCheck(targetId){
 const targetPlayer=this.allPlayers[targetId];
 const roles=targetPlayer.originalIdentities.map(i=>ROLES[i.role]);
 let result='å¥½äºº';
 if(roles.some(r=>r.faction==='bad'&&!r.isInvisible)){ 
    result='ç‹¼äºº';
 } else if(roles.some(r=>r.faction==='bad'&&r.isInvisible)){
  const otherWolvesExist=Object.values(this.allPlayers).some(p=>
    p.id!=targetId&&p.isAlive&&p.originalIdentities.some(i=>ROLES[i.role].faction==='bad'&&!ROLES[i.role].isInvisible)
  );
  result=otherWolvesExist?'å¥½äºº':'ç‹¼äºº';
 }
 await db.ref(`games/${this.gameId}/players/${this.playerId}/seerResults/${targetId}`).set(result);
 await db.ref(`games/${this.gameId}/actionCompleted/${this.playerId}_SEER_ACTION`).set(true);
 this.dom.actionPanel.innerHTML=`<div class="action-feedback">
    <p style="font-size:20px;">æŸ¥éªŒç»“æœ: ${targetId}å·æ˜¯ <strong style="color:${result==='ç‹¼äºº'?'var(--danger)':'var(--success)'}">${result==='ç‹¼äºº'?'ğŸº ç‹¼äºº':'ğŸ˜‡ å¥½äºº'}</strong></p>
 </div>`;
},

renderGuardPanel(){
 const lastTarget=this.playerData.lastGuardTarget;
 const btns=Object.values(this.allPlayers).filter(p=>p.isAlive)
  .map(p=>`<button class="action-btn" data-id="${p.id}" ${p.id==lastTarget?'disabled':''}>${p.id}å· ${p.id==lastTarget?'(ä¸å¯è¿ç»­å®ˆæŠ¤)':''}</button>`).join('');
 this.dom.actionPanel.innerHTML=`<h3>ğŸ›¡ï¸ è¯·é€‰æ‹©å®ˆæŠ¤ç›®æ ‡</h3><div>${btns}</div>`;
 document.querySelectorAll('.action-btn').forEach(b=>b.onclick=()=>this.guardProtect(b.dataset.id));
},
async guardProtect(targetId){
 // åå°å…œåº•æ£€æŸ¥
 if(targetId == this.playerData.lastGuardTarget) {
    alert('ä¸èƒ½è¿ç»­å®ˆæŠ¤åŒä¸€ä¸ªäººï¼');
    return;
 }
 await db.ref(`games/${this.gameId}/nightActions/guard`).set(targetId);
 await db.ref(`games/${this.gameId}/players/${this.playerId}/lastGuardTarget`).set(targetId);
 await db.ref(`games/${this.gameId}/actionCompleted/${this.playerId}_GUARD_ACTION`).set(true);
 this.dom.actionPanel.innerHTML=`<div class="action-feedback">
    <p style="font-size:20px;">ğŸ›¡ï¸ å·²å®ˆæŠ¤ ${targetId}å·</p>
 </div>`;
},

async renderWitchPanel(){
 let html='<h3>ğŸ§ª å¥³å·«è¡ŒåŠ¨</h3>';
 const canUseCure=!this.playerData.hasUsedCure;
 const canUsePoison=!this.playerData.hasUsedPoison;
 html+=`<div style="margin-bottom:20px;font-size:18px;">
    è§£è¯: ${canUseCure?'<span style="color:var(--success)">âœ“ å¯ç”¨</span>':'<span style="color:var(--danger)">âœ— å·²ç”¨</span>'} | 
    æ¯’è¯: ${canUsePoison?'<span style="color:var(--success)">âœ“ å¯ç”¨</span>':'<span style="color:var(--danger)">âœ— å·²ç”¨</span>'}
 </div>`;
 
 const snap = await db.ref(`games/${this.gameId}/nightActions/wolfKill`).once('value');
 const wolfTarget = snap.val();
 
 if(canUseCure&&wolfTarget){
    let cureDisabled = (this.gameState.round === 1 && wolfTarget == this.playerId);
    html += `<div style="margin-bottom:20px;">
      <button id="btn-cure" class="action-btn" ${cureDisabled ? 'disabled' : ''}>
        ğŸ’‰ ä½¿ç”¨è§£è¯ (æ•‘${wolfTarget}å·)
      </button> 
      ${cureDisabled ? '<span style="color:var(--danger);font-size:14px;">é¦–å¤œä¸å¯è‡ªæ•‘</span>' : ''}
    </div>`;
 }
 if(canUsePoison){
  const list=Object.values(this.allPlayers).filter(p=>p.isAlive).map(p=>`<button class="action-btn" data-id="${p.id}">â˜ ï¸ ${p.id}å·</button>`).join('');
  html+='<h4>ä½¿ç”¨æ¯’è¯</h4><div>'+list+'</div>';
 }
 html+='<div style="margin-top:20px;"><button id="btn-pass" class="control-btn">â­ï¸ è·³è¿‡</button></div>';
 this.dom.actionPanel.innerHTML=html;

 if(this.$('btn-cure')) this.$('btn-cure').onclick=()=>this.useWitchDrug('cure');
 document.querySelectorAll('.action-btn[data-id]').forEach(b=>b.onclick=()=>this.useWitchDrug('poison',b.dataset.id));
 this.$('btn-pass').onclick=()=>this.useWitchDrug('skip');
},
async useWitchDrug(type,targetId=null){
 let updates={}, msg='';
 if(type==='cure'){
    updates[`players/${this.playerId}/hasUsedCure`]=true;
    updates['nightActions/witchCure']=true;
    msg='ğŸ’‰ ä½ ä½¿ç”¨äº†çè´µçš„è§£è¯ã€‚';
 } else if(type==='poison'){
    updates[`players/${this.playerId}/hasUsedPoison`]=true;
    updates['nightActions/witchPoison']=targetId;
    msg=`â˜ ï¸ ä½ å¯¹ ${targetId}å· ä½¿ç”¨äº†æ¯’è¯ã€‚`;
 } else {
    msg='â­ï¸ ä½ é€‰æ‹©æœ¬å›åˆä¸ä½¿ç”¨è¯å‰‚ã€‚';
 }
 updates[`actionCompleted/${this.playerId}_WITCH_ACTION`]=true;
 await db.ref(`games/${this.gameId}`).update(updates);
 this.dom.actionPanel.innerHTML=`<div class="action-feedback"><p style="font-size:20px;">${msg}</p></div>`;
},

renderKnightPanel(){
 const btns=Object.values(this.allPlayers).filter(p=>p.isAlive&&p.id!=this.playerId)
  .map(p=>`<button class="action-btn" data-id="${p.id}">âš”ï¸ ${p.id}å·</button>`).join('');
 this.dom.actionPanel.innerHTML=`<h3>âš”ï¸ éª‘å£«æŠ€èƒ½ï¼šå†³æ–—</h3>
    <p style="color:var(--warning);">é€‰æ‹©ä¸€åç©å®¶è¿›è¡Œå†³æ–—ã€‚å¦‚æœä»–æ˜¯ç‹¼äººé˜µè¥ï¼Œä»–æ­»äº¡ï¼Œæ¸¸æˆè¿›å…¥é»‘å¤œï¼›å¦åˆ™ï¼Œä½ æ­»äº¡ã€‚</p>
    <div>${btns}</div>`;
 document.querySelectorAll('.action-btn').forEach(b=>b.onclick=()=>this.knightDuel(b.dataset.id));
},
async knightDuel(targetId){
 if(!confirm(`ç¡®å®šè¦ä¸ ${targetId}å· å†³æ–—å—ï¼Ÿ`)) return;
 const targetPlayer=this.allPlayers[targetId];
 const isBadFaction=targetPlayer.originalIdentities.some(i=>ROLES[i.role].faction==='bad');
 
 await db.ref(`games/${this.gameId}/actionCompleted/${this.playerId}_KNIGHT_ACTION`).set(true);
 
 if(isBadFaction){
    await this.kill(targetId,'DUEL');
    await this.updatePhase('NIGHT_START');
 } else {
    await this.kill(this.playerId,'DUEL');
 }
 this.dom.actionPanel.innerHTML=`<div class="action-feedback"><p style="font-size:20px;">âš”ï¸ å†³æ–—å·²å®Œæˆ</p></div>`;
},

renderHunterPanel(){
 if(!this.playerData.isAlive) { 
    const btns=Object.values(this.allPlayers).filter(p=>p.id!=this.playerId)
      .map(p=>`<button class="action-btn" data-id="${p.id}" ${!p.isAlive?'disabled':''}>${p.id}å·</button>`).join('');
    this.dom.actionPanel.innerHTML=`<h3>ğŸ”« çŒäººæŠ€èƒ½ï¼šå¼€æª</h3>
        <p style="color:var(--warning);">ä½ å·²å‡ºå±€ï¼Œè¯·é€‰æ‹©ä¸€åç©å®¶å¸¦èµ°ã€‚</p>
        <div>${btns}</div>
        <div style="margin-top:20px;">
          <button id="hunter-skip" class="control-btn">ğŸš« æ”¾å¼ƒå¼€æª</button>
        </div>`;
    document.querySelectorAll('.action-btn[data-id]').forEach(b=>b.onclick=()=>this.hunterShoot(b.dataset.id));
    this.$('hunter-skip').onclick=()=>this.hunterShoot(null);
 }
},
async hunterShoot(targetId){
 if(targetId && !confirm(`ç¡®å®šè¦å¸¦èµ° ${targetId}å· å—ï¼Ÿ`)) return;
 
 await db.ref(`games/${this.gameId}/actionCompleted/${this.playerId}_HUNTER_ACTION`).set(true);
 
 if(targetId) await this.kill(targetId,'SHOT');
 await this.updatePhase('DAY');
 this.dom.actionPanel.innerHTML=`<div class="action-feedback"><p style="font-size:20px;">ğŸ”« çŒäººè¡ŒåŠ¨ç»“æŸ</p></div>`;
},

/* =========================================================
   æ ¸å¿ƒæ¸¸æˆæµç¨‹ (å‡»æ€ã€ç»“ç®—)
   ========================================================= */
async kill(playerId, cause, playersSnapshot = null, livesCost = 1){
 const players = playersSnapshot || (await db.ref(`games/${this.gameId}/players`).once('value')).val();
 const player = players[playerId];
 if(!player||!player.isAlive)return;

 if(this.getActiveRole(player)==='ç™½ç—´' && cause==='VOTE'){
  await db.ref(`games/${this.gameId}/players/${playerId}`).update({isExposedIdiot:true});
  await this.checkVictory();
  return;
 }
 
 const updates={};
 const newDeaths = Math.min(player.deaths + livesCost, 2); // æœ€å¤š2æ¡å‘½
 const isNowDead = newDeaths >= 2;
 updates[`players/${playerId}/deaths`]=newDeaths;
 updates[`players/${playerId}/isAlive`]=!isNowDead;
 await db.ref(`games/${this.gameId}`).update(updates);

 // å¤„ç†äº¡è¯­æŠ€èƒ½
 if(isNowDead && this.hasRoleInPair.call({playerData:player}, 'çŒäºº') && cause !== 'POISON'){
    await this.updatePhase('HUNTER_ACTION');
 } else if(newDeaths === 1 && player.identities[0].role === 'çŒäºº' && cause !== 'POISON') {
    // ç¬¬ä¸€æ¡å‘½æ˜¯çŒäººï¼Œè¢«æ€æ—¶ä¹Ÿå¯ä»¥å¼€æª
    await this.updatePhase('HUNTER_ACTION');
 } else {
    await this.checkVictory();
 }
},

/* =========================================================
   èƒœè´Ÿåˆ¤å®š
   ========================================================= */
async checkVictory(){
 const snap=await db.ref(`games/${this.gameId}`).once('value');
 const g=snap.val();
 if(g.state.phase==='GAME_OVER')return false;

 let wolvesAlive=0,godsAlive=0,goldenBabiesAlive=0;
 Object.values(g.players).forEach(p=>{
  if(!p.isAlive)return;
  const roles=p.originalIdentities.map(i=>ROLES[i.role]);
  const isGoldenBaby=roles[0].name==='å¹³æ°‘'&&roles[1].name==='å¹³æ°‘';
  const isGoodFaction=roles.every(r=>r.faction==='good');
  
  if(isGoldenBaby) goldenBabiesAlive++;
  if(isGoodFaction&&!isGoldenBaby&&roles.some(r=>r.isGod)) godsAlive++;
  if(roles.some(r=>r.faction==='bad')) wolvesAlive++;
 });

 let winner=null;
 if(wolvesAlive===0) winner='ğŸ˜‡ å¥½äººèƒœåˆ© (ç‹¼äººå…¨ç­)';
 else if(g.state.peaceNightStreak>=3) winner='ğŸ˜‡ å¥½äººèƒœåˆ© (è¿ç»­ä¸‰æ™šå¹³å®‰å¤œ)';
 else if(godsAlive===0) winner='ğŸº ç‹¼äººèƒœåˆ© (ç¥èŒå…¨ç­)';
 else if(goldenBabiesAlive===0) winner='ğŸº ç‹¼äººèƒœåˆ© (é‡‘å®å®å…¨ç­)';
 
 if(winner){
  await db.ref(`games/${this.gameId}/state`).update({phase:'GAME_OVER',winner});
  return false;
 }
 return true;
}
};

/* ===================== å¯åŠ¨å…¥å£ ===================== */
document.addEventListener('DOMContentLoaded',()=>App.init());
</script>
</body>
</html>
