<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>双身份狼人杀 - 电子法官</title>
<!-- === 样式（无结构性变化，仅略作压缩） === -->
<style>
:root{--bg:#1a1a2e;--p:#16213e;--s:#0f3460;--a:#e94560;--t:#dcdcdc;
--f:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif}
html,body{margin:0;padding:0;background:var(--bg);color:var(--t);font-family:var(--f)}
body{display:flex;justify-content:center;align-items:flex-start;min-height:100vh;padding:20px}
#app{width:100%;max-width:800px;background:var(--p);border-radius:12px;padding:25px;
box-shadow:0 10px 30px rgba(0,0,0,.5)}
h1,h2,h3{color:var(--a);border-bottom:2px solid var(--s);padding-bottom:10px;text-align:center}
.hidden{display:none!important}
button{background:var(--a);color:#fff;border:none;padding:12px 20px;border-radius:8px;cursor:pointer;
font-size:16px;font-weight:700;margin:5px;transition:.3s}
button:hover{background:#ff6681;transform:translateY(-2px)}
button:disabled{background:#555;cursor:not-allowed;transform:none}
button.selected{background:#4caf50!important}
input[type=number],input[type=text]{width:60px;padding:8px;border-radius:5px;border:1px solid var(--s);
background:var(--bg);color:var(--t);font-size:16px;text-align:center}
.role-setup-item,.player-list-item,.action-item{display:flex;justify-content:space-between;align-items:center;
background:var(--s);padding:15px;border-radius:8px;margin-bottom:10px}
.player-list-item.dead .player-name,.dead-identity{text-decoration:line-through;color:#ff6b6b}
.player-list-item.dead-all{opacity:.5}
.player-list-item.dead-all .player-name{text-decoration:line-through;color:#ff6b6b}
.thief-copy{color:#aaa;font-style:italic}
#links{margin-top:20px;background:var(--bg);padding:15px;border-radius:8px}
.link-tpl{background:var(--s);padding:15px;border-radius:8px;margin-bottom:15px}
.link-tpl input{width:calc(100% - 90px);margin-top:10px}
#game-status,#player-status{font-size:20px;font-weight:700;text-align:center;padding:20px;
background:var(--s);border-radius:8px;margin-bottom:20px;color:var(--a)}
#persist{background:rgba(0,0,0,.2);padding:15px;border-radius:8px;margin-bottom:20px}
.wolf-chat-box{border:1px solid var(--s);border-radius:8px;padding:10px;background:var(--bg);margin-bottom:15px}
#wolf-chat{height:150px;overflow-y:auto;padding:10px;margin-bottom:10px}
.wolf-msg{margin-bottom:5px;padding:5px;border-radius:3px}
.wolf-msg strong{color:var(--a)}
.wolf-msg.vote-msg{background:rgba(233,69,96,.1);border-left:3px solid var(--a);padding-left:10px}
.swap-box{background:rgba(233,69,96,.1);border:2px solid var(--a);padding:15px;border-radius:8px;
margin:15px 0;text-align:center}
.identity-preview{font-size:18px;padding:10px;margin:10px 0;background:var(--s);border-radius:5px}
.ready-status{color:#4caf50;font-weight:700}.not-ready-status{color:#ffc107}
.action-feedback{background:rgba(76,175,80,.2);border:2px solid #4caf50;padding:15px;border-radius:8px;
text-align:center;margin:10px 0}
.action-waiting{background:rgba(255,193,7,.2);border:2px solid #ffc107;padding:15px;border-radius:8px;
text-align:center;margin:10px 0}
.ready-indicator{display:inline-block;width:10px;height:10px;border-radius:50%;margin-left:5px}
.ready-indicator.ready{background:#4caf50}.ready-indicator.not-ready{background:#ffc107}
.action-complete-btn{background:#4caf50;margin-top:15px}
.player-lives{display:inline-flex;align-items:center;gap:5px}.life-heart{color:var(--a);font-size:18px}
.life-heart.lost{color:#555}.kill-btn{background:#ff4444;padding:8px 12px;font-size:14px}
.kill-btn:hover{background:#ff6666}.night-result{background:rgba(233,69,96,.2);border:2px solid var(--a);
padding:15px;border-radius:8px;margin:15px 0}
.wolf-votes-summary{background:rgba(255,193,7,.1);padding:10px;border-radius:5px;margin:10px 0}
.waiting-msg{color:#ffc107;font-style:italic;text-align:center;padding:10px}
.hidden-wolf-note{font-size:12px;color:#aaa;font-style:italic}
</style>
</head>
<body>
<div id="app">
  <!-- ========== 主持端 ========== -->
  <div id="host-view">
    <h1>双身份狼人杀 - 主持端</h1>
    <div id="setup">
      <h2>1. 身份配置</h2><div id="role-setup"></div>
      <p>总身份数: <span id="total-roles">0</span> | 预计玩家数: <span id="player-cnt">0</span></p>
      <button id="btn-create">创建游戏</button>
    </div>
    <div id="links" class="hidden">
      <h2>2. 分享链接</h2><div id="links-box"></div>
    </div>
    <div id="host-ctrl" class="hidden">
      <h2>3. 游戏控制</h2>
      <div id="host-status"></div><div id="ready-box"></div>
      <button id="btn-start">锁定身份，开始游戏</button>
      <button id="btn-night">天黑请闭眼</button>
      <button id="btn-day">天亮了</button><hr>
      <h3>夜晚行动</h3>
      <button class="host-action" data-action="WOLF_ACTION">狼人行动</button>
      <button class="host-action" data-action="WITCH_ACTION">女巫行动</button>
      <button class="host-action" data-action="SEER_ACTION">预言家行动</button>
      <button class="host-action" data-action="GUARD_ACTION">守卫行动</button>
      <div id="action-feedback-box"></div>
      <div id="night-result" class="hidden"></div><hr>
      <h3>游戏管理</h3>
      <button id="btn-reveal">复盘：显示所有身份</button>
      <div id="host-player-list"></div>
    </div>
  </div>

  <!-- ========== 玩家端 ========== -->
  <div id="player-view" class="hidden">
    <h1>双身份狼人杀</h1>
    <div id="player-info">
      <h2 id="pid-show"></h2>
      <h3>你的身份是:</h3>
      <div id="my-ids" class="player-list-item"></div>
      <div id="swap-area" class="hidden">
        <div class="swap-box">
          <p>点击按钮预览身份交换效果：</p>
          <button id="btn-preview">预览交换</button>
          <div id="preview" class="identity-preview hidden"></div>
          <button id="btn-confirm">确定身份顺序</button>
        </div>
      </div>
    </div><hr>
    <div id="game-area">
      <div id="player-status">等待游戏开始...</div>
      <div id="persist" class="hidden"></div>
      <div id="action-panel"></div>
      <div id="wolf-chat-area" class="hidden"></div>
      <h3>玩家列表</h3><div id="player-list"></div>
    </div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
/* ============ Firebase init ============ */
const firebaseConfig={apiKey:"AIzaSyCEAgB6DoY8YA6lZnYblhIDVTYH_q8UimI",
authDomain:"werewolf-game-master-1f37f.firebaseapp.com",
databaseURL:"https://werewolf-game-master-1f37f-default-rtdb.asia-southeast1.firebasedatabase.app",
projectId:"werewolf-game-master-1f37f",storageBucket:"werewolf-game-master-1f37f.appspot.com",
messagingSenderId:"626014452910",appId:"1:626014452910:web:35b6eba412f95f1878013f"};
firebase.initializeApp(firebaseConfig);const db=firebase.database();

/* ============ 常量 ============ */
const ROLES={
'平民':{name:'平民',faction:'good',isGod:false},
'守卫':{name:'守卫',faction:'good',isGod:true},
'白痴':{name:'白痴',faction:'good',isGod:true},
'预言家':{name:'预言家',faction:'good',isGod:true},
'骑士':{name:'骑士',faction:'good',isGod:true},
'女巫':{name:'女巫',faction:'good',isGod:true},
'猎人':{name:'猎人',faction:'good',isGod:true},
'狼人':{name:'狼人',faction:'bad',isGod:false},
'隐狼':{name:'隐狼',faction:'bad',isGod:false,isInvisible:true},
'盗贼':{name:'盗贼',faction:'neutral',isGod:false,isThief:true}
};
const DEFAULT_SETUP={'平民':6,'守卫':1,'白痴':1,'预言家':1,'骑士':1,'女巫':1,'猎人':1,'狼人':2,'隐狼':1,'盗贼':1};
const FORBIDDEN=[['预言家','狼人'],['预言家','隐狼'],['盗贼','狼人'],
['盗贼','隐狼'],['隐狼','狼人'],['隐狼','隐狼']];

/* ============ 应用主对象 ============ */
const App={
/* ------- 属性 ------- */
gameId:null,playerId:null,isHost:false,playerData:null,gameState:null,
allPlayers:{},currentIdentityOrder:null,isPreview:false,
wolfChatListener:null,wolfVotesListener:null,allWolfVotes:{},hasVoted:false,
/* ------- 初始化 ------- */
init(){
 this.$=s=>document.getElementById(s);
 const q=new URLSearchParams(location.search);
 this.gameId=q.get('game');this.playerId=q.get('player');
 this.cacheDom();
 if(this.gameId&&this.playerId){this.isHost=false;this.show('player');this.initPlayer();}
 else{this.isHost=true;this.show('host');this.initHost();}
},
cacheDom(){
 this.dom={
  hostView:this.$('host-view'),playerView:this.$('player-view'),
  roleSetup:this.$('role-setup'),totalRoles:this.$('total-roles'),playerCnt:this.$('player-cnt'),
  btnCreate:this.$('btn-create'),links:this.$('links'),linksBox:this.$('links-box'),
  hostCtrl:this.$('host-ctrl'),btnStart:this.$('btn-start'),btnNight:this.$('btn-night'),
  btnDay:this.$('btn-day'),hostActions:document.querySelectorAll('.host-action'),
  hostPlayerList:this.$('host-player-list'),btnReveal:this.$('btn-reveal'),
  hostStatus:this.$('host-status'),readyBox:this.$('ready-box'),actionFeedback:this.$('action-feedback-box'),
  nightResult:this.$('night-result'),
  pidShow:this.$('pid-show'),myIds:this.$('my-ids'),swapArea:this.$('swap-area'),
  btnPreview:this.$('btn-preview'),btnConfirm:this.$('btn-confirm'),preview:this.$('preview'),
  playerStatus:this.$('player-status'),persist:this.$('persist'),actionPanel:this.$('action-panel'),
  playerList:this.$('player-list'),wolfChatArea:this.$('wolf-chat-area')
 };
},
show(v){this.dom.hostView.classList.add('hidden');this.dom.playerView.classList.add('hidden');
 if(v==='host')this.dom.hostView.classList.remove('hidden');else this.dom.playerView.classList.remove('hidden');},

/* ============ 主持端逻辑 ============ */
initHost(){
 this.renderRoleSetup();
 this.dom.btnCreate.onclick=()=>this.createGame();
 this.dom.btnStart.onclick=()=>this.startGame();
 this.dom.btnNight.onclick=()=>this.nightStart();
 this.dom.btnDay.onclick=()=>this.dayStart();
 this.dom.hostActions.forEach(b=>b.onclick=()=>this.triggerAction(b.dataset.action));
},
renderRoleSetup(){
 let h='';for(const r in DEFAULT_SETUP){
  h+=`<div class="role-setup-item"><span>${r}</span>
       <input type="number" id="role-${r}" min="0" value="${DEFAULT_SETUP[r]}"></div>`;
 }
 this.dom.roleSetup.innerHTML=h;
 this.dom.roleSetup.oninput=()=>this.updateRoleCnt();this.updateRoleCnt();
},
updateRoleCnt(){
 let tot=0;this.dom.roleSetup.querySelectorAll('input').forEach(i=>tot+=+i.value||0);
 this.dom.totalRoles.textContent=tot;this.dom.playerCnt.textContent=tot%2===0?tot/2:'无效';
},
async createGame(){
 this.dom.btnCreate.disabled=true;this.dom.btnCreate.textContent='生成牌组中...';
 /* 收集身份池 */
 let pool=[];this.dom.roleSetup.querySelectorAll('input').forEach(i=>{
  const name=i.id.replace('role-','');for(let k=0;k<(+i.value||0);k++)pool.push(name);
 });
 if(pool.length===0||pool.length%2){alert('身份总数必须为偶数且>0');location.reload();return;}
 let pairs,attempt=0;
 do{pairs=this.deal(pool);attempt++;if(attempt>2000){alert('配牌失败');return;}}while(!pairs);
 this.gameId=db.ref('games').push().key;
 const pc=pool.length/2,players={};
 for(let i=1;i<=pc;i++){
  players[i]={id:i,identities:pairs[i-1],originalIdentities:[...pairs[i-1]],
   deaths:0,isAlive:true,isReady:false,seerResults:{},lastGuardTarget:null,
   hasUsedPoison:false,hasUsedCure:false};
 }
 await db.ref(`games/${this.gameId}`).set({
  state:{phase:'SETUP',round:0},players,config:{playerCount:pc},
  wolfChat:{},actionCompleted:{},nightActions:{},wolfVotes:{}
 });
 this.listenGame();this.showLinks(pc);
 this.dom.btnCreate.classList.add('hidden');this.dom.links.classList.remove('hidden');
 this.dom.hostCtrl.classList.remove('hidden');
},
deal(pool){
 const arr=[...pool].sort(()=>Math.random()-.5),prs=[];
 for(let i=0;i<arr.length;i+=2)prs.push([arr[i],arr[i+1]]);
 const fin=[];for(const p of prs){
  let np=[...p];
  if(p[0]==='盗贼'){np=[{role:p[1],isThiefCopy:true},{role:p[1],isThiefCopy:false}]}
  else if(p[1]==='盗贼'){np=[{role:p[0],isThiefCopy:false},{role:p[0],isThiefCopy:true}]}
  else{np=[{role:p[0],isThiefCopy:false},{role:p[1],isThiefCopy:false}]}
  fin.push(np);
 }
 for(const p of fin){
  const a=p[0].role,b=p[1].role;
  for(const f of FORBIDDEN)if((a===f[0]&&b===f[1])||(a===f[1]&&b===f[0]))return null;
 }
 let gb=0;fin.forEach(p=>{if(p[0].role==='平民'&&p[1].role==='平民')gb++;});
 if(gb<1||gb>2)return null;return fin;
},
showLinks(pc){
 const base=location.href.split('?')[0],tpl=`${base}?game=${this.gameId}&player=[N]`;
 let h=`<div class="link-tpl"><p><strong>通用模板：</strong></p>
 <p>把 [N] 替换为 1-${pc}</p><input value="${tpl}" readonly>
 <button onclick="App.copy('${tpl}')">复制</button></div><details><summary>各玩家链接</summary>`;
 for(let i=1;i<=pc;i++){const l=`${base}?game=${this.gameId}&player=${i}`;
  h+=`<div style="margin:5px 0;"><label>玩家${i}: </label><input value="${l}" readonly>
      <button onclick="App.copy('${l}')">复制</button></div>`;
 }
 h+='</details>';this.dom.linksBox.innerHTML=h;
},
listenGame(){
 db.ref(`games/${this.gameId}`).on('value',snap=>{
  const g=snap.val();if(!g)return;
  this.gameState=g.state;this.allPlayers=g.players||{};
  this.renderPlayerList(false);this.updateReady();
  /* 夜晚结果回填 */
 });
},
updateReady(){
 const ps=Object.values(this.allPlayers),tot=ps.length,ready=ps.filter(p=>p.isReady).length;
 let h='<h3>准备情况</h3>';ps.forEach(p=>{
  h+=`${p.id}号: ${p.isReady?'<span class="ready-status">已确定</span>':
  '<span class="not-ready-status">未确定</span>'}<br>`;});
 h+=`<p>${ready}/${tot} 已确定</p>`;this.dom.readyBox.innerHTML=h;
 this.dom.btnStart.disabled=ready<tot;
 this.dom.btnStart.textContent=ready===tot?'所有玩家已准备，开始游戏':
 `等待玩家 (${ready}/${tot})`;
},
renderPlayerList(reveal){
 let h='';for(const id in this.allPlayers){
  const p=this.allPlayers[id],lives=2-p.deaths;
  let ids='';if(reveal){
   const fmt=i=>i.isThiefCopy?`<span class="thief-copy">${i.role}</span>`:i.role;
   ids=` [${fmt(p.identities[0])}+${fmt(p.identities[1])}]`;
  }
  let liveHtml='<span class="player-lives">';
  for(let i=0;i<2;i++)liveHtml+=`<span class="life-heart ${i<lives?'':'lost'}">❤</span>`;
  liveHtml+='</span>';
  h+=`<div class="player-list-item ${!p.isAlive?'dead-all':p.deaths?'dead':''}">
        <span>玩家 ${p.id}${ids}</span><span>${liveHtml}</span>
        <button class="kill-btn" ${!p.isAlive?'disabled':''}
          onclick="App.kill(${p.id})">杀死</button>
        <span class="ready-indicator ${p.isReady?'ready':'not-ready'}"></span>
      </div>`;
 }
 this.dom.hostPlayerList.innerHTML=h;
 this.dom.btnReveal.onclick=()=>this.renderPlayerList(true);
},
kill(pid){
 const p=this.allPlayers[pid];if(!p||!p.isAlive)return;
 db.ref(`games/${this.gameId}/players/${pid}`).update({
  deaths:p.deaths+1,isAlive:p.deaths+1<2
 });
},
async startGame(){
 const rs=Object.values(this.allPlayers).every(p=>p.isReady);
 if(!rs){alert('仍有玩家未确定');return;}
 await db.ref(`games/${this.gameId}/state`).update({phase:'NIGHT_START',round:1});
 this.dom.btnStart.disabled=true;
},
nightStart(){
 db.ref(`games/${this.gameId}`).update({nightActions:{},wolfVotes:{},actionCompleted:{}});
 const r=this.gameState.round||1;
 db.ref(`games/${this.gameId}/state`).update({phase:'NIGHT_START',round:r});
 this.dom.nightResult.classList.add('hidden');
},
dayStart(){this.execNight().then(()=>{
 db.ref(`games/${this.gameId}/state`).update({phase:'DAY'});
});},
/* ---- 夜晚行动执行逻辑与触发按钮 ---- */
triggerAction(act){
 db.ref(`games/${this.gameId}/state`).update({phase:act});
 db.ref(`games/${this.gameId}/actionCompleted/${act}`).remove();
 /* 主持端提示（匿名） */
 this.dom.actionFeedback.innerHTML=
  `<div class="action-waiting"><p>等待玩家行动中…</p></div>`;
},
/* ---- 夜晚结算与共识处理 ---- */
async execNight(){
 const g=(await db.ref(`games/${this.gameId}`).once('value')).val();
 const na=g.nightActions||{},votes=g.wolfVotes||{};
 const wolfKill=na.wolfKill;/* 在共识阶段已写好 */
 const guard=na.guard, cured=na.witchCure, poison=na.witchPoison;
 let toKill=[],msg='';
 if(wolfKill){
  const prot=guard==wolfKill,cur=cured===true;
  if((prot&&cur)||(!prot&&!cur))toKill.push(wolfKill),
   msg+=`${wolfKill}号被狼人击杀\n`;
  else msg+=`${wolfKill}号被选中但存活\n`;
 }else msg+='狼人未击杀任何人\n';
 if(poison){toKill.push(poison);msg+=`${poison}号被女巫毒死\n`;}
 if(!toKill.length)msg='平安夜，无人死亡';
 const upd={},round=(g.state.round||1)+1;
 toKill.forEach(id=>{const p=g.players[id];if(!p||!p.isAlive)return;
  upd[`players/${id}/deaths`]=p.deaths+1;upd[`players/${id}/isAlive`]=(p.deaths+1)<2;});
 upd['state/round']=round;
 await db.ref(`games/${this.gameId}`).update(upd);
 this.dom.nightResult.innerHTML=`<div class="night-result"><h3>夜晚结果</h3><pre>${msg}</pre></div>`;
 this.dom.nightResult.classList.remove('hidden');
},
/* ============ 玩家端逻辑 ============ */
initPlayer(){
 this.dom.pidShow.textContent=`你是 ${this.playerId} 号玩家`;
 db.ref(`games/${this.gameId}`).on('value',snap=>{
  const g=snap.val();if(!g)return;
  this.gameState=g.state;this.allPlayers=g.players;this.playerData=g.players[this.playerId];
  if(!this.currentIdentityOrder&&this.playerData)
     this.currentIdentityOrder=[...this.playerData.identities];
  if(this.gameState.phase!=='WOLF_ACTION'){this.hasVoted=false;}
  this.renderPlayer();
 });
 this.dom.btnPreview.onclick=()=>this.togglePreview();
 this.dom.btnConfirm.onclick=()=>this.fixIdentity();
},
renderPlayer(){
 this.renderIds();this.renderStatus();this.renderList();this.renderPersist();this.renderAction();
 this.dom.swapArea.classList[
   (this.gameState.phase==='SETUP'&&!this.playerData.isReady)?'remove':'add']('hidden');
},
renderIds(usePreview){
 const ids=usePreview?this.currentIdentityOrder:this.playerData.identities;
 const [a,b]=ids;const fmt=i=>i.role?(i.isThiefCopy?
  `<span class="thief-copy">${i.role}</span>`:i.role):i;
 const dead=this.playerData.deaths;
 this.dom.myIds.innerHTML=`<div>${dead>=1?'<span class="dead-identity">':''}${fmt(a)}${dead>=1?'</span>':''}
 + ${dead>=2?'<span class="dead-identity">':''}${fmt(b)}${dead>=2?'</span>':''}</div>`;
},
renderStatus(){
 const ph={SETUP:'等待游戏开始…',NIGHT_START:'天黑请闭眼…',WOLF_ACTION:'狼人请行动…',
 WITCH_ACTION:'女巫请行动…',SEER_ACTION:'预言家请行动…',GUARD_ACTION:'守卫请行动…',
 DAY:`天亮了，第 ${this.gameState.round} 天`,GAME_OVER:'游戏结束！'};
 this.dom.playerStatus.textContent=ph[this.gameState.phase]||'进行中…';
},
renderList(){
 let h='';for(const id in this.allPlayers){const p=this.allPlayers[id];
  const life=2-p.deaths,status=life===2?'满血':life===1?'受伤':'出局';
  h+=`<div class="player-list-item ${!p.isAlive?'dead-all':p.deaths?'dead':''}">
       <span class="player-name">玩家 ${p.id}</span><span>${status}</span></div>`;
 }
 this.dom.playerList.innerHTML=h;
},
renderPersist(){
 let h='';if(this.canSeeWolf()){
  const wolves=Object.values(this.allPlayers).filter(p=>{
   if(p.id==this.playerId||!p.isAlive)return false;
   const act=this.activeOf(p);return['狼人','隐狼'].includes(act)&&
    (this.activeOf(this.playerData)==='隐狼'||act!=='隐狼');
  }).map(p=>p.id+'号').join('、');
  h+=`<div><strong>狼人阵营:</strong> ${wolves||'暂无'}</div>`;
 }
 if(this.hasActive('预言家')){
  const res=this.playerData.seerResults;const ls=Object.entries(res||{})
     .map(([id,r])=>`${id}号(${r})`).join('； ');
  if(ls)h+=`<div><strong>查验历史:</strong> ${ls}</div>`;
 }
 if(h){this.dom.persist.innerHTML=h;this.dom.persist.classList.remove('hidden')}
 else this.dom.persist.classList.add('hidden');
},
renderAction(){
 const ph=this.gameState.phase,can=this.canAct(ph);
 /* 若上一阶段已 consensus 则防止重复面板 */
 if(['SETUP','DAY','NIGHT_START'].includes(ph)){this.clearAct();return;}
 if(ph==='WOLF_ACTION'){this.renderWolfPanel();return;}
 if(!can){this.waitPanel(ph);return;}
 if(ph==='SEER_ACTION')this.seerPanel();
 else if(ph==='GUARD_ACTION')this.guardPanel();
 else if(ph==='WITCH_ACTION')this.witchPanel();
},
clearAct(){this.dom.actionPanel.innerHTML='';
 this.stopWolfListeners();},
/* ---------- 共用工具 ---------- */
activeOf(pl){const d=pl.deaths||0;if(d===0)return pl.identities[0].role||pl.identities[0];
 if(d===1)return pl.identities[1].role||pl.identities[1];return null;},
hasActive(r){return this.activeOf(this.playerData)===r;},
canSeeWolf(){const r=this.activeOf(this.playerData);return r==='狼人'||r==='隐狼';},
canAct(ph){
 if(!this.playerData.isAlive)return false;
 const map={WOLF_ACTION:['狼人','隐狼'],WITCH_ACTION:['女巫'],
 SEER_ACTION:['预言家'],GUARD_ACTION:['守卫']};
 return map[ph]?.includes(this.activeOf(this.playerData));
},
/* ---------- SETUP 阶段 ---------- */
togglePreview(){
 this.isPreview=!this.isPreview;
 if(this.isPreview){this.currentIdentityOrder=[this.playerData.identities[1],this.playerData.identities[0]];
  this.dom.btnPreview.textContent='还原顺序';}
 else{this.currentIdentityOrder=[...this.playerData.identities];
  this.dom.btnPreview.textContent='预览交换';}
 const [a,b]=this.currentIdentityOrder;this.dom.preview.innerHTML=
  `<strong>当前顺序：</strong>${a.role||a} + ${b.role||b}`;this.dom.preview.classList.remove('hidden');
 this.renderIds(true);
},
fixIdentity(){if(this.playerData.isReady)return;
 if(!confirm(this.isPreview?'确定交换？':'确定保持顺序？'))return;
 db.ref(`games/${this.gameId}/players/${this.playerId}`).update({
  identities:this.currentIdentityOrder,isReady:true});
},
/* ---------- 狼人面板 ---------- */
renderWolfPanel(){
 /* 聊天与监听 */
 if(this.canSeeWolf()){this.dom.wolfChatArea.classList.remove('hidden');
  if(!this.wolfChatListener){
   this.dom.wolfChatArea.innerHTML=`<div class="wolf-chat-box"><h3>狼人频道</h3>
     <div id="wolf-chat"></div><div><input id="wolf-input" placeholder="密聊…">
     <button id="wolf-send">发送</button></div><div id="wolf-votes-summary" class="wolf-votes-summary"></div></div>`;
   this.listenWolfChat();this.listenWolfVotes();
   document.getElementById('wolf-send').onclick=()=>this.sendWolfMsg();
  }
 }
 /* 行动按钮 */
 if(!this.canAct('WOLF_ACTION')){this.waitPanel('WOLF_ACTION');return;}
 if(this.hasVoted){this.dom.actionPanel.innerHTML=
  `<div class="action-feedback"><p>已提交提案，等待队友</p></div>`;return;}
 let btns=Object.values(this.allPlayers).filter(p=>p.isAlive)
   .map(p=>`<button class="wolf-vote-btn" data-id="${p.id}">${p.id}号</button>`).join('');
 this.dom.actionPanel.innerHTML=`<h3>选择击杀提案</h3><div>${btns}</div>
  <button class="action-complete-btn" onclick="App.confirmWolf()">提交提案</button>`;
 [...document.querySelectorAll('.wolf-vote-btn')].forEach(b=>{
  b.onclick=e=>{[...document.querySelectorAll('.wolf-vote-btn')].forEach(x=>x.classList.remove('selected'));
   e.currentTarget.classList.add('selected');this.currentWolfVote=b.dataset.id;}
 });
},
confirmWolf(){
 if(!this.currentWolfVote){alert('请选择目标');return;}
 db.ref(`games/${this.gameId}/wolfVotes/${this.playerId}`).set(this.currentWolfVote);
 /* 发送系统消息 */
 const m={senderId:this.playerId,text:`提案刀 ${this.currentWolfVote} 号`,timestamp:Date.now(),isVote:true};
 db.ref(`games/${this.gameId}/wolfChat`).push(m);
 this.hasVoted=true;this.renderAction();
},
listenWolfChat(){
 this.wolfChatListener=db.ref(`games/${this.gameId}/wolfChat`).on('value',snap=>{
  const msgs=Object.values(snap.val()||{}).sort((a,b)=>a.timestamp-b.timestamp);
  const box=document.getElementById('wolf-chat');if(!box)return;
  box.innerHTML=msgs.map(m=>`<div class="wolf-msg ${m.isVote?'vote-msg':''}">
   <strong>${m.senderId}号:</strong> ${m.text}</div>`).join('')||'<div class="waiting-msg">暂无消息</div>';
  box.scrollTop=box.scrollHeight;
 });
},
listenWolfVotes(){
 this.wolfVotesListener=db.ref(`games/${this.gameId}/wolfVotes`).on('value',snap=>{
  this.allWolfVotes=snap.val()||{};this.updateWolfSummary();
  this.checkConsensus();
 });
},
updateWolfSummary(){
 const sum=document.getElementById('wolf-votes-summary');if(!sum)return;
 const v=this.allWolfVotes;if(!Object.keys(v).length){sum.innerHTML='<p>暂无提案</p>';return;}
 const cnt={};Object.entries(v).forEach(([w,t])=>{cnt[t]=cnt[t]||[];cnt[t].push(w);});
 let h='<h4>当前提案：</h4>';
 for(const [t,vts]of Object.entries(cnt))h+=`<p>${t}号: ${vts.map(x=>x+'号').join('、')} (${vts.length})</p>`;
 sum.innerHTML=h;
},
checkConsensus(){
 /* 若所有存活狼人均投票且一致 => 共识达成 */
 const aliveWolves=Object.values(this.allPlayers).filter(p=>
   p.isAlive&&['狼人','隐狼'].includes(this.activeOf(p))).map(p=>String(p.id));
 if(!aliveWolves.length)return;
 const votes=this.allWolfVotes;if(!aliveWolves.every(id=>votes[id]))return;
 const target=votes[aliveWolves[0]];
 if(!aliveWolves.every(id=>votes[id]===target))return;/* 仍有分歧 */
 /* 写入 nightActions/wolfKill 与 actionCompleted 原子操作 */
 db.ref(`games/${this.gameId}`).update({
   [`nightActions/wolfKill`]:target});
 db.ref(`games/${this.gameId}/actionCompleted/WOLF_ACTION`).transaction(v=>v||{
   playerId:'system',timestamp:Date.now()});
},
stopWolfListeners(){
 if(this.wolfChatListener){db.ref(`games/${this.gameId}/wolfChat`).off('value',this.wolfChatListener);this.wolfChatListener=null;}
 if(this.wolfVotesListener){db.ref(`games/${this.gameId}/wolfVotes`).off('value',this.wolfVotesListener);this.wolfVotesListener=null;}
 this.dom.wolfChatArea.innerHTML='';this.dom.wolfChatArea.classList.add('hidden');
},
sendWolfMsg(){
 const inp=document.getElementById('wolf-input');if(!inp.value.trim())return;
 db.ref(`games/${this.gameId}/wolfChat`).push({senderId:this.playerId,text:inp.value.trim(),
  timestamp:Date.now()});inp.value='';
},
/* ---------- 其它角色面板 ---------- */
seerPanel(){
 const btns=Object.values(this.allPlayers).filter(p=>p.isAlive&&p.id!=this.playerId)
  .map(p=>`<button class="action-btn" data-id="${p.id}">${p.id}号</button>`).join('');
 this.dom.actionPanel.innerHTML=`<h3>查验目标</h3><div>${btns}</div>`;
 [...document.querySelectorAll('.action-btn')].forEach(b=>b.onclick=()=>this.seerCheck(b.dataset.id));
},
async seerCheck(tid){
 const tp=this.allPlayers[tid],roles=tp.originalIdentities.map(i=>ROLES[i.role||i]);
 let res='好人';const hasVis=roles.some(r=>r&&r.faction==='bad'&&!r.isInvisible);
 if(hasVis)res='狼人';else{
  const hasInv=roles.some(r=>r&&r.faction==='bad'&&r.isInvisible);
  if(hasInv){
   const mate=Object.values(this.allPlayers).some(p=>p.id!=tid&&p.isAlive&&
     p.originalIdentities.some(i=>ROLES[i.role||i].faction==='bad'));
   res=mate?'好人':'狼人';
  }
 }
 await db.ref(`games/${this.gameId}/players/${this.playerId}/seerResults/${tid}`).set(res);
 await db.ref(`games/${this.gameId}/nightActions/seer`).set({from:this.playerId,target:tid,result:res});
 this.dom.actionPanel.innerHTML=`<div class="action-feedback"><p>查验 ${tid} 号结果：${res}</p>
  <button class="action-complete-btn" onclick="App.done('SEER_ACTION')">完成</button></div>`;
},
guardPanel(){
 const last=this.playerData.lastGuardTarget;
 const btns=Object.values(this.allPlayers).filter(p=>p.isAlive)
  .map(p=>`<button class="action-btn" data-id="${p.id}" ${p.id==last?'disabled':''}>
    ${p.id}号${p.id==last?'(上轮已守)':''}</button>`).join('');
 this.dom.actionPanel.innerHTML=`<h3>守护目标</h3>${btns}`;
 [...document.querySelectorAll('.action-btn')].forEach(b=>b.onclick=()=>this.guard(b.dataset.id));
},
async guard(tid){
 await db.ref(`games/${this.gameId}/players/${this.playerId}/lastGuardTarget`).set(tid);
 await db.ref(`games/${this.gameId}/nightActions/guard`).set(tid);
 this.dom.actionPanel.innerHTML=`<div class="action-feedback"><p>守护 ${tid} 号</p>
  <button class="action-complete-btn" onclick="App.done('GUARD_ACTION')">完成</button></div>`;
},
witchPanel(){
 const round=this.gameState.round,hasP=!this.playerData.hasUsedPoison,hasC=!this.playerData.hasUsedCure;
 let h='<h3>女巫行动</h3>';
 h+=`<p>解药:${hasC?'✓':'✗'} 毒药:${hasP?'✓':'✗'}</p>`;
 if(hasC&&round>1)h+='<button class="action-btn" id="btn-cure">使用解药</button>';
 if(hasP){
  const btns=Object.values(this.allPlayers).filter(p=>p.isAlive&&p.id!=this.playerId)
   .map(p=>`<button class="action-btn" data-id="${p.id}">${p.id}号</button>`).join('');
  h+='<h4>使用毒药</h4>'+btns;
 }
 h+='<button class="action-btn" id="btn-pass">不使用</button>';
 this.dom.actionPanel.innerHTML=h;
 if(hasC&&round>1)this.$('btn-cure').onclick=()=>this.witchCure();
 this.$('btn-pass').onclick=()=>this.witchPass();
 [...document.querySelectorAll('.action-btn[data-id]')].forEach(b=>b.onclick=()=>this.witchPoison(b.dataset.id));
},
async witchCure(){
 await db.ref(`games/${this.gameId}/players/${this.playerId}/hasUsedCure`).set(true);
 await db.ref(`games/${this.gameId}/nightActions/witchCure`).set(true);
 this.dom.actionPanel.innerHTML=`<div class="action-feedback"><p>使用解药</p>
  <button class="action-complete-btn" onclick="App.done('WITCH_ACTION')">完成</button></div>`;
},
async witchPoison(tid){
 await db.ref(`games/${this.gameId}/players/${this.playerId}/hasUsedPoison`).set(true);
 await db.ref(`games/${this.gameId}/nightActions/witchPoison`).set(tid);
 this.dom.actionPanel.innerHTML=`<div class="action-feedback"><p>毒杀 ${tid} 号</p>
  <button class="action-complete-btn" onclick="App.done('WITCH_ACTION')">完成</button></div>`;
},
witchPass(){this.dom.actionPanel.innerHTML=
 `<div class="action-feedback"><p>不使用药水</p>
  <button class="action-complete-btn" onclick="App.done('WITCH_ACTION')">完成</button></div>`},
waitPanel(ph){
 /* 仅拥有对应身份的玩家显示完成按钮 */
 if(this.shouldShowDone(ph))
  this.dom.actionPanel.innerHTML=
   `<div class="action-feedback"><p>你此阶段无可执行操作</p>
    <button class="action-complete-btn" onclick="App.done('${ph}')">完成</button></div>`;
 else this.dom.actionPanel.innerHTML=`<div class="waiting-msg">等待其他玩家…</div>`;
},
shouldShowDone(ph){
 const map={WOLF_ACTION:['狼人','隐狼'],WITCH_ACTION:['女巫'],
 SEER_ACTION:['预言家'],GUARD_ACTION:['守卫']};
 return this.playerData.identities.some(i=>map[ph]?.includes(i.role||i));
},
done(ph){db.ref(`games/${this.gameId}/actionCompleted/${ph}`).set(
 {playerId:this.playerId,timestamp:Date.now()});
 this.dom.actionPanel.innerHTML=`<div class="action-feedback"><p>已完成</p></div>`;}
,
/* ---------- 工具 ---------- */
copy(t){navigator.clipboard.writeText(t).then(()=>alert('已复制'),()=>alert('复制失败'));}
};
/* 启动 */
document.addEventListener('DOMContentLoaded',()=>App.init());
</script>
</body></html>
