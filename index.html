<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>åŒèº«ä»½ç‹¼äººæ€ - ç”µå­æ³•å®˜</title>

<!-- ======= è§†è§‰&æ’ç‰ˆï¼ˆä¿æŒä¸å˜ï¼‰ ======= -->
<style>
:root{
 --bg:#1a1a2e;--card:#16213e;--border:#0f3460;--accent:#e94560;
 --text:#eaeaea;--success:#00d9ff;--danger:#ff006e;--warning:#ffb700;
 --gradient:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
 --shadow:0 10px 30px rgba(0,0,0,0.3);
 --font-main:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:var(--font-main);line-height:1.6;min-height:100vh}
body{display:flex;justify-content:center;align-items:flex-start;padding:20px;background-image:
 radial-gradient(circle at 20% 50%,rgba(233,69,96,.1)0%,transparent 50%),
 radial-gradient(circle at 80% 80%,rgba(0,217,255,.1)0%,transparent 50%)}
#app{width:100%;max-width:900px;background:var(--card);border-radius:20px;padding:30px;box-shadow:var(--shadow);border:1px solid var(--border);animation:fadeIn .5s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
h1,h2,h3{color:var(--text);margin-bottom:20px;text-align:center;letter-spacing:1px}
h1{background:var(--gradient);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-size:2em;margin-bottom:30px}
h2{color:var(--success);font-size:1.5em;border-bottom:2px solid var(--border);padding-bottom:10px}
h3{color:var(--warning);font-size:1.2em}
hr{border:none;border-top:2px solid var(--border);margin:30px 0}
.hidden{display:none!important}
button{background:var(--accent);color:#fff;border:none;padding:12px 24px;border-radius:12px;cursor:pointer;font-size:16px;font-weight:600;margin:5px;transition:.3s all;position:relative;overflow:hidden}
button::before{content:'';position:absolute;top:50%;left:50%;width:0;height:0;background:rgba(255,255,255,.2);border-radius:50%;transform:translate(-50%,-50%);transition:width .6s,height .6s}
button:hover::before{width:300px;height:300px}
button:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 5px 20px rgba(233,69,96,.4)}
button:disabled{background:#4a4a4a;cursor:not-allowed;opacity:.6}
button.selected{background:var(--success)!important;box-shadow:0 5px 20px rgba(0,217,255,.4)}
button.control-btn{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)}
button.action-btn{background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%)}
button.confirm-btn{background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%)}
input[type=number],input[type=text]{width:80px;padding:10px;border-radius:10px;border:2px solid var(--border);background:rgba(255,255,255,.05);color:var(--text);font-size:16px;text-align:center;transition:.3s all}
input:focus{outline:none;border-color:var(--accent);background:rgba(255,255,255,.1)}
.role-setup-item{display:flex;justify-content:space-between;align-items:center;padding:15px;margin:10px 0;background:rgba(255,255,255,.03);border-radius:12px;transition:.3s all;border:1px solid transparent}
.role-setup-item:hover{background:rgba(255,255,255,.05);border-color:var(--border)}
.player-list-item{display:flex;justify-content:space-between;align-items:center;padding:15px 20px;margin:12px 0;background:rgba(255,255,255,.05);border-radius:15px;transition:.3s all;border:2px solid transparent}
.player-list-item:hover{border-color:var(--accent);transform:translateX(5px)}
.player-list-item.dead{opacity:.7;background:rgba(255,0,110,.1)}
.player-list-item.dead-all{opacity:.4;background:rgba(100,100,100,.1);text-decoration:line-through}
.life-heart{color:var(--danger);font-size:24px;transition:.3s all;text-shadow:0 0 10px rgba(255,0,110,.5)}
.life-heart.lost{color:#555;text-shadow:none}
.thief-copy{color:#888;font-style:italic;font-size:.9em}
.dead-identity{text-decoration:line-through;opacity:.6}
.action-panel,.action-feedback{margin-top:25px;padding:20px;background:rgba(255,255,255,.03);border-radius:15px;text-align:center;border:1px solid var(--border)}
.wolf-chat-box{padding:20px;background:rgba(233,69,96,.1);border-radius:15px;margin-top:20px;border:1px solid rgba(233,69,96,.3)}
#wolf-chat{height:180px;overflow-y:auto;border:1px solid var(--border);padding:15px;border-radius:10px;margin-bottom:15px;background:rgba(0,0,0,.3)}
#wolf-chat::-webkit-scrollbar{width:8px}
#wolf-chat::-webkit-scrollbar-track{background:rgba(255,255,255,.1);border-radius:10px}
#wolf-chat::-webkit-scrollbar-thumb{background:var(--accent);border-radius:10px}
#wolf-input{width:calc(100% - 100px);margin-right:10px;padding:12px;border-radius:10px;border:2px solid var(--border);background:rgba(255,255,255,.05);color:var(--text)}
.vote-msg{color:var(--warning);font-weight:600}
.game-over-banner{padding:40px;text-align:center;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border-radius:20px;font-size:28px;font-weight:bold;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
.game-over-banner.bad{background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%)}
details summary{cursor:pointer;font-weight:bold;color:var(--warning);padding:10px;transition:.3s all}
details summary:hover{color:var(--success)}
.status-badge{display:inline-block;padding:4px 12px;border-radius:20px;font-size:.85em;font-weight:600;margin-left:10px}
.status-ready{background:rgba(0,217,255,.2);color:var(--success);border:1px solid var(--success)}
.status-not-ready{background:rgba(255,0,110,.2);color:var(--danger);border:1px solid var(--danger)}
.role-icon{display:inline-block;width:30px;height:30px;margin-right:10px;text-align:center;line-height:30px;border-radius:50%;background:rgba(255,255,255,.1)}
.loading-spinner{display:inline-block;width:20px;height:20px;border:3px solid rgba(255,255,255,.3);border-radius:50%;border-top-color:var(--accent);animation:spin 1s infinite ease-in-out}
@keyframes spin{to{transform:rotate(360deg)}}
.identity-card{background:rgba(255,255,255,.05);padding:20px;border-radius:15px;margin:10px 0;border:2px solid var(--border);transition:.3s all}
.identity-card:hover{transform:translateY(-2px);box-shadow:0 5px 20px rgba(0,0,0,.3)}
.action-status{padding:15px;background:rgba(255,255,255,.05);border-radius:12px;margin:15px 0}
.action-status-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0}
@media(max-width:600px){#app{padding:20px}h1{font-size:1.5em}button{padding:10px 16px;font-size:14px}}
</style>
</head>
<body>
<div id="app">
  <!-- ======= ä¸»æŒç«¯ ======= -->
  <div id="host-view">
    <h1>ğŸŒ™ åŒèº«ä»½ç‹¼äººæ€ - ä¸»æŒç«¯</h1>
    <div id="setup">
      <h2>ğŸ“‹ èº«ä»½é…ç½®</h2>
      <div id="role-setup"></div>
      <p style="text-align:center;font-size:18px;">
        <span style="color:var(--warning)">æ€»èº«ä»½æ•°:<strong id="total-roles">0</strong></span> |
        <span style="color:var(--success)">é¢„è®¡ç©å®¶æ•°:<strong id="player-cnt">0</strong></span>
      </p>
      <div style="text-align:center;margin-top:20px;">
        <button id="btn-create" class="control-btn">
          <span id="create-text">åˆ›å»ºæ¸¸æˆ</span>
          <span id="create-spinner" class="loading-spinner hidden"></span>
        </button>
      </div>
    </div>

    <div id="links" class="hidden">
      <h2>ğŸ”— åˆ†äº«é“¾æ¥</h2>
      <div id="links-box"></div>
    </div>

    <div id="host-ctrl" class="hidden">
      <h2>ğŸ® æ¸¸æˆæ§åˆ¶</h2>
      <div id="host-status"></div>
      <div id="ready-box"></div>
      <div style="text-align:center;margin:20px 0;">
        <button id="btn-start" class="control-btn">ğŸš€ é”å®šèº«ä»½ï¼Œå¼€å§‹æ¸¸æˆ</button>
        <button id="btn-night" class="control-btn">ğŸŒ™ å¤©é»‘è¯·é—­çœ¼</button>
        <button id="btn-day" class="control-btn">â˜€ï¸ å¤©äº®äº† (ç»“ç®—å¤œæ™š)</button>
      </div>
      <hr>
      <h3>ğŸŒƒ å¤œæ™šè¡ŒåŠ¨ (æ‰‹åŠ¨æ¨è¿›)</h3>
      <div style="text-align:center;">
        <button class="host-action action-btn" data-action="WOLF_ACTION">ğŸº ç‹¼äººè¡ŒåŠ¨</button>
        <button class="host-action action-btn" data-action="WITCH_ACTION">ğŸ§ª å¥³å·«è¡ŒåŠ¨</button>
        <button class="host-action action-btn" data-action="SEER_ACTION">ğŸ”® é¢„è¨€å®¶è¡ŒåŠ¨</button>
        <button class="host-action action-btn" data-action="GUARD_ACTION">ğŸ›¡ï¸ å®ˆå«è¡ŒåŠ¨</button>
      </div>
      <div id="action-feedback-box"></div>
      <div id="night-action-status" class="action-status hidden"></div>
      <div id="night-result" class="hidden"></div>
      <hr>
      <h3>ğŸ“Š æ¸¸æˆç®¡ç†</h3>
      <div style="text-align:center;">
        <button id="btn-reveal" class="control-btn">ğŸ‘ï¸ å¤ç›˜ï¼šæ˜¾ç¤ºæ‰€æœ‰èº«ä»½</button>
      </div>
      <div id="host-player-list"></div>
    </div>
  </div>

  <!-- ======= ç©å®¶ç«¯ ======= -->
  <div id="player-view" class="hidden">
    <h1 id="game-title">ğŸŒ™ åŒèº«ä»½ç‹¼äººæ€</h1>
    <div id="player-info">
      <h2 id="pid-show"></h2>
      <h3>ä½ çš„èº«ä»½æ˜¯:</h3>
      <div id="my-ids" class="identity-card"></div>
      <div id="swap-area" class="hidden">
        <p style="text-align:center;color:var(--warning)">æ¸¸æˆå¼€å§‹å‰ï¼Œä½ å¯ä»¥äº¤æ¢ä¸¤ä¸ªèº«ä»½çš„é¡ºåºã€‚å½“å‰ç”Ÿæ•ˆçš„èº«ä»½æ˜¯ç¬¬ä¸€ä¸ªã€‚</p>
        <div style="text-align:center;">
          <button id="btn-swap" class="action-btn">ğŸ”„ äº¤æ¢é¡ºåº</button>
          <button id="btn-confirm" class="confirm-btn">âœ… ç¡®å®šèº«ä»½é¡ºåº</button>
        </div>
      </div>
    </div>
    <hr>
    <div id="game-area">
      <div id="player-status" style="text-align:center;font-size:20px;font-weight:bold;padding:15px;background:rgba(255,255,255,.05);border-radius:15px;margin-bottom:20px;">
        ç­‰å¾…æ¸¸æˆå¼€å§‹...
      </div>
      <div id="persist" class="hidden"></div>
      <div id="action-panel"></div>
      <div id="wolf-chat-area" class="hidden"></div>
      <h3>ğŸ‘¥ ç©å®¶åˆ—è¡¨</h3>
      <div id="player-list"></div>
    </div>
  </div>
</div>

<!-- ======= Firebase SDK ======= -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
/* ==========================================================
   åŒèº«ä»½ç‹¼äººæ€å‰ç«¯ä¸»é€»è¾‘  (2025-06-27 ä¿®è®¢ç‰ˆ)
   é‡ç‚¹ä¿®å¤ï¼š
   1. ç‹¼äººèŠå¤©æ— é™åˆ¶å‘é€
   2. åªæœ‰åºå·æœ€å°ç‹¼äººéœ€è¦â€œç¡®è®¤å‡»æ€â€ && æ³•å®˜ç«¯ä»…æ˜¾ç¤ºâ€œç‹¼äººå®Œæˆâ€è€Œä¸æš´éœ²å·æ•°
   3. å…¶å®ƒè¾¹ç•Œã€ç»†èŠ‚æ ¡æ­£
   ========================================================== */

/* ========== 1. Firebase åˆå§‹åŒ– ========== */
const firebaseConfig={
 apiKey:"AIzaSyCEAgB6DoY8YA6lZnYblhIDVTYH_q8UimI",
 authDomain:"werewolf-game-master-1f37f.firebaseapp.com",
 databaseURL:"https://werewolf-game-master-1f37f-default-rtdb.asia-southeast1.firebasedatabase.app",
 projectId:"werewolf-game-master-1f37f",
 storageBucket:"werewolf-game-master-1f37f.appspot.com",
 messagingSenderId:"626014452910",
 appId:"1:626014452910:web:35b6eba412f95f1878013f"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

/* ========== 2. å¸¸é‡/é…ç½® ========== */
const ROLES={
 'å¹³æ°‘':{name:'å¹³æ°‘',faction:'good',isGod:false,icon:'ğŸ‘¤'},
 'å®ˆå«':{name:'å®ˆå«',faction:'good',isGod:true,icon:'ğŸ›¡ï¸'},
 'ç™½ç—´':{name:'ç™½ç—´',faction:'good',isGod:true,icon:'ğŸ¤ª'},
 'é¢„è¨€å®¶':{name:'é¢„è¨€å®¶',faction:'good',isGod:true,icon:'ğŸ”®'},
 'éª‘å£«':{name:'éª‘å£«',faction:'good',isGod:true,icon:'âš”ï¸'},
 'éšç‹¼':{name:'éšç‹¼',faction:'bad',isGod:false,isInvisible:true,icon:'ğŸŒ‘'},
 'å¥³å·«':{name:'å¥³å·«',faction:'good',isGod:true,icon:'ğŸ§ª'},
 'çŒäºº':{name:'çŒäºº',faction:'good',isGod:true,icon:'ğŸ”«'},
 'ç‹¼äºº':{name:'ç‹¼äºº',faction:'bad',isGod:false,icon:'ğŸº'},
 'ç›—è´¼':{name:'ç›—è´¼',faction:'neutral',isGod:false,isThief:true,icon:'ğŸ­'}
};
const DEFAULT_SETUP={'å¹³æ°‘':6,'å®ˆå«':1,'ç™½ç—´':1,'é¢„è¨€å®¶':1,'éª‘å£«':1,'å¥³å·«':1,'çŒäºº':1,'ç‹¼äºº':2,'éšç‹¼':1,'ç›—è´¼':1};
const FORBIDDEN=[['é¢„è¨€å®¶','ç‹¼äºº'],['é¢„è¨€å®¶','éšç‹¼'],['ç›—è´¼','ç‹¼äºº'],['ç›—è´¼','éšç‹¼'],['éšç‹¼','ç‹¼äºº'],['éšç‹¼','éšç‹¼']];

/* ========== é€šç”¨åˆ¤å®š ========== */
function shouldAct(player,phase,all){
 if(!player.isAlive)return false;
 const active=App.getActiveRole(player);
 const map={
  WOLF_ACTION:['ç‹¼äºº','éšç‹¼'],
  SEER_ACTION:['é¢„è¨€å®¶'],
  GUARD_ACTION:['å®ˆå«'],
  WITCH_ACTION:['å¥³å·«'],
  KNIGHT_ACTION:['éª‘å£«'],
  HUNTER_ACTION:['çŒäºº']
 };
 if(!map[phase]?.includes(active))return false;
 if(phase==='WOLF_ACTION'&&active==='éšç‹¼'){
   return !Object.values(all).some(p=>p.isAlive&&p.id!==player.id&&App.getActiveRole(p)==='ç‹¼äºº');
 }
 return true;
}

/* ===================== 3. App ===================== */
const App={
/* ---------- åŸºç¡€æ•°æ® ---------- */
gameId:null,playerId:null,isHost:false,
gameState:null,allPlayers:{},playerData:null,
wolfChatListener:null,wolfVotesListener:null,nightActionListener:null,

/* ---------- DOM å·¥å…· ---------- */
$(id){return document.getElementById(id)},
copy(text){navigator.clipboard.writeText(text).then(()=>alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿'))},
cacheDom(){
 this.dom={
  hostView:this.$('host-view'),playerView:this.$('player-view'),
  roleSetup:this.$('role-setup'),totalRoles:this.$('total-roles'),playerCnt:this.$('player-cnt'),
  btnCreate:this.$('btn-create'),links:this.$('links'),linksBox:this.$('links-box'),
  hostCtrl:this.$('host-ctrl'),btnStart:this.$('btn-start'),btnNight:this.$('btn-night'),btnDay:this.$('btn-day'),
  hostActions:document.querySelectorAll('.host-action'),hostPlayerList:this.$('host-player-list'),
  btnReveal:this.$('btn-reveal'),readyBox:this.$('ready-box'),actionFeedback:this.$('action-feedback-box'),
  nightResult:this.$('night-result'),pidShow:this.$('pid-show'),myIds:this.$('my-ids'),
  swapArea:this.$('swap-area'),btnSwap:this.$('btn-swap'),btnConfirm:this.$('btn-confirm'),
  playerStatus:this.$('player-status'),persist:this.$('persist'),actionPanel:this.$('action-panel'),
  playerList:this.$('player-list'),wolfChatArea:this.$('wolf-chat-area'),gameTitle:this.$('game-title'),
  nightActionStatus:this.$('night-action-status')
 };
},
showView(v){this.dom.hostView.classList.add('hidden');this.dom.playerView.classList.add('hidden');
 v==='host'?this.dom.hostView.classList.remove('hidden'):this.dom.playerView.classList.remove('hidden')},

/* ---------- åˆå§‹åŒ–å…¥å£ ---------- */
init(){
 this.cacheDom();
 const qs=new URLSearchParams(location.search);
 this.gameId=qs.get('game');this.playerId=qs.get('player');
 if(this.gameId&&this.playerId){this.isHost=false;this.showView('player');this.initPlayer();}
 else{this.isHost=true;this.showView('host');this.initHost();}
},

/* =================================================
   3-1 ä¸»æŒç«¯
   ================================================= */
initHost(){
 this.renderRoleSetup();
 this.dom.btnCreate.onclick=()=>this.createGame();
 this.dom.btnStart.onclick=()=>this.startGame();
 this.dom.btnNight.onclick=()=>this.updatePhase('NIGHT_START');
 this.dom.btnDay.onclick=()=>this.processNightResults();
 this.dom.hostActions.forEach(b=>b.onclick=()=>this.triggerAction(b.dataset.action));
 this.dom.btnReveal.onclick=()=>this.renderHostPlayers(true);
},

renderRoleSetup(){
 let html='';
 for(const r in DEFAULT_SETUP){
  const info=ROLES[r];
  html+=`<div class="role-setup-item"><span><span class="role-icon">${info.icon}</span>${r}</span>
   <input type="number" id="role-${r}" min="0" value="${DEFAULT_SETUP[r]}"></div>`;
 }
 this.dom.roleSetup.innerHTML=html;
 this.dom.roleSetup.oninput=()=>this.updateRoleCount();
 this.updateRoleCount();
},
updateRoleCount(){
 let total=0;this.dom.roleSetup.querySelectorAll('input').forEach(i=>total+=+i.value||0);
 this.dom.totalRoles.textContent=total;
 this.dom.playerCnt.textContent=total%2===0?total/2:'èº«ä»½æ€»æ•°å¿…é¡»ä¸ºå¶æ•°';
},

/* ---------- åˆ›å»ºæ¸¸æˆã€æ´—ç‰Œ ---------- */
async createGame(){
 this.dom.btnCreate.disabled=true;this.$('create-text').classList.add('hidden');this.$('create-spinner').classList.remove('hidden');
 const pool=[];this.dom.roleSetup.querySelectorAll('input').forEach(i=>{const r=i.id.replace('role-','');for(let k=0;k<+i.value;k++)pool.push(r)});
 if(pool.length===0||pool.length%2){alert('èº«ä»½æ€»æ•°å¿…é¡»ä¸ºå¶æ•°ä¸”>0');location.reload();return}
 const pairs=this.optimizedDeal(pool);if(!pairs){alert('æ— æ³•ç”Ÿæˆåˆæ³•ç‰Œç»„');location.reload();return}
 this.gameId=db.ref('games').push().key;
 const pc=pool.length/2,players={};
 for(let i=1;i<=pc;i++){
  players[i]={id:i,identities:pairs[i-1],originalIdentities:[...pairs[i-1]],
    deaths:0,isAlive:true,isReady:false,isExposedIdiot:false,seerResults:{},lastGuardTarget:null,
    hasUsedPoison:false,hasUsedCure:false};
 }
 await db.ref(`games/${this.gameId}`).set({state:{phase:'SETUP',round:0,peaceNightStreak:0,winner:null},players,config:{playerCount:pc},wolfChat:{},wolfVotes:{},nightActions:{},actionCompleted:{}});
 this.listenGame();
 this.buildLinks(pc);
 this.dom.btnCreate.classList.add('hidden');this.dom.links.classList.remove('hidden');this.dom.hostCtrl.classList.remove('hidden');
},
optimizedDeal(pool){
 const n=pool.length,maxTry=5000;
 const shuffle=a=>{for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a};
 for(let t=0;t<maxTry;t++){
  const s=shuffle(pool.slice()),pairs=[],forbidden=false;let golden=0;
  for(let i=0;i<n;i+=2){
   const r1=s[i],r2=s[i+1];
   if(FORBIDDEN.some(([a,b])=>(a===r1&&b===r2)||(a===r2&&b===r1))){forbidden=true;break}
   if((r1==='å¹³æ°‘'&&r2==='å¹³æ°‘')||(r1==='ç›—è´¼'&&r2==='å¹³æ°‘')||(r2==='ç›—è´¼'&&r1==='å¹³æ°‘'))golden++;
   pairs.push([{role:r1,isThiefCopy:false},{role:r2,isThiefCopy:false}]);
  }
  if(forbidden||golden<1||golden>2)continue;
  return pairs;
 }
 return null;
},
buildLinks(c){
 const base=location.href.split('?')[0],tpl=`${base}?game=${this.gameId}&player=[N]`;let html='';
 for(let i=1;i<=c;i++){const l=`${base}?game=${this.gameId}&player=${i}`;
  html+=`<div style="margin:10px 0;"><span style="display:inline-block;width:80px;font-weight:600;">ğŸ® ${i}å·:</span>
   <input value="${l}" readonly style="width:calc(100% - 200px);"><button onclick="App.copy('${l}')" class="action-btn">ğŸ“‹ å¤åˆ¶</button></div>`}
 this.dom.linksBox.innerHTML=`<div style="background:rgba(255,255,255,.05);padding:20px;border-radius:15px;margin-bottom:20px;">
  <p><strong>ğŸ”— é€šç”¨æ¨¡æ¿:</strong></p><input value="${tpl}" readonly style="width:calc(100% - 120px);">
  <button onclick="App.copy('${tpl}')" class="action-btn">ğŸ“‹ å¤åˆ¶</button></div>
  <details><summary>å±•å¼€/æŠ˜å å„ç©å®¶ä¸“å±é“¾æ¥</summary><div style="padding:10px;">${html}</div></details>`;
},

/* ---------- ç›‘å¬æ¸¸æˆæ•°æ® ---------- */
listenGame(){
 db.ref(`games/${this.gameId}`).on('value',snap=>{
  if(!snap.exists())return;
  const g=snap.val();this.gameState=g.state;this.allPlayers=g.players||{};
  this.renderHostPlayers(false);this.updateReady();this.updateHostBtns();
 });
 if(this.nightActionListener)db.ref(`games/${this.gameId}/actionCompleted`).off('value',this.nightActionListener);
 this.nightActionListener=db.ref(`games/${this.gameId}/actionCompleted`).on('value',s=>this.updateNightStatus(s.val()||{}));
},
updateReady(){
 const p=Object.values(this.allPlayers),ready=p.filter(x=>x.isReady).length,total=p.length;
 let html=`<h3>ğŸ“Š å‡†å¤‡çŠ¶æ€ (${ready}/${total})</h3><div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px;">`;
 p.forEach(x=>html+=`<div style="padding:10px;background:rgba(255,255,255,.05);border-radius:10px;text-align:center;">
   ${x.id}å· <span class="status-badge ${x.isReady?'status-ready':'status-not-ready'}">${x.isReady?'âœ… å·²å‡†å¤‡':'â³ æœªå‡†å¤‡'}</span></div>`);
 html+='</div>';this.dom.readyBox.innerHTML=html;this.dom.btnStart.disabled=ready<total;
},
updateHostBtns(){
 const ph=this.gameState.phase,isNight=ph.includes('ACTION')||ph==='NIGHT_START';
 this.dom.btnNight.disabled=isNight||ph==='GAME_OVER';
 this.dom.btnDay.disabled=!isNight||ph==='GAME_OVER';
},
updateNightStatus(ac){
 const ph=this.gameState.phase;if(!ph.includes('ACTION')){this.dom.nightActionStatus.classList.add('hidden');return}
 if(ph==='WOLF_ACTION'){
   const done=ac['LEADER_WOLF']?true:false;
   this.dom.nightActionStatus.innerHTML=`<h4>ğŸº ç‹¼äººè¡ŒåŠ¨</h4><div>${done?'âœ… å·²å®Œæˆ':'â³ ç­‰å¾…ä¸­'}</div>`;
   this.dom.nightActionStatus.classList.remove('hidden');return;
 }
 const map={'WITCH_ACTION':{role:'å¥³å·«',icon:'ğŸ§ª'},'SEER_ACTION':{role:'é¢„è¨€å®¶',icon:'ğŸ”®'},'GUARD_ACTION':{role:'å®ˆå«',icon:'ğŸ›¡ï¸'}};
 const info=map[ph];if(!info)return;
 const should=Object.values(this.allPlayers).filter(p=>shouldAct(p,ph,this.allPlayers));
 const done=should.filter(p=>ac[`${p.id}_${ph}`]);
 let html=`<h4>${info.icon} ${info.role}è¡ŒåŠ¨çŠ¶æ€</h4><div>å·²å®Œæˆ: ${done.length}/${should.length}</div><div style="margin-top:10px;">`;
 should.forEach(p=>html+=`<div class="action-status-item"><span>${p.id}å·</span><span style="color:${ac[`${p.id}_${ph}`]?'var(--success)':'var(--warning)'}">${ac[`${p.id}_${ph}`]?'âœ… å·²è¡ŒåŠ¨':'â³ ç­‰å¾…ä¸­'}</span></div>`);
 html+='</div>';this.dom.nightActionStatus.innerHTML=html;this.dom.nightActionStatus.classList.remove('hidden');
},

/* ---------- ä¸»æŒç«¯å…¶ä»– ---------- */
async startGame(){if(this.dom.btnStart.disabled)return;await this.updatePhase('NIGHT_START',1)},
async updatePhase(phase,round=null){const up={phase};if(round!==null)up.round=round;
 await db.ref(`games/${this.gameId}/state`).update(up);
 if(phase==='NIGHT_START')await db.ref(`games/${this.gameId}`).update({nightActions:{},wolfVotes:{},actionCompleted:{}})},
triggerAction(a){this.updatePhase(a);const e={'WOLF_ACTION':'ğŸº','WITCH_ACTION':'ğŸ§ª','SEER_ACTION':'ğŸ”®','GUARD_ACTION':'ğŸ›¡ï¸'};
 this.dom.actionFeedback.innerHTML=`<div class="action-waiting"><p style="font-size:20px;">${e[a]} ç­‰å¾…ç©å®¶è¡ŒåŠ¨ä¸­...</p><div class="loading-spinner" style="margin:20px auto;"></div></div>`;
},
renderHostPlayers(reveal){
 let html='',isDay=this.gameState.phase==='DAY';
 for(const id in this.allPlayers){
  const p=this.allPlayers[id],live=2-p.deaths,heart=`<span class="life-heart ${live<1?'lost':''}">â¤</span><span class="life-heart ${live<2?'lost':''}">â¤</span>`;
  let idStr='';if(reveal){const fmt=i=>`${ROLES[i.role].icon} ${i.isThiefCopy?'<span class="thief-copy">'+i.role+'</span>':i.role}`;idStr=` [${fmt(p.originalIdentities[0])} + ${fmt(p.originalIdentities[1])}]`;}
  html+=`<div class="player-list-item ${!p.isAlive?'dead-all':''}"><span><strong>${id}å·</strong>${idStr}${p.isExposedIdiot?' <span style="color:var(--warning)">(ç™½ç—´å·²ç¿»)</span>':''}</span>
   <div style="display:flex;align-items:center;"><span style="margin-right:20px;">${heart}</span>
   <button onclick="App.kill(${id},'VOTE')" class="action-btn" ${!p.isAlive||!isDay||p.isExposedIdiot?'disabled':''}>ğŸ—³ï¸ ç¥¨å‡º</button></div></div>`;
 }
 this.dom.hostPlayerList.innerHTML=html;
},

/* ---------- ç»“ç®—å¤œæ™š ---------- */
async processNightResults(){
 const snap=await db.ref(`games/${this.gameId}`).once('value'),g=snap.val(),na=g.nightActions||{};
 let deaths=[],msg=[];
 const double=(na.wolfKill&&na.witchPoison&&na.wolfKill===na.witchPoison)?na.wolfKill:null;
 if(double){deaths.push({id:double,lost:2});msg.push(`â˜ ï¸â˜ ï¸ ${double}å·åŒæ—¶è¢«ç‹¼åˆ€ä¸æ¯’æ€ï¼ŒæŸå¤±ä¸¤æ¡å‘½ï¼`)}
 else{
  if(na.wolfKill){
   const tgt=na.wolfKill,guarded=na.guard==tgt,cured=na.witchCure==true;
   if((guarded&&cured)||(!guarded&&!cured)){deaths.push({id:tgt,lost:1});msg.push(`â˜ ï¸ ${tgt}å·è¢«ç‹¼äººæ€å®³ã€‚`)}
   else msg.push(`ğŸ’« ${tgt}å·è¢«æ”»å‡»ä½†å­˜æ´»ã€‚`);
  }else msg.push('ğŸŒ™ ç‹¼äººæ˜¨æ™šæ²¡æœ‰è¡ŒåŠ¨ã€‚');
  if(na.witchPoison){deaths.push({id:na.witchPoison,lost:1});msg.push(`â˜ ï¸ ${na.witchPoison}å·è¢«å¥³å·«æ¯’æ€ã€‚`)}
 }
 if(!deaths.length){msg=['ğŸŒŸ æ˜¨æ™šæ˜¯å¹³å®‰å¤œã€‚'];await db.ref(`games/${this.gameId}/state/peaceNightStreak`).transaction(s=>s+1)}
 else await db.ref(`games/${this.gameId}/state/peaceNightStreak`).set(0);
 this.dom.nightResult.innerHTML=`<div style="background:rgba(255,255,255,.05);padding:20px;border-radius:15px;margin:20px 0;">
  <h3>ğŸŒ… å¤œæ™šç»“æœ</h3><div style="font-size:18px;line-height:2;">${msg.join('<br>')}</div></div>`;
 this.dom.nightResult.classList.remove('hidden');
 for(const d of deaths)await this.kill(d.id,'NIGHT',g.players,d.lost);
 const live=await this.checkVictory();if(live){const r=g.state.round;this.updatePhase('DAY',r+1)}
},

/* =================================================
   3-2 ç©å®¶ç«¯
   ================================================= */
initPlayer(){
 this.dom.pidShow.textContent=`ğŸ® ä½ æ˜¯ ${this.playerId} å·`;
 db.ref(`games/${this.gameId}`).on('value',s=>{
  if(!s.exists()){this.dom.playerStatus.textContent='æ¸¸æˆå·²ç»“æŸæˆ–ä¸å­˜åœ¨';return}
  const g=s.val();this.gameState=g.state;this.allPlayers=g.players;this.playerData=g.players[this.playerId];
  if(this.gameState.phase!=='WOLF_ACTION')this.stopWolfListeners();
  this.renderPlayer();
 });
 this.dom.btnSwap.onclick=()=>this.swapId();
 this.dom.btnConfirm.onclick=()=>this.confirmId();
},
renderPlayer(){
 this.renderIds();this.renderStatus();this.renderPList();this.renderPersist();this.renderPanel();
 this.dom.swapArea.classList[this.gameState.phase==='SETUP'&&!this.playerData.isReady?'remove':'add']('hidden');
 if(this.gameState.phase==='GAME_OVER')this.dom.gameTitle.innerHTML=`<div class="game-over-banner ${this.gameState.winner.includes('ç‹¼äºº')?'bad':''}">${this.gameState.winner}</div>`;
},
renderIds(){
 const ids=this.playerData.identities,d=this.playerData.deaths;
 const fmt=i=>`${ROLES[i.role].icon} ${i.isThiefCopy?'<span class="thief-copy">'+i.role+'</span>':i.role}`;
 this.dom.myIds.innerHTML=`<div style="display:flex;justify-content:center;align-items:center;font-size:24px;">
  ${d>=1?'<span class="dead-identity">':''}${fmt(ids[0])}${d>=1?'</span>':''}<span style="margin:0 20px;">+</span>
  ${d>=2?'<span class="dead-identity">':''}${fmt(ids[1])}${d>=2?'</span>':''}</div>`;
},
renderStatus(){
 const map={SETUP:'â³ ç­‰å¾…æ‰€æœ‰ç©å®¶å‡†å¤‡',NIGHT_START:'ğŸŒ™ å¤©é»‘è¯·é—­çœ¼...',
  WOLF_ACTION:'ğŸº ç‹¼äººè¡ŒåŠ¨',WITCH_ACTION:'ğŸ§ª å¥³å·«è¡ŒåŠ¨',SEER_ACTION:'ğŸ”® é¢„è¨€å®¶è¡ŒåŠ¨',GUARD_ACTION:'ğŸ›¡ï¸ å®ˆå«è¡ŒåŠ¨',
  KNIGHT_ACTION:'âš”ï¸ éª‘å£«è¡ŒåŠ¨',HUNTER_ACTION:'ğŸ”« çŒäººè¡ŒåŠ¨',DAY:`â˜€ï¸ ç¬¬ ${this.gameState.round} å¤© - å‘è¨€/æŠ•ç¥¨`,
  GAME_OVER:`ğŸ® æ¸¸æˆç»“æŸ - ${this.gameState.winner||''}`};
 this.dom.playerStatus.innerHTML=map[this.gameState.phase]||'æ¸¸æˆä¸­...';
},
renderPList(){
 let h='';Object.values(this.allPlayers).forEach(p=>{
  const live=2-p.deaths,heart=`<span class="life-heart ${live<1?'lost':''}">â¤</span><span class="life-heart ${live<2?'lost':''}">â¤</span>`;
  h+=`<div class="player-list-item ${!p.isAlive?'dead-all':p.deaths?'dead':''}"><span><strong>${p.id}å·ç©å®¶</strong> <small>${p.isExposedIdiot?'ğŸ¤ª å·²ç¿»ç‰Œ':p.isAlive?'âœ… å­˜æ´»':'âŒ å‡ºå±€'}</small></span><span>${heart}</span></div>`;
 });this.dom.playerList.innerHTML=h;
},
renderPersist(){
 let h='';if(this.canSeeWolf()){
  const mates=Object.values(this.allPlayers).filter(p=>p.id!=this.playerId&&p.isAlive&&['ç‹¼äºº','éšç‹¼'].includes(this.getActiveRole(p))).map(p=>`${p.id}å·`).join('ã€');
  h+=`<div style="padding:15px;background:rgba(233,69,96,.1);border-radius:12px;margin:10px 0;"><strong>ğŸº ç‹¼é˜Ÿå‹:</strong> ${mates||'æ— '}</div>`;
 }
 if(this.getActiveRole(this.playerData)==='é¢„è¨€å®¶'){
  const res=this.playerData.seerResults||{},list=Object.entries(res).map(([id,r])=>`${id}å·(${r==='ç‹¼äºº'?'ğŸº':'ğŸ˜‡'})`).join('ã€ ');
  if(list)h+=`<div style="padding:15px;background:rgba(102,126,234,.1);border-radius:12px;margin:10px 0;"><strong>ğŸ”® æŸ¥éªŒå†å²:</strong> ${list}</div>`;
 }
 if(h){this.dom.persist.innerHTML=h;this.dom.persist.classList.remove('hidden')}else this.dom.persist.classList.add('hidden');
},
/* ---------- å·¥å…· ---------- */
getActiveRole(p){if(!p.isAlive)return null;return p.identities[p.deaths].role},
canSeeWolf(){const r=this.getActiveRole(this.playerData);return r==='ç‹¼äºº'||r==='éšç‹¼'},
hasRole(role){return this.playerData.originalIdentities.some(i=>i.role===role)},
canAct(phase){return shouldAct(this.playerData,phase,this.allPlayers)},
getMinWolf(){const w=Object.values(this.allPlayers).filter(p=>p.isAlive&&['ç‹¼äºº','éšç‹¼'].includes(this.getActiveRole(p))&&!(this.getActiveRole(p)==='éšç‹¼'&&this.hasOtherWolf(p.id)));return w.length?Math.min(...w.map(x=>x.id)):null},
hasOtherWolf(ex){return Object.values(this.allPlayers).some(p=>p.isAlive&&p.id!=ex&&this.getActiveRole(p)==='ç‹¼äºº')},

/* ---------- æ“ä½œ ---------- */
swapId(){const [a,b]=this.playerData.identities;db.ref(`games/${this.gameId}/players/${this.playerId}/identities`).set([b,a])},
confirmId(){if(this.playerData.isReady)return;if(!confirm('ç¡®å®šé”å®šï¼Ÿ'))return;db.ref(`games/${this.gameId}/players/${this.playerId}/isReady`).set(true)},

/* ---------- è¡ŒåŠ¨é¢æ¿ ---------- */
renderPanel(){
 const ph=this.gameState.phase;this.dom.actionPanel.innerHTML='';
 if(!this.playerData.isAlive&&ph!=='HUNTER_ACTION')return;
 switch(ph){
  case 'DAY':if(this.getActiveRole(this.playerData)==='éª‘å£«'&&!this.playerData.isExposedIdiot)return this.renderKnight();break;
  case 'WOLF_ACTION':return this.canAct('WOLF_ACTION')?this.renderWolf():this.waitPanel(ph);
  case 'SEER_ACTION':return this.canAct('SEER_ACTION')?this.renderSeer():this.waitPanel(ph);
  case 'GUARD_ACTION':return this.canAct('GUARD_ACTION')?this.renderGuard():this.waitPanel(ph);
  case 'WITCH_ACTION':return this.canAct('WITCH_ACTION')?this.renderWitch():this.waitPanel(ph);
  case 'HUNTER_ACTION':if(this.hasRole('çŒäºº'))return this.renderHunter();break;
 }
},
waitPanel(p){this.dom.actionPanel.innerHTML=`<div class="action-feedback"><p style="font-size:18px;">â³ ç­‰å¾…å…¶ä»–ç©å®¶è¡ŒåŠ¨...</p></div>`},
/* --- 1) ç‹¼äºº --- */
renderWolf(){
 this.initWolfChat();const vote=this.allPlayers[this.playerId].wolfVote,min=this.getMinWolf(),leader=this.playerId==min;
 const btns=Object.values(this.allPlayers).filter(p=>p.isAlive).map(p=>`<button class="action-btn ${vote==p.id?'selected':''}" data-id="${p.id}">${p.id}å·</button>`).join('');
 let html=`<h3>ğŸº é€‰æ‹©å‡»æ€ç›®æ ‡</h3><div>${btns}</div>`;
 html+=leader?`<div style="margin-top:20px;"><button id="wolf-confirm" class="confirm-btn">âœ… ç¡®å®šå‡»æ€</button><p style="color:var(--warning);font-size:14px;margin-top:10px;">ä½ æ˜¯åºå·æœ€å°çš„ç‹¼äººï¼Œéœ€è´Ÿè´£æœ€ç»ˆç¡®è®¤</p></div>`:`<p style="margin-top:10px;font-size:14px;">ç­‰å¾… ${min} å·ç‹¼äººç¡®è®¤</p>`;
 this.dom.actionPanel.innerHTML=html;
 document.querySelectorAll('.action-btn').forEach(b=>b.onclick=()=>db.ref(`games/${this.gameId}/players/${this.playerId}/wolfVote`).set(b.dataset.id).then(()=>db.ref(`games/${this.gameId}/wolfVotes/${this.playerId}`).set(b.dataset.id)));
 if(leader&&this.$('wolf-confirm'))this.$('wolf-confirm').onclick=async()=>{
  const my=this.allPlayers[this.playerId].wolfVote;if(!my)return alert('å…ˆé€‰æ‹©ç›®æ ‡!');
  await db.ref(`games/${this.gameId}/nightActions/wolfKill`).set(my);
  await db.ref(`games/${this.gameId}/actionCompleted/LEADER_WOLF`).set(true);
  this.dom.actionPanel.innerHTML=`<div class="action-feedback"><p style="font-size:20px;">âœ… å·²ç¡®å®šå‡»æ€ ${my} å·</p></div>`;
 };
},
initWolfChat(){
 /* æ¯æ¬¡éƒ½ç¡®ä¿ DOM å­˜åœ¨ï¼›Firebase ç›‘å¬ä»…ç»‘å®šä¸€æ¬¡ */
 if(!this.dom.wolfChatArea.innerHTML){
  this.dom.wolfChatArea.innerHTML=`<div class="wolf-chat-box"><h3>ğŸº ç‹¼äººé¢‘é“</h3><div id="wolf-chat"></div>
   <div style="display:flex;gap:10px;"><input id="wolf-input" placeholder="è¾“å…¥æ¶ˆæ¯..." style="flex:1;"><button id="wolf-send" class="action-btn">ğŸ“¤ å‘é€</button></div>
   <div id="wolf-votes-summary"></div></div>`;this.dom.wolfChatArea.classList.remove('hidden');
 }
 if(!this.wolfChatListener){
  this.wolfChatListener=db.ref(`games/${this.gameId}/wolfChat`).orderByChild('timestamp').on('child_added',s=>this.appendWolfMsg(s.val()));
  this.wolfVotesListener=db.ref(`games/${this.gameId}/wolfVotes`).on('value',s=>this.updateWolfVotes(s.val()));
 }
 /* é‡æ–°ç»‘å®šæŒ‰é’®ï¼ˆDOM å¯èƒ½è¢«é‡ç»˜ï¼‰ */
 setTimeout(()=>{const sendBtn=this.$('wolf-send'),inp=this.$('wolf-input');
  if(sendBtn&&!sendBtn.__bind){sendBtn.__bind=true;
   sendBtn.onclick=()=>{if(!inp.value.trim())return;
    db.ref(`games/${this.gameId}/wolfChat`).push().set({senderId:this.playerId,text:inp.value.trim(),timestamp:Date.now()});
    inp.value='';};
   inp.onkeypress=e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendBtn.click();}}
  }},50);
},
appendWolfMsg(m){const box=this.$('wolf-chat');if(!box)return;box.insertAdjacentHTML('beforeend',`<div style="margin:5px 0;"><strong>${m.senderId}å·:</strong> ${m.text}</div>`);box.scrollTop=box.scrollHeight},
updateWolfVotes(v){const box=this.$('wolf-votes-summary');if(!box)return;const cnt={};Object.values(v||{}).forEach(t=>cnt[t]=(cnt[t]||0)+1);
 let h='<h4>ğŸ“Š æŠ•ç¥¨</h4>';for(const [t,c] of Object.entries(cnt))h+=`<div style="padding:6px 0;">${t}å· : <strong>${c}</strong> ç¥¨</div>`;box.innerHTML=h},
stopWolfListeners(){if(this.wolfChatListener){db.ref(`games/${this.gameId}/wolfChat`).off('child_added',this.wolfChatListener);this.wolfChatListener=null}
 if(this.wolfVotesListener){db.ref(`games/${this.gameId}/wolfVotes`).off('value',this.wolfVotesListener);this.wolfVotesListener=null}
 this.dom.wolfChatArea.classList.add('hidden')},
/* --- 2) é¢„è¨€å®¶ --- */
renderSeer(){
 const btns=Object.values(this.allPlayers).filter(p=>p.id!=this.playerId).map(p=>`<button class="action-btn" data-id="${p.id}">${p.id}å·</button>`).join('');
 this.dom.actionPanel.innerHTML=`<h3>ğŸ”® è¯·é€‰æ‹©æŸ¥éªŒç›®æ ‡</h3><div>${btns}</div>`;
 document.querySelectorAll('.action-btn').forEach(b=>b.onclick=()=>this.seerCheck(b.dataset.id));
},
async seerCheck(tgt){
 const tp=this.allPlayers[tgt],rs=tp.originalIdentities.map(i=>ROLES[i.role]),visibleBad=rs.some(r=>r.faction==='bad'&&!r.isInvisible);
 const invisBad=rs.some(r=>r.faction==='bad'&&r.isInvisible),otherWolf=Object.values(this.allPlayers).some(p=>p.id!=tgt&&p.isAlive&&p.originalIdentities.some(i=>ROLES[i.role].faction==='bad'&&!ROLES[i.role].isInvisible));
 const res=visibleBad||(!visibleBad&&invisBad&&!otherWolf)?'ç‹¼äºº':'å¥½äºº';
 await db.ref(`games/${this.gameId}/players/${this.playerId}/seerResults/${tgt}`).set(res);
 await db.ref(`games/${this.gameId}/actionCompleted/${this.playerId}_SEER_ACTION`).set(true);
 this.dom.actionPanel.innerHTML=`<div class="action-feedback"><p style="font-size:20px;">æŸ¥éªŒç»“æœï¼š${tgt}å·æ˜¯ <strong style="color:${res==='ç‹¼äºº'?'var(--danger)':'var(--success)'}">${res==='ç‹¼äºº'?'ğŸº ç‹¼äºº':'ğŸ˜‡ å¥½äºº'}</strong></p></div>`;
},
/* --- 3) å®ˆå« --- */
renderGuard(){
 const last=this.playerData.lastGuardTarget,btns=Object.values(this.allPlayers).filter(p=>p.isAlive).map(p=>`<button class="action-btn" data-id="${p.id}" ${p.id==last?'disabled':''}>${p.id}å· ${p.id==last?'(ä¸å¯è¿å®ˆ)':''}</button>`).join('');
 this.dom.actionPanel.innerHTML=`<h3>ğŸ›¡ï¸ è¯·é€‰æ‹©å®ˆæŠ¤ç›®æ ‡</h3><div>${btns}</div>`;document.querySelectorAll('.action-btn').forEach(b=>b.onclick=()=>this.guard(b.dataset.id));
},
async guard(id){if(id==this.playerData.lastGuardTarget)return;
 await db.ref(`games/${this.gameId}/nightActions/guard`).set(id);
 await db.ref(`games/${this.gameId}/players/${this.playerId}/lastGuardTarget`).set(id);
 await db.ref(`games/${this.gameId}/actionCompleted/${this.playerId}_GUARD_ACTION`).set(true);
 this.dom.actionPanel.innerHTML=`<div class="action-feedback"><p style="font-size:20px;">ğŸ›¡ï¸ å·²å®ˆæŠ¤ ${id} å·</p></div>`;
},
/* --- 4) å¥³å·« --- */
async renderWitch(){
 const canCure=!this.playerData.hasUsedCure,canPoison=!this.playerData.hasUsedPoison;
 const wolfTarget=(await db.ref(`games/${this.gameId}/nightActions/wolfKill`).once('value')).val();
 let html='<h3>ğŸ§ª å¥³å·«è¡ŒåŠ¨</h3><div style="margin-bottom:20px;font-size:18px;">è§£è¯: '+(canCure?'âœ“':'âœ—')+' | æ¯’è¯: '+(canPoison?'âœ“':'âœ—')+'</div>';
 if(canCure&&wolfTarget){
  const selfBan=this.gameState.round===1&&wolfTarget==this.playerId;
  html+=`<div style="margin-bottom:20px;"><button id="btn-cure" class="action-btn" ${selfBan?'disabled':''}>ğŸ’‰ è§£æ•‘ ${wolfTarget}å·</button>${selfBan?'<span style="font-size:12px;color:var(--danger)"> é¦–å¤œä¸å¯è‡ªæ•‘</span>':''}</div>`;
 }
 if(canPoison){
  const list=Object.values(this.allPlayers).filter(p=>p.isAlive).map(p=>`<button class="action-btn" data-id="${p.id}">â˜ ï¸ ${p.id}å·</button>`).join('');
  html+='<h4>ä½¿ç”¨æ¯’è¯</h4><div>'+list+'</div>';
 }
 html+='<div style="margin-top:20px;"><button id="btn-pass" class="control-btn">â­ï¸ è·³è¿‡</button></div>';
 this.dom.actionPanel.innerHTML=html;
 if(this.$('btn-cure'))this.$('btn-cure').onclick=()=>this.witch('cure');
 document.querySelectorAll('.action-btn[data-id]').forEach(b=>b.onclick=()=>this.witch('poison',b.dataset.id));
 this.$('btn-pass').onclick=()=>this.witch('skip');
},
async witch(type,target){
 const up={},msg='';if(type==='cure'){up[`players/${this.playerId}/hasUsedCure`]=true;up['nightActions/witchCure']=true}
 else if(type==='poison'){up[`players/${this.playerId}/hasUsedPoison`]=true;up['nightActions/witchPoison']=target}
 up[`actionCompleted/${this.playerId}_WITCH_ACTION`]=true;
 await db.ref(`games/${this.gameId}`).update(up);
 this.dom.actionPanel.innerHTML=`<div class="action-feedback"><p style="font-size:20px;">${type==='skip'?'â­ï¸ ä½ è·³è¿‡äº†æœ¬å›åˆ':type==='cure'?'ğŸ’‰ å·²ä½¿ç”¨è§£è¯':`â˜ ï¸ å·²æ¯’æ€ ${target} å·`}</p></div>`;
},
/* --- 5) éª‘å£« --- */
renderKnight(){
 const btns=Object.values(this.allPlayers).filter(p=>p.isAlive&&p.id!=this.playerId).map(p=>`<button class="action-btn" data-id="${p.id}">âš”ï¸ ${p.id}å·</button>`).join('');
 this.dom.actionPanel.innerHTML=`<h3>âš”ï¸ éª‘å£« - å†³æ–—</h3><p style="color:var(--warning);font-size:14px;">è‹¥ç›®æ ‡æ˜¯ç‹¼äººé˜µè¥åˆ™å…¶æ­»äº¡å¹¶ç«‹åˆ»è¿›å…¥å¤œæ™šï¼Œå¦åˆ™ä½ æ­»äº¡</p><div>${btns}</div>`;
 document.querySelectorAll('.action-btn').forEach(b=>b.onclick=()=>this.knight(b.dataset.id));
},
async knight(id){
 if(!confirm(`ç¡®è®¤ä¸ ${id}å· å†³æ–—?`))return;
 const tp=this.allPlayers[id],bad=tp.originalIdentities.some(i=>ROLES[i.role].faction==='bad');
 await db.ref(`games/${this.gameId}/actionCompleted/${this.playerId}_KNIGHT_ACTION`).set(true);
 if(bad){await this.kill(id,'DUEL');await this.updatePhase('NIGHT_START');}
 else await this.kill(this.playerId,'DUEL');
 this.dom.actionPanel.innerHTML=`<div class="action-feedback"><p style="font-size:20px;">âš”ï¸ å†³æ–—å®Œæˆ</p></div>`;
},
/* --- 6) çŒäºº --- */
renderHunter(){
 const btns=Object.values(this.allPlayers).filter(p=>p.id!=this.playerId).map(p=>`<button class="action-btn" data-id="${p.id}" ${!p.isAlive?'disabled':''}>${p.id}å·</button>`).join('');
 this.dom.actionPanel.innerHTML=`<h3>ğŸ”« çŒäººæŠ€èƒ½</h3><p style="color:var(--warning);font-size:14px;">é€‰æ‹©ä¸€åç©å®¶å¸¦èµ°ï¼Œæˆ–æ”¾å¼ƒ</p><div>${btns}</div><div style="margin-top:20px;"><button id="hunter-skip" class="control-btn">ğŸš« æ”¾å¼ƒ</button></div>`;
 document.querySelectorAll('.action-btn[data-id]').forEach(b=>b.onclick=()=>this.hunter(b.dataset.id));
 this.$('hunter-skip').onclick=()=>this.hunter(null);
},
async hunter(id){
 if(id&& !confirm(`ç¡®å®šå¸¦èµ° ${id}å·?`))return;
 await db.ref(`games/${this.gameId}/actionCompleted/${this.playerId}_HUNTER_ACTION`).set(true);
 if(id)await this.kill(id,'SHOT');
 await this.updatePhase('DAY');
 this.dom.actionPanel.innerHTML=`<div class="action-feedback"><p style="font-size:20px;">ğŸ”« çŒäººè¡ŒåŠ¨ç»“æŸ</p></div>`;
},
/* =================================================
   å‡»æ€ & èƒœè´Ÿ
   ================================================= */
async kill(pid,cause,ps=null,lost=1){
 const players=ps|| (await db.ref(`games/${this.gameId}/players`).once('value')).val(),p=players[pid];if(!p||!p.isAlive)return;
 if(this.getActiveRole(p)==='ç™½ç—´'&&cause==='VOTE'){await db.ref(`games/${this.gameId}/players/${pid}/isExposedIdiot`).set(true);await this.checkVictory();return}
 const nd=Math.min(p.deaths+lost,2),dead=nd>=2,up={};up[`players/${pid}/deaths`]=nd;up[`players/${pid}/isAlive`]=!dead;
 await db.ref(`games/${this.gameId}`).update(up);
 if(dead&&this.hasRole.call({playerData:p},'çŒäºº')&&cause!=='POISON')await this.updatePhase('HUNTER_ACTION');
 else await this.checkVictory();
},
async checkVictory(){
 const g=(await db.ref(`games/${this.gameId}`).once('value')).val();if(g.state.phase==='GAME_OVER')return false;
 let wolves=0,gods=0,gold=0;
 Object.values(g.players).forEach(p=>{
  if(!p.isAlive)return;
  const rs=p.originalIdentities.map(i=>ROLES[i.role]),golden=rs[0].name==='å¹³æ°‘'&&rs[1].name==='å¹³æ°‘';
  const goodOnly=rs.every(r=>r.faction==='good');
  if(golden)gold++;if(goodOnly&&!golden&&rs.some(r=>r.isGod))gods++;if(rs.some(r=>r.faction==='bad'))wolves++;
 });
 let win=null;if(wolves===0)win='ğŸ˜‡ å¥½äººèƒœåˆ© (ç‹¼äººå…¨ç­)';
 else if(g.state.peaceNightStreak>=3)win='ğŸ˜‡ å¥½äººèƒœåˆ© (ä¸‰å¤œå¹³å®‰)';
 else if(gods===0)win='ğŸº ç‹¼äººèƒœåˆ© (ç¥èŒå…¨ç­)';
 else if(gold===0)win='ğŸº ç‹¼äººèƒœåˆ© (é‡‘å®å®å…¨ç­)';
 if(win){await db.ref(`games/${this.gameId}/state`).update({phase:'GAME_OVER',winner:win});return false}
 return true;
}
};

/* ========== å¯åŠ¨ ========== */
document.addEventListener('DOMContentLoaded',()=>App.init());
</script>
</body>
</html>
